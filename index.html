<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Yönetimi</title>
  <link rel="stylesheet" href="/form.css"/>
  <style>
    main{max-width:980px;margin:40px auto;padding:0 16px}
    input,textarea{width:100%;padding:10px;border:1px solid #ccd;border-radius:8px;font:inherit}
    textarea{min-height:180px}
    .row{margin:12px 0}
    .flex{display:flex;gap:12px;align-items:center}
    .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.primary{background:#0ea5e9;color:#fff}
    .btn.danger{background:#ef4444;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:14px}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
<main>
  <h1>Form Yönetimi</h1>

  <section id="editor">
    <div class="row"><label>Admin Token <input id="adm" placeholder="ilker-super-secret24198823Gds!!?*"/></label></div>
    <div class="row"><label>Slug <input id="slug" placeholder="örn: formayvalik"/></label></div>
    <div class="row"><label>Başlık <input id="title" placeholder="Form başlığı"/></label></div>
    <div class="row"><label>Açıklama <input id="desc" placeholder="Kısa açıklama"/></label></div>
    <div class="row">
      <label>Fields JSON
        <textarea id="fields">[
  {"type":"text","name":"ad","label":"Ad","required":true},
  {"type":"email","name":"email","label":"E-posta","required":true},
  {"type":"textarea","name":"mesaj","label":"Mesaj"}
]</textarea>
      </label>
      <div class="muted">Şema: <code>[{ type, name, label, required? }]</code></div>
    </div>
    <div class="row flex">
      <button class="btn primary" id="save">Kaydet/Güncelle</button>
      <button class="btn danger" id="del">Sil</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <section>
    <h2>Mevcut formlar</h2>
    <div class="row"><input id="filter" placeholder="Ara (slug/title)"/></div>
    <div id="listWrap">
      <table>
        <thead><tr><th>Slug</th><th>Başlık</th><th>Durum</th><th>Aksiyon</th></tr></thead>
        <tbody id="list"><tr><td colspan="4">Yükleniyor…</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const API_FORMS = '/api/forms';                      // list/tek form
  const API_ADMIN = '/.netlify/functions/forms-admin'; // upsert/sil

  const el = {
    adm:   $('#adm'),
    slug:  $('#slug'),
    title: $('#title'),
    desc:  $('#desc'),
    fields:$('#fields'),
    msg:   $('#msg'),
    list:  $('#list'),
    filter:$('#filter')
  };

  function setMsg(t){ el.msg.textContent = t || ''; }

  async function loadList(){
    setMsg('Liste yükleniyor…');
    const r = await fetch(API_FORMS);
    const j = await r.json().catch(()=>({}));
    setMsg('');
    if (!j.ok) { el.list.innerHTML = `<tr><td colspan="4">Liste alınamadı</td></tr>`; return; }
    renderList(j.forms || []);
  }

  function renderList(rows){
    const q = (el.filter.value||'').toLowerCase();
    const data = rows.filter(x => (x.slug+' '+(x.title||'')).toLowerCase().includes(q));
    el.list.innerHTML = data.map(x => `
      <tr>
        <td>${x.slug}</td>
        <td>${x.title||''}</td>
        <td>${x.active===false?'pasif':'aktif'}</td>
        <td>
          <a href="/form.html?slug=${encodeURIComponent(x.slug)}" target="_blank">Doldur</a> ·
          <a href="/results.html?slug=${encodeURIComponent(x.slug)}" target="_blank">Sonuç</a> ·
          <a href="/share/${encodeURIComponent(x.slug)}" target="_blank">Paylaş</a> ·
          <a href="#" data-edit="${x.slug}">Düzenle</a> ·
          <a href="#" data-del="${x.slug}">Sil</a>
        </td>
      </tr>`).join('') || `<tr><td colspan="4">Kayıt yok</td></tr>`;

    // olaylar
    el.list.querySelectorAll('a[data-edit]').forEach(a=>{
      a.onclick = async (e)=>{
        e.preventDefault();
        const slug = a.getAttribute('data-edit');
        const r = await fetch(`${API_FORMS}?slug=${encodeURIComponent(slug)}`);
        const j = await r.json().catch(()=>({}));
        if (!j.ok || !j.schema) { alert('Şema alınamadı'); return; }
        el.slug.value  = j.schema.slug;
        el.title.value = j.schema.title || '';
        el.desc.value  = j.schema.description || '';
        el.fields.value= JSON.stringify(j.schema.fields || [], null, 2);
        window.scrollTo({ top:0, behavior:'smooth' });
      };
    });
    el.list.querySelectorAll('a[data-del]').forEach(a=>{
      a.onclick = async (e)=>{
        e.preventDefault();
        const slug = a.getAttribute('data-del');
        if (!confirm(`${slug} silinsin mi?`)) return;
        setMsg('Siliniyor…');
        const r = await fetch(`${API_ADMIN}?slug=${encodeURIComponent(slug)}`,{
          method:'DELETE', headers:{ 'ilker-super-secret24198823Gds!!?*': el.adm.value }
        });
        const j = await r.json().catch(()=>({}));
        setMsg(j.message || r.status);
        loadList();
      };
    });
  }

  el.filter.addEventListener('input', ()=> loadList());

  $('#save').onclick = async ()=>{
    const token = el.adm.value.trim();
    const slug  = el.slug.value.trim();
    if (!token || !slug) { alert('Token ve slug zorunlu'); return; }

    let fields = [];
    try { fields = JSON.parse(el.fields.value||'[]'); }
    catch(e){ alert('Fields JSON hatalı'); return; }

    const body = {
      slug,
      title: el.title.value.trim(),
      description: el.desc.value.trim(),
      fields
    };
    setMsg('Kaydediliyor…');
    const r = await fetch(API_ADMIN, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'ilker-super-secret24198823Gds!!?*': token },
      body: JSON.stringify(body)
    });
    const j = await r.json().catch(()=>({}));
    setMsg(j.message || r.status);
    loadList();
  };

  $('#del').onclick = async ()=>{
    const token = el.adm.value.trim();
    const slug  = el.slug.value.trim();
    if (!token || !slug) { alert('Token ve slug zorunlu'); return; }
    if (!confirm(`${slug} silinsin mi?`)) return;
    setMsg('Siliniyor…');
    const r = await fetch(`${API_ADMIN}?slug=${encodeURIComponent(slug)}`, {
      method:'DELETE', headers:{ 'ilker-super-secret24198823Gds!!?*': token }
    });
    const j = await r.json().catch(()=>({}));
    setMsg(j.message || r.status);
    loadList();
  };

  loadList();
})();
</script>
</body>
</html>
