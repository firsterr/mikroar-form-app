<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MikroAR ‚Äì Anket Admin (D√ºzenleme Modu)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#111}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0;background:#fff}
    input[type=text], select, textarea{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;min-width:240px}
    textarea{min-width:420px;min-height:72px}
    button{padding:8px 12px;border:1px solid #334155;background:#0ea5e9;color:#fff;border-radius:8px;cursor:pointer}
    button.secondary{background:#fff;color:#111;border-color:#cbd5e1}
    button.danger{background:#ef4444;border-color:#ef4444}
    .q-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .q-type{min-width:180px}
    .choices{margin-top:8px;margin-left:8px;border-left:3px solid #e5e7eb;padding-left:10px}
    .muted{color:#6b7280;font-size:13px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  </style>
</head>
<body>

  <h2>üõ†Ô∏è Anket Olu≈ütur / D√ºzenle</h2>

  <div class="card">
    <div class="row">
      <div>
        <div class="muted">Slug</div>
        <input id="slug" type="text" placeholder="√∂rn: formayvalik" />
      </div>
      <div>
        <div class="muted">Ba≈ülƒ±k</div>
        <input id="title" type="text" placeholder="Anket ba≈ülƒ±ƒüƒ±" />
      </div>
      <div>
        <div class="muted">Durum</div>
        <select id="active">
          <option value="true">Aktif</option>
          <option value="false">Pasif</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button class="secondary" id="btnLoad">Y√ºkle</button>
      <button class="secondary" id="btnNew">Yeni (sƒ±fƒ±r)</button>
      <span class="muted">‚ÄúY√ºkle‚Äù mevcut formu getirir; sonra d√ºzenleyip ‚ÄúKaydet‚Äù dersen √ºzerine yazar.</span>
    </div>
  </div>

  <div class="q-head">
    <h3>Sorular</h3>
    <div class="row">
      <button class="secondary" id="btnAddQ">Soru Ekle</button>
      <button id="btnSave">Kaydet</button>
    </div>
  </div>

  <div id="qList"></div>

  <script>
    // --- Yardƒ±mcƒ±lar ---
    const el = sel => document.querySelector(sel);
    const ce = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };

    const QUESTION_TYPES = [
      { value: "short_text", label: "Kƒ±sa Metin" },
      { value: "long_text",  label: "Uzun Metin" },
      { value: "single_choice", label: "Tekli Se√ßim" },
      { value: "multi_choice",  label: "√áoklu Se√ßim" }
    ];

    function emptyForm() {
      return {
        slug: "",
        title: "",
        active: true,
        schema: { questions: [] }
      };
    }

    function normalizeIncoming(data){
      // /api/forms/:slug ‚Üí { ok:true, form:{slug,title,active,schema} }
      // schema yoksa/yanlƒ±≈üsa toparla
      const form = data?.form ?? data ?? {};
      const schema = form.schema ?? {};
      let questions = schema.questions ?? form.questions ?? [];
      // Eski d√ºz metin dizisi geldiyse metne √ßevir
      questions = questions.map(q => {
        if (typeof q === 'string') {
          return { type: 'short_text', text: q, options: [] };
        }
        // {text, type, options} bekliyoruz
        return {
          type: q.type || 'short_text',
          text: q.text || '',
          options: Array.isArray(q.options) ? q.options : []
        };
      });
      return {
        slug: form.slug || "",
        title: form.title || "",
        active: form.active !== false,
        schema: { questions }
      };
    }

    function renderQuestions(list){
      const host = el('#qList');
      host.innerHTML = '';
      list.forEach((q, idx) => {
        host.appendChild(renderQuestion(q, idx));
      });
    }

    function renderQuestion(q, idx){
      const card = ce('div','card');

      // √úst satƒ±r: metin + tip + butonlar
      const row = ce('div','row');

      const qText = ce('input');
      qText.type = 'text';
      qText.placeholder = `Soru #${idx+1}`;
      qText.value = q.text || '';
      qText.style.flex = '1';
      qText.addEventListener('input', e => q.text = e.target.value);

      const qType = ce('select','q-type');
      QUESTION_TYPES.forEach(t => {
        const opt = ce('option');
        opt.value = t.value;
        opt.textContent = t.label;
        if (q.type === t.value) opt.selected = true;
        qType.appendChild(opt);
      });
      qType.addEventListener('change', e => {
        q.type = e.target.value;
        // tip deƒüi≈üince se√ßenek alanƒ±nƒ± yeniden kuralƒ±m
        refreshChoices();
      });

      const btnDel = ce('button','danger');
      btnDel.textContent = 'Sil';
      btnDel.onclick = () => {
        const form = collectForm();
        form.schema.questions.splice(idx,1);
        renderQuestions(form.schema.questions);
      };

      row.append(qText, qType, btnDel);
      card.appendChild(row);

      // Se√ßenekler alanƒ± (tekli/√ßoklu i√ßin g√∂r√ºn√ºr)
      const choicesWrap = ce('div','choices');
      function refreshChoices(){
        choicesWrap.innerHTML = '';
        if (q.type === 'single_choice' || q.type === 'multi_choice') {
          const list = Array.isArray(q.options) ? q.options : (q.options = []);
          const grid = ce('div','grid');

          list.forEach((opt, i) => {
            const wrap = ce('div','row');
            const inp = ce('input');
            inp.type = 'text';
            inp.placeholder = `Se√ßenek #${i+1}`;
            inp.value = opt;
            inp.style.minWidth = '260px';
            inp.oninput = e => list[i] = e.target.value;

            const rm = ce('button','secondary');
            rm.textContent = 'Kaldƒ±r';
            rm.onclick = () => {
              list.splice(i,1);
              refreshChoices();
            };

            wrap.append(inp, rm);
            grid.appendChild(wrap);
          });

          const addBtn = ce('button','secondary');
          addBtn.textContent = 'Se√ßenek Ekle';
          addBtn.onclick = () => { list.push(''); refreshChoices(); };

          choicesWrap.appendChild(grid);
          choicesWrap.appendChild(ce('div','muted')).textContent =
            'Not: √áoklu se√ßimde kullanƒ±cƒ± birden fazla i≈üaretleyebilir.';
          choicesWrap.appendChild(addBtn);
        } else {
          choicesWrap.appendChild(ce('div','muted')).textContent = 'Bu soru tipi se√ßenek gerektirmez.';
        }
      }
      refreshChoices();
      card.appendChild(choicesWrap);

      return card;
    }

    function collectForm(){
      const slug = el('#slug').value.trim();
      const title = el('#title').value.trim();
      const active = el('#active').value === 'true';
      // ekranda duranƒ± oku
      // (#qList i√ßindeki kartlardan model √ºretmek yerine memory‚Äôde tuttuƒüumuz
      // formu g√ºncellemek daha saƒülam, biz memory kullanacaƒüƒ±z.)
      return CURRENT_FORM;
    }

    // Memory‚Äôde formu tutalƒ±m ki input event‚Äôleri direkt ona yazsƒ±n
    let CURRENT_FORM = emptyForm();

    function syncHeaderToForm(){
      el('#slug').value  = CURRENT_FORM.slug || '';
      el('#title').value = CURRENT_FORM.title || '';
      el('#active').value= CURRENT_FORM.active ? 'true' : 'false';
    }
    function syncFormHeaderFromInputs(){
      CURRENT_FORM.slug   = el('#slug').value.trim();
      CURRENT_FORM.title  = el('#title').value.trim();
      CURRENT_FORM.active = (el('#active').value === 'true');
    }

    // --- Olay baƒüla ---
    el('#btnNew').onclick = () => {
      CURRENT_FORM = emptyForm();
      syncHeaderToForm();
      renderQuestions(CURRENT_FORM.schema.questions);
    };

    el('#btnAddQ').onclick = () => {
      CURRENT_FORM.schema.questions.push({ type:'short_text', text:'', options:[] });
      renderQuestions(CURRENT_FORM.schema.questions);
    };

    el('#btnLoad').onclick = async () => {
      const slug = el('#slug').value.trim();
      if (!slug) return alert('√ñnce slug gir');
      try{
        const r = await fetch(`/api/forms/${encodeURIComponent(slug)}`);
        if(!r.ok){
          const t = await r.text();
          return alert('Form bulunamadƒ±:\n' + t);
        }
        const json = await r.json();
        CURRENT_FORM = normalizeIncoming(json);
        // slug alanƒ±nƒ± bo≈ü d√∂nerse elimizdeki deƒüeri koru
        if(!CURRENT_FORM.slug) CURRENT_FORM.slug = slug;
        syncHeaderToForm();
        renderQuestions(CURRENT_FORM.schema.questions);
      }catch(e){
        alert('Y√ºkleme hatasƒ±: ' + e.message);
      }
    };

    el('#title').addEventListener('input', e => { CURRENT_FORM.title = e.target.value; });
    el('#active').addEventListener('change', e => { CURRENT_FORM.active = (e.target.value === 'true'); });

    el('#btnSave').onclick = async () => {
      syncFormHeaderFromInputs();
      const ok = CURRENT_FORM.slug && CURRENT_FORM.title && CURRENT_FORM.schema.questions.length > 0;
      if(!ok) return alert('Slug, ba≈ülƒ±k ve en az 1 soru gerekli.');

      try{
        // Backend upsert: /admin/api/forms  (Basic Auth √ßƒ±kar)
        const res = await fetch('/admin/api/forms', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            slug: CURRENT_FORM.slug,
            title: CURRENT_FORM.title,
            active: CURRENT_FORM.active,
            schema: { questions: CURRENT_FORM.schema.questions }
          })
        });
        if(!res.ok){
          const t = await res.text();
          return alert('Kaydetme hatasƒ±:\n' + t);
        }
        alert('Form kaydedildi/g√ºncellendi ‚úÖ');
      }catch(e){
        alert('Hata: ' + e.message);
      }
    };

    // ƒ∞lk a√ßƒ±lƒ±≈üta bo≈ü form
    CURRENT_FORM = emptyForm();
    syncHeaderToForm();
    renderQuestions(CURRENT_FORM.schema.questions);
  </script>
</body>
</html>
