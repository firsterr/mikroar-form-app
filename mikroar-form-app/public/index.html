<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form seçin • MikroAR</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0e1116; --card:#131824; --muted:#9aa3b2; --fg:#e8edf3; --primary:#2f7df6;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:960px;margin:48px auto;padding:0 20px}
    h1{font-weight:800;letter-spacing:.3px;font-size:clamp(28px,4vw,40px);margin:0 0 8px}
    p.lead{color:var(--muted);margin:0 0 28px}
    .card{background:var(--card);border:1px solid #1f2633;border-radius:14px;padding:20px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    select,button,.copy{height:48px;border-radius:10px;border:1px solid #273246;background:#0f141f;color:var(--fg)}
    select{flex:1;min-width:260px;padding:0 12px}
    button{padding:0 18px;background:var(--primary);border:none;font-weight:700;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .copy{padding:0 18px;display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:14px;margin-top:10px}
    .error{color:#ff8b8b}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Form seçin</h1>
    <p class="lead">Aktif formlar listelenir. Bir form seçince
      <code>/form.html?slug=…</code> ile anket sayfasına gidilir.</p>

    <div class="card">
      <div class="row">
        <select id="sel">
          <option value="">— Yükleniyor… —</option>
        </select>
        <button id="open" disabled>Formu aç</button>
        <button id="copy" class="copy" disabled>Bağlantıyı kopyala</button>
      </div>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <script>
    (async function init(){
      const sel  = document.getElementById('sel');
      const open = document.getElementById('open');
      const copy = document.getElementById('copy');
      const msg  = document.getElementById('msg');

      function setLoading() {
        sel.innerHTML = '<option value="">— Yükleniyor… —</option>';
        sel.disabled = true; open.disabled = true; copy.disabled = true;
        msg.textContent = '';
      }

      function populate(rows) {
        sel.innerHTML = '';
        if (!rows || rows.length === 0) {
          sel.innerHTML = '<option value="">(Aktif form yok)</option>';
          sel.disabled = true; open.disabled = true; copy.disabled = true;
          msg.textContent = 'Admin üzerinden bir formı “Aktif” yapın.';
          return;
        }
        sel.disabled = false;
        for (const r of rows) {
          const opt = document.createElement('option');
          opt.value = r.slug;
          opt.textContent = r.title ? `${r.title}  •  ${r.slug}` : r.slug;
          sel.appendChild(opt);
        }
        open.disabled = false; copy.disabled = false;
        msg.textContent = 'Bir form seçip “Formu aç” ile devam edin.';
      }

      async function loadForms(){
        setLoading();
        try {
          const res = await fetch('/api/forms', { cache: 'no-store' });
          if (!res.ok) throw new Error('Sunucu '+res.status+' döndürdü');
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || 'Bilinmeyen hata');
          populate(data.rows);
        } catch (e) {
          sel.innerHTML = '<option value="">(Yüklenemedi)</option>';
          sel.disabled = true; open.disabled = true; copy.disabled = true;
          msg.innerHTML = `<span class="error">Yüklenemedi:</span> ${e.message}`;
        }
      }

      open.addEventListener('click', () => {
        const slug = sel.value;
        if (!slug) return;
        location.href = `/form.html?slug=${encodeURIComponent(slug)}`;
      });

      copy.addEventListener('click', async () => {
        const slug = sel.value;
        if (!slug) return;
        const url = `${location.origin}/form.html?slug=${encodeURIComponent(slug)}`;
        try {
          await navigator.clipboard.writeText(url);
          msg.textContent = 'Bağlantı panoya kopyalandı.';
        } catch {
          msg.textContent = url;
        }
      });

      await loadForms();
    })();
  </script>
</body>
</html>
