<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Anket</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; }
    h1 { text-align: center; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 5px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    .question { margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
</style>
</head>
<body>

<h1 id="form-title">Yükleniyor...</h1>

<form id="surveyForm">
    <div id="questions"></div>
    <button type="submit">Gönder</button>
</form>

<script>
async function loadForm() {
    const slug = new URLSearchParams(window.location.search).get("form") || "anket-2025";
    const res = await fetch(`/api/forms/${slug}`);
    const data = await res.json();

    if (!data.ok) {
        document.body.innerHTML = "<h2>Form bulunamadı.</h2>";
        return;
    }

    document.getElementById("form-title").innerText = data.form.title;

    const qContainer = document.getElementById("questions");
    qContainer.innerHTML = "";

    data.form.schema.forEach((q, idx) => {
        const qDiv = document.createElement("div");
        qDiv.className = "question";
        qDiv.innerHTML = `<label>${idx+1}. ${q.text}</label>`;

        if (q.type === "text") {
            qDiv.innerHTML += `<input type="text" name="q${idx}">`;
        } 
        else if (q.type === "radio") {
            q.options.forEach(opt => {
                qDiv.innerHTML += `
                    <label><input type="radio" name="q${idx}" value="${opt}"> ${opt}</label>
                `;
            });
        } 
        else if (q.type === "checkbox") {
            q.options.forEach(opt => {
                qDiv.innerHTML += `
                    <label><input type="checkbox" name="q${idx}" value="${opt}"> ${opt}</label>
                `;
            });
        }

        qContainer.appendChild(qDiv);
    });

    document.getElementById("surveyForm").onsubmit = async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const answers = {};

        data.form.schema.forEach((q, idx) => {
            if (q.type === "checkbox") {
                answers[`q${idx}`] = formData.getAll(`q${idx}`);
            } else {
                answers[`q${idx}`] = formData.get(`q${idx}`);
            }
        });

        const sendRes = await fetch(`/submit/${slug}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(answers)
        });

        const sendData = await sendRes.json();
        if (sendData.ok) {
            alert("Cevaplarınız kaydedildi. Teşekkürler!");
            window.location.href = "/thanks.html";
        } else {
            alert("Bir hata oluştu, lütfen tekrar deneyin.");
        }
    };
}

loadForm();
</script>

</body>
</html>
