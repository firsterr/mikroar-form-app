<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Anket Seçimi</title>
<style>
  :root{color-scheme:light dark}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:800px;margin:0 auto;padding:28px}
  h1{margin:10px 0 18px;font-size:28px}
  .card{background:#0f172a;border:1px solid #1f2a44;border-radius:14px;padding:18px}
  .muted{color:#9ca3af;font-size:14px}
  .btn{display:block;width:100%;text-align:left;background:#0b1220;border:1px solid #1f2a44;border-radius:12px;color:#e5e7eb;padding:12px 14px;margin:8px 0;cursor:pointer}
  .btn:hover{background:#0f172a}
  .row{display:flex;gap:8px;margin-top:10px}
  .input{flex:1;background:#0b1220;border:1px solid #1f2a44;border-radius:10px;color:#e5e7eb;padding:10px 12px;outline:none}
  .primary{background:#2563eb;border:0;border-radius:10px;color:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
  .primary:hover{filter:brightness(1.05)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Anket Seçimi</h1>
    <div class="card">
      <p class="muted">Aktif anketlerden birini seçin; seçtiğiniz anket <code>form.html?form=&lt;slug&gt;</code> ile açılacak.</p>
      <div id="list" style="margin-top:10px;">Yükleniyor…</div>
      <div class="row">
        <input id="manual" class="input" placeholder="Slug yaz (örn. formbursa)" />
        <button id="go" class="primary">Aç</button>
      </div>
      <p class="muted" style="margin-top:8px">Listede bulamazsan yukarıya slug yazıp “Aç”a bas.</p>
    </div>
  </div>

<script>
(async function () {
  const listEl = document.getElementById('list');
  const manual = document.getElementById('manual');
  const goBtn  = document.getElementById('go');

  // Public liste endpoint’i: /api/forms  → [{slug, title}, ...]
  async function fetchForms() {
    try {
      const r = await fetch('/api/forms', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return await r.json(); // dizi bekliyoruz
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  function renderList(rows) {
    listEl.innerHTML = '';
    if (!Array.isArray(rows) || rows.length === 0) {
      listEl.innerHTML = '<div class="muted">Aktif anket bulunamadı.</div>';
      return;
    }
    rows.forEach(f => {
      const a = document.createElement('a');
      a.className = 'btn';
      a.href = '/form.html?form=' + encodeURIComponent(f.slug); // DİKKAT: senin form.js "form" parametresini bekliyor
      a.textContent = f.title ? `${f.title} (${f.slug})` : f.slug;
      listEl.appendChild(a);
    });
  }

  const rows = await fetchForms();
  if (rows === null) {
    // endpoint yoksa/çöktüyse boş görsel + fallback
    listEl.innerHTML = '<div class="muted">Liste alınamadı. Slug yazarak devam edebilirsiniz.</div>';
  } else {
    renderList(rows);
  }

  goBtn.onclick = () => {
    const s = (manual.value || '').trim();
    if (s) location.href = '/form.html?form=' + encodeURIComponent(s);
  };
})();
</script>
</body>
</html>
