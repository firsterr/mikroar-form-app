<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  /* —— Google Forms tadında sade kartlı tema —— */

  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --primary-600:#1d4ed8;
    --danger:#b91c1c;
    --warn:#b45309;
    --shadow: 0 10px 20px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.06);
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  .wrap{max-width:860px;margin:48px auto;padding:0 20px}

  /* Başlık & açıklama küçük kart görünümü */
  #title, #desc, #alert{display:block}
  #title{
    font-size:34px;margin:0 0 6px;font-weight:800;letter-spacing:-.01em
  }
  #desc{color:var(--muted);margin:0 0 14px}
  .note{margin:14px 0;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;box-shadow:var(--shadow)}
  .note.err{background:#fef2f2;border-color:#fecaca;color:var(--danger)}
  .note.warn{background:#fff7ed;border-color:#fed7aa;color:var(--warn)}
  .note.ok{background:#ecfdf5;border-color:#bbf7d0;color:#047857}

  /* Soru kartları */
  #form{margin-top:18px;display:flex;flex-direction:column;gap:16px}
  .row{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px 18px 16px;
    box-shadow:var(--shadow);
  }
  .row > label{
    display:block;
    font-weight:700;
    margin:0 0 10px;
    letter-spacing:.2px;
  }

  /* Metin / e-posta / select / textarea */
  input[type=text],
  input[type=email],
  select,
  textarea{
    width:100%;
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    font:inherit;
    outline:none;
    transition:border-color .15s, box-shadow .15s;
  }
  textarea{min-height:120px;resize:vertical}
  input[type=text]:focus,
  input[type=email]:focus,
  select:focus,
  textarea:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(37,99,235,.12);
  }
  select:invalid{color:var(--muted)}
  select option[value=""]{color:var(--muted)}

  /* Radio/checkbox satırları */
  .row > div > div{display:flex;align-items:center;gap:10px;margin:8px 0}
  input[type=radio], input[type=checkbox]{width:18px;height:18px}

  /* Gönder butonu */
  button[type=submit]{
    appearance:none;border:0;background:var(--primary);color:#fff;
    font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;
    margin-top:4px;box-shadow:var(--shadow)
  }
  button[type=submit]:hover{background:var(--primary-600)}
  button[disabled]{opacity:.6;cursor:not-allowed}

  /* Slug seçme ekranı (form.html slug yokken) */
  .selector{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    box-shadow:var(--shadow);
    margin-top:18px;
  }
  .selector h2{margin:0 0 12px}
  .selector .bar{display:flex;gap:10px}
  .selector select{flex:1}

  @media (max-width:640px){
    .wrap{padding:0 14px}
    #title{font-size:28px}
  }
</style>
</head>
<body>
<main class="wrap">
  <h1 id="title" style="display:none"></h1>
  <p id="desc" class="muted" style="display:none"></p>
  <p id="alert" class="note err" style="display:none"></p>

  <!-- SLUG YOKKEN LISTE -->
  <section id="pickWrap" style="display:none">
    <p id="listWarn" class="note warn" style="display:none">Listelenecek form bulunamadı.</p>
    <div class="inline">
      <label for="pickSelect" style="margin:0;min-width:140px">Bir anket seçin</label>
      <select id="pickSelect" class="inline-input">
        <option value="">— Form (slug) seçin —</option>
      </select>
      <button id="pickBtn" type="button" class="primary">Formu Aç</button>
    </div>
  </section>

  <!-- SLUG VARSA FORM -->
  <form id="form" class="gform" method="POST" action="#" style="display:none"></form>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const alertEl = document.querySelector('#alert');
  const formEl  = document.querySelector('#form');
  const slug = new URLSearchParams(location.search).get('slug') || location.pathname.replace(/^\/+|\/+$/g,'');
  const API = '/api';

  function showErr(msg){ alertEl.textContent = msg; alertEl.className='note err'; alertEl.style.display='block'; }
  function showWarn(msg){ alertEl.textContent = msg; alertEl.className='note warn'; alertEl.style.display='block'; }
  function hideNote(){ alertEl.style.display='none'; }

  // …(sayfadaki diğer kodlar aynen kalsın)…

  // ▼▼▼ SADECE BU BLOĞU GÜNCELLİYORUZ ▼▼▼
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    // Cevapları topla (mevcut mantık)
    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/\[\]$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });

      let j = null;
      try { j = await r.json(); } catch { /* düz metin dönerse yoksay */ }

      // 409 (duplicate) durumunu uyarı olarak göster
      const isDuplicate =
        r.status === 409 ||
        j?.code === 'duplicate' ||
        j?.data?.code === 'duplicate' ||
        /duplicate|already/i.test(j?.error || '');

      if (isDuplicate) {
        showWarn('Bu anketi daha önce göndermişsiniz. Aynı IP/cihaz için tekrar yanıt kabul edilmiyor.');
        return; // hata gibi davranma
      }

      if (r.ok && j?.ok){
        alertEl.className = 'note ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        showErr(j?.data?.message || j?.error || `Hata: ${r.status}`);
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
  // ▲▲▲ GÜNCEL BLOK BİTİŞ ▲▲▲

})();
</script>
</body>
</html>
