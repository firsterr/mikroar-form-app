<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const formEl  = $("#form");
  const titleEl = $("#title");
  const descEl  = $("#desc");
  const alertEl = $("#alert");
  const API = "/.netlify/functions"; // redirect'e takılmasın

  // Slug: ?slug=… varsa onu; yoksa /formayvalik gibi path'i kullan
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    titleEl.textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // JS kapalı senaryosu için fallback
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı çek
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`, { cache: "no-store" })
    .then((r) => r.json())
    .then((j) => {
      if (!j.ok || !j.schema) throw new Error(j.error || "Şema alınamadı");
      const schema = j.schema;

      titleEl.textContent = schema.title || `Form: ${slug}`;
      if (schema.description) {
        descEl.textContent = schema.description;
        descEl.style.display = "block";
      }

      // Alanları çiz
      formEl.innerHTML = "";
      (schema.fields || []).forEach((f) => {
        const row = document.createElement("div");
        row.className = "row";
        const id = `fld_${f.name}`;
        const req = f.required ? "required" : "";

        row.innerHTML = `
          <label for="${id}">${f.label || f.name}${f.required ? " *" : ""}</label>
          ${f.type === "textarea"
            ? `<textarea id="${id}" name="${f.name}" ${req}></textarea>`
            : `<input id="${id}" type="${f.type || "text"}" name="${f.name}" ${req} />`
          }`;
        formEl.appendChild(row);
      });

      const btn = document.createElement("button");
      btn.type = "submit";
      btn.textContent = "Gönder";
      formEl.appendChild(btn);
    })
    .catch((e) => {
      titleEl.textContent = "Form yüklenemedi.";
      alertEl.className = "err";
      alertEl.textContent = e.message;
      alertEl.style.display = "block";
    });

 // Submit
formEl.addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = formEl.querySelector('button[type="submit"]');
  btn.disabled = true;
  alertEl.style.display = "none";

  const answers = Object.fromEntries(new FormData(formEl).entries());

  try {
    const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ answers })
    });
    const j = await res.json().catch(() => ({}));

    // Tekrarlı gönderim (unique constraint) — kullanıcı dostu mesaj
    if (res.status === 409 || j.already) {
      const when = j.at ? ` (${new Date(j.at).toLocaleString()})` : "";
      alertEl.className = "err";
      alertEl.textContent = "Bu formu bu IP ile zaten göndermişsiniz." + when;
      alertEl.style.display = "block";
      return;
    }

    if (res.ok && j.ok) {
      alertEl.className = "ok";
      alertEl.textContent = "Gönderildi, teşekkürler!";
      alertEl.style.display = "block";
      formEl.reset();
    } else {
      alertEl.className = "err";
      alertEl.textContent = j?.data?.message || j?.error || `Hata: ${res.status}`;
      alertEl.style.display = "block";
    }
  } catch (err) {
    alertEl.className = "err";
    alertEl.textContent = "Bağlantı hatası: " + err.message;
    alertEl.style.display = "block";
  } finally {
    btn.disabled = false;
  }
});
})();
</script>
</body>
</html>
