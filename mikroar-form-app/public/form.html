<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Anket</title>
</head>
<body>
<div id="form"></div>
<script>
(async ()=>{
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');
    const res = await fetch(`/api/forms/${slug}`);
    const form = await res.json();

    const container = document.getElementById('form');
    container.innerHTML = `<h1>${form.title}</h1>`;

    const formEl = document.createElement('form');
    form.schema.forEach((q,i)=>{
        const div = document.createElement('div');
        div.innerHTML = `<p>${q.text}</p>`;
        if(q.type === 'likert5'){
            const opts = ["Kesinlikle katılıyorum","Katılıyorum","Kararsızım","Katılmıyorum","Kesinlikle katılmıyorum"];
            opts.forEach(opt=>{
                div.innerHTML += `<label><input type="radio" name="q${i}" value="${opt}">${opt}</label><br>`;
            });
        } else if(q.type === 'radio'){
            q.options.forEach(opt=>{
                div.innerHTML += `<label><input type="radio" name="q${i}" value="${opt}">${opt}</label><br>`;
            });
        } else {
            div.innerHTML += `<input type="text" name="q${i}">`;
        }
        formEl.appendChild(div);
    });

    const btn = document.createElement('button');
    btn.textContent = 'Gönder';
    formEl.appendChild(btn);

    formEl.onsubmit = async (e)=>{
        e.preventDefault();
        const data = { slug, answers: {} };
        new FormData(formEl).forEach((val,key)=>{
            data.answers[key] = val;
        });
        const res = await fetch('/api/response', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if(res.ok) location.href = '/thanks.html';
        else alert('Zaten yanıtladınız veya hata oluştu.');
    };

    container.appendChild(formEl);
})();
</script>
</body>
</html>
