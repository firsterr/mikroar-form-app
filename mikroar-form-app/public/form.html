<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  /* —— Google Forms’a yakın sade kartlı tema —— */
  :root{
    --bg:#f6f7fb;
    --paper:#fff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --primary-600:#1d4ed8;
    --danger:#b91c1c;
    --warn:#b45309;
    --ring:0 0 0 3px rgba(37,99,235,.15);
    --shadow: 0 10px 20px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.06);
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  .wrap{max-width:920px;margin:40px auto;padding:0 20px}

  /* Orta kolon */
  #form{max-width:680px;margin:18px auto 8px;display:flex;flex-direction:column;gap:16px}

  /* Başlık & açıklama */
  #title{display:block;font-size:34px;margin:0 0 6px;font-weight:800;letter-spacing:-.01em}
  #desc{display:block;color:var(--muted);margin:0 0 12px}

  /* Uyarı/mesaj şeritleri */
  .note{display:none;margin:12px auto 0;max-width:680px;
    padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;box-shadow:var(--shadow)}
  .note.err{display:block;background:#fef2f2;border-color:#fecaca;color:var(--danger)}
  .note.warn{display:block;background:#fff7ed;border-color:#fed7aa;color:var(--warn)}
  .note.ok{display:block;background:#ecfdf5;border-color:#bbf7d0;color:#047857}

  /* Soru kartları */
  .row{background:var(--paper);border:1px solid var(--border);border-radius:18px;
    padding:18px;box-shadow:var(--shadow)}
  .row > label{display:block;font-weight:700;margin:0 0 10px;letter-spacing:.2px}

  /* Metin / e-posta / select / textarea */
  input[type=text],input[type=email],select,textarea{
    width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font:inherit;outline:none;
    transition:border-color .15s, box-shadow .15s}
  textarea{min-height:120px;resize:vertical}
  input[type=text]:focus,input[type=email]:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:var(--ring)}
  select:invalid{color:var(--muted)} select option[value=""]{color:var(--muted)}

  /* Radio/checkbox liste – tek elle rahat tıklansın */
  .row > div > div{margin:8px 0}
  .row input[type=radio], .row input[type=checkbox]{width:20px;height:20px;accent-color:var(--primary)}
  .row input[type=radio] + label, .row input[type=checkbox] + label{
    display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;
    width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;
    transition:box-shadow .15s, border-color .15s, background .15s}
  .row input[type=radio] + label:hover,
  .row input[type=checkbox] + label:hover{border-color:#d8dbe2}
  .row input[type=radio]:focus-visible + label,
  .row input[type=checkbox]:focus-visible + label{box-shadow:var(--ring)}
  .row input[type=radio]:checked + label,
  .row input[type=checkbox]:checked + label{border-color:var(--primary);background:#f4f7ff;box-shadow:var(--ring)}

  /* Gönder butonu */
  button[type=submit]{appearance:none;border:0;background:var(--primary);color:#fff;
    font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;align-self:flex-start;margin:8px auto 0 0;
    box-shadow:var(--shadow)}
  button[type=submit]:hover{background:var(--primary-600)}
  button[disabled]{opacity:.6;cursor:not-allowed}

  /* Alt bilgi ve marka */
  .after{max-width:680px;margin:12px auto 0;color:var(--muted);font-size:.95rem}
  .brand{max-width:680px;margin:20px auto 0;text-align:center;font-size:26px;font-weight:900;letter-spacing:.5px;color:#111}
  /* — Google Forms gibi ortala — */
#title,
#desc,
#alert,
#form,
#pickWrap{
  width: min(720px, 100%);
  margin-left: auto;
  margin-right: auto;   /* yatayda ortala */
}

/* Soru kartları form genişliğini tam kullansın */
#form .row{ width: 100%; }
</style>
</head>
<body>
<main class="wrap">
  <h1 id="title" style="display:none"></h1>
  <p id="desc" class="muted"></p>

  <!-- SLUG YOKKEN LİSTE -->
  <section id="pickWrap" class="selector" style="display:none">
    <h2>Bir anket seçin</h2>
    <p id="listWarn" class="note warn" style="display:none">Listelenecek form bulunamadı.</p>
    <div class="bar">
      <select id="pickSelect">
        <option value="">— Form (slug) seçin —</option>
      </select>
      <button id="pickBtn" type="button">Formu Aç</button>
    </div>
  </section>

  <!-- SLUG VARSA FORM -->
  <form id="form" method="POST" action="#" style="display:none"></form>
 
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = $('#title');
  const descEl  = $('#desc');
  const formEl  = $('#form');

  // Liste elemanları
  const pickWrap = $('#pickWrap');
  const pickSel  = $('#pickSelect');
  const pickBtn  = $('#pickBtn');
  const listWarn = $('#listWarn');

  // SLUG tespiti (form.html ise query’den, değilse path’ten)
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g,'');
  const pathSlug = rawPath && !/\.html$/i.test(rawPath) ? rawPath : '';
  const slug     = new URLSearchParams(location.search).get('slug') || pathSlug;
  const API = '/api';

  // Alt not alanını formun sonuna ekliyoruz (Google Forms gibi)
  const alertBottom = document.createElement('p');
  alertBottom.id = 'alertBottom';
  alertBottom.className = 'note';
  alertBottom.style.display = 'none';

  function setNote(el, kind, msg){
    el.className = 'note ' + kind;
    el.textContent = msg;
    el.style.display = 'block';
  }
  function showErr(msg){ setNote(alertBottom, 'err', msg); }
  function showWarn(msg){ setNote(alertBottom, 'warn', msg); }
  function showOk(msg){ setNote(alertBottom, 'ok', msg); }
  function hideNote(){ alertBottom.style.display = 'none'; }

  // --- SLUG YOKSA LİSTEYİ GETİR ---
  async function loadList(){
    titleEl.style.display = 'none';
    descEl.style.display  = 'none';
    pickWrap.style.display = 'block';
    pickSel.disabled = true; pickBtn.disabled = true;

    try{
      const r = await fetch(`${API}/forms-list`);
      const j = await r.json().catch(()=>({}));
      const items = (j && j.ok && (Array.isArray(j.items) || Array.isArray(j.forms)))
        ? (j.items || j.forms) : [];

      pickSel.innerHTML = '<option value="">— Form (slug) seçin —</option>';
      if(items.length === 0){
        listWarn.style.display = 'block';
      }else{
        listWarn.style.display = 'none';
        items.forEach(it => {
          const o = document.createElement('option');
          o.value = it.slug;
          o.textContent = `${it.title || it.slug} — ${it.slug}`;
          pickSel.appendChild(o);
        });
      }
    }catch(e){
      listWarn.textContent = 'Liste alınamadı: ' + e.message;
      listWarn.style.display = 'block';
    }finally{
      pickSel.disabled = false; pickBtn.disabled = false;
    }
  }

  pickBtn?.addEventListener('click', () => {
    const v = pickSel.value;
    if (!v) { pickSel.focus(); return; }
    location.href = `${location.pathname}?slug=${encodeURIComponent(v)}`;
  });
  pickSel?.addEventListener('change', () => pickBtn.click());

  if (!slug) { loadList(); return; }

  // Form fallback action
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Yardımcı DOM
  const mk = (name, attrs={}, html='') => {
    const el = document.createElement(name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    if (html) el.innerHTML = html;
    return el;
  };

  function drawQuestion(q, idx){
    const type  = (q.type || 'text').toLowerCase();
    const name  = q.name || `q${idx+1}`;
    const label = q.label || `Soru ${idx+1}`;
    const opts  = Array.isArray(q.options) ? q.options : [];

    const row = mk('div', { class:'row' });
    row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required ? ' *' : '')));

    if (type === 'radio' || type === 'checkbox') {
      if (!opts.length){
        row.appendChild(mk('div', {class:'muted'}, 'Bu soru için seçenek tanımlı değil.'));
        return row;
      }
      const g = mk('div', { class:'choices' });
      opts.forEach((opt,i) => {
        const id = `f_${name}_${i}`;
        const wrap = mk('label', { class:'opt', for:id }); // geniş temas alanı
        const input = mk('input', { type, id, name, value:String(opt), ...(q.required && type==='radio' ? {required:''}: {}) });
        if (type === 'checkbox') input.name = name + '[]';
        const txt = mk('span', {}, String(opt));
        wrap.appendChild(input);
        wrap.appendChild(txt);
        g.appendChild(wrap);
      });
      row.appendChild(g);
      return row;
    }

    if (type === 'select') {
      const select = mk('select', { id:`f_${name}`, name, ...(q.required ? {required:''} : {}) });
      select.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
      if (opts.length) {
        opts.forEach(v => select.appendChild(mk('option',{value:String(v)}, String(v))));
      } else {
        row.appendChild(mk('div', { class:'muted' }, 'Bu soru için seçenek tanımlı değil.'));
      }
      row.appendChild(select);
      return row;
    }

    if (type === 'textarea') {
      row.appendChild(mk('textarea', { id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
      return row;
    }

    const itype = (type === 'email') ? 'email' : 'text';
    row.appendChild(mk('input', { type:itype, id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
    return row;
  }

  // ŞEMA YÜKLEME
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || 'Form bulunamadı');
      const s = j.schema;

      titleEl.textContent = s.title || slug;
      titleEl.style.display = 'block';
      if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; }

      const qs = s.questions || s.fields || [];
      formEl.innerHTML = '';
      if (!qs.length){
        showErr('Bu formda soru tanımı bulunamadı.');
      } else {
        hideNote();
        qs.forEach((q,i) => formEl.appendChild(drawQuestion(q,i)));

        // Gönder alanı (buton üstte, alt notlar butonun altında)
        const actions = mk('div', {class:'actions'});
        actions.appendChild(mk('button', { type:'submit' }, 'Gönder'));
        formEl.appendChild(actions);

        // Alt bilgi/uyarı notu ve meta
        formEl.appendChild(alertBottom);
        formEl.appendChild(mk('p',{class:'foot-meta'},
          'Bu form mikroar.com alanında oluşturuldu. Uygunsuzluk bildirimi veya iletişim için site yöneticisine başvurabilirsiniz.'
        ));

        formEl.style.display = 'block';
      }
    })
    .catch(e => {
      titleEl.textContent = 'Form yüklenemedi';
      showErr(e.message || 'Hata');
      formEl.style.display = 'block';
      formEl.appendChild(alertBottom);
    });

  // :has fallback – bazı tarayıcılarda seçili efekti JS ile uygula
  const supportsHas = CSS.supports?.('selector(:has(*))');
  if (!supportsHas) {
    formEl.addEventListener('change', (e) => {
      if (!e.target.matches('input[type="radio"], input[type="checkbox"]')) return;
      const row = e.target.closest('.row');
      row?.querySelectorAll('.opt').forEach(o => {
        const inp = o.querySelector('input');
        o.classList.toggle('checked', !!inp?.checked);
      });
    });
  }

  // GÖNDER
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    // Yanıtları topla
    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/\[\]$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });

      let j = null;
      try { j = await r.json(); } catch(_) {}

      if (r.status === 409) {
        showWarn((j && (j.data?.message || j.message || j.error)) || 'Bu anketi daha önce doldurmuşsunuz.');
        return;
      }

      if (r.ok && (j?.ok ?? true)) {
        showOk('Gönderildi, teşekkürler!');
        formEl.reset();
      } else {
        showErr((j && (j.data?.message || j.message || j.error)) || `Hata: ${r.status}`);
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
