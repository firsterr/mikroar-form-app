<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <!-- Başlık/açıklama başlangıçta gizli -->
    <h1 id="title" style="display:none"></h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <!-- Form DOM’a çizilinceye kadar gizli -->
    <form id="form" novalidate hidden></form>
  </main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = document.getElementById('form-title') || document.querySelector('h1') || document.body;
  const descEl  = document.getElementById('form-desc')  || document.querySelector('p');
  const formEl  = document.getElementById('f') || document.querySelector('form') || (() => {
    const f = document.createElement('form'); document.body.appendChild(f); return f;
  })();

  const slug = new URLSearchParams(location.search).get('slug');
  if (!slug) { document.body.innerHTML = '<h2>Form bulunamadı (slug yok)</h2>'; return; }

  // Hem eski "schema" cevabını hem de "form" sarmalını destekle
  function normalizePayload(j) {
    // /api/forms?slug=... → { ok:true, schema:{ title, description, schema? | fields? | questions? } }
    // veya { ok:true, form:{ title, description, schema:{ questions } } }
    const formNode = j.form || j.schema || j;

    const title = formNode.title || `Form: ${slug}`;
    const description = formNode.description || '';

    // Asıl şema nerede? Bazı kurulumlarda schema altinda, bazılarında düz geliyor.
    const sch = formNode.schema || formNode;

    // Zaten questions varsa dokunma
    if (Array.isArray(sch.questions)) {
      return { title, description, questions: sch.questions };
    }

    // "fields" geldiyse questions’a dönüştür
    if (Array.isArray(sch.fields)) {
      const questions = sch.fields.map((f) => {
        // Admin’den gelen muhtemel alanlar: type, label, options, required
        const q = { type: (f.type || 'text').toLowerCase(), label: f.label || f.name || 'Soru', required: !!f.required };
        if (typeof f.options === 'string') {
          q.options = f.options.split(',').map(s => s.trim()).filter(Boolean);
        } else if (Array.isArray(f.options)) {
          q.options = f.options;
        }
        return q;
      });
      return { title, description, questions };
    }

    return { title, description, questions: [] };
  }

  // Alan çizimi
  function render({ title, description, questions }) {
    // başlık / açıklama
    if (titleEl) titleEl.textContent = title;
    if (descEl && description) { descEl.textContent = description; descEl.style.display = 'block'; }

    formEl.innerHTML = '';
    if (!Array.isArray(questions) || questions.length === 0) {
      const warn = document.createElement('div');
      warn.style = 'background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin:12px 0';
      warn.textContent = 'Bu formda soru tanımı bulunamadı.';
      formEl.parentNode.insertBefore(warn, formEl);
      return;
    }

    questions.forEach((q, i) => {
      const wrap = document.createElement('div');
      wrap.style.margin = '16px 0';
      const name = `q_${i}`;
      const label = document.createElement('label');
      label.textContent = `${i+1}. ${q.label || 'Soru'}${q.required ? ' *' : ''}`;
      label.style.display = 'block';
      label.style.fontWeight = '600';
      label.htmlFor = `${name}_id`;
      wrap.appendChild(label);

      const type = (q.type || 'text').toLowerCase();
      if (type === 'radio' || type === 'checkbox') {
        (q.options || []).forEach((opt, j) => {
          const id = `${name}_${j}`;
          const line = document.createElement('label');
          line.style.display = 'block';
          line.innerHTML = `<input id="${id}" type="${type}" name="${name}${type==='checkbox'?'[]':''}" value="${opt}"> ${opt}`;
          wrap.appendChild(line);
        });
      } else if (type === 'textarea') {
        const ta = document.createElement('textarea');
        ta.name = name; ta.id = `${name}_id`;
        if (q.required) ta.required = true;
        ta.style.width = '100%';
        ta.rows = 4;
        wrap.appendChild(ta);
      } else {
        // text, email vs.
        const inp = document.createElement('input');
        inp.type = type === 'email' ? 'email' : 'text';
        inp.name = name; inp.id = `${name}_id`;
        if (q.required) inp.required = true;
        inp.style.width = '100%';
        wrap.appendChild(inp);
      }

      formEl.appendChild(wrap);
    });

    // Gönder butonu
    const btn = document.createElement('button');
    btn.type = 'submit';
    btn.textContent = 'Gönder';
    formEl.appendChild(btn);

    // Submit
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;

      // answers: q_0, q_1, ...
      const answers = {};
      const fd = new FormData(formEl);
      fd.forEach((v, k) => {
        if (answers[k] !== undefined) {
          // checkbox çoklu
          if (!Array.isArray(answers[k])) answers[k] = [answers[k]];
          answers[k].push(v);
        } else {
          answers[k] = v;
        }
      });

      try {
        const res = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ answers })
        });
        const j = await res.json().catch(() => ({}));
        if (res.ok && j.ok) {
          alert('Gönderildi, teşekkürler!');
          formEl.reset();
        } else {
          alert(j?.data?.message || j?.error || `Hata: ${res.status}`);
        }
      } catch (err) {
        alert('Bağlantı hatası: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    });
  }

  // Yükle
  fetch(`/api/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => render(normalizePayload(j)))
    .catch(() => { document.body.innerHTML = '<h2>Form yüklenemedi.</h2>'; });

})();
</script>
</body>
</html>
