<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    .row .opts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="email"],textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
    .muted{color:#666;font-size:.95rem}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const API = '/api'; // netlify redirect ile .functions
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");

  // slug: ?slug=... (tercih) – yoksa path (ör: /formayvalik)
  const rawPath = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // Fallback: JS kapalıysa
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı al
  const r = await fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`);
  const j = await r.json().catch(()=> ({}));
  if (!r.ok || !j.ok || !j.schema) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = j?.error || `Hata: ${r.status}`;
    alertEl.style.display = "block";
    return;
  }

  const s = j.schema;
  $("#title").textContent = s.title || slug;
  if (s.description) {
    $("#desc").textContent = s.description;
    $("#desc").style.display = "block";
  }

  const fields = s.questions || s.fields || [];
  // ... şema çekildi ve const schema = j.schema; var:
formEl.innerHTML = "";
(schema.questions || schema.fields || []).forEach((q, i) => {
  const row = document.createElement("div");
  row.className = "row";
  const name = q.name || `q_${i}`;
  const idBase = `fld_${name}_${i}`;

  let control = "";

  if (q.type === "radio" && Array.isArray(q.options)) {
    control = q.options.map((opt, k) => {
      const id = `${idBase}_${k}`;
      return `
        <label style="display:block;margin:.25rem 0">
          <input type="radio" name="${name}" id="${id}" value="${opt}" ${q.required ? "required" : ""}>
          <span>${opt}</span>
        </label>`;
    }).join("");
  } else if (q.type === "checkbox" && Array.isArray(q.options)) {
    control = q.options.map((opt, k) => {
      const id = `${idBase}_${k}`;
      return `
        <label style="display:block;margin:.25rem 0">
          <input type="checkbox" name="${name}" id="${id}" value="${opt}" ${q.required ? "required" : ""}>
          <span>${opt}</span>
        </label>`;
    }).join("");
  } else if (q.type === "select" && Array.isArray(q.options)) {
    control = `
      <select name="${name}" id="${idBase}" ${q.required ? "required" : ""}>
        <option value="" disabled selected>Seçiniz</option>
        ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}
      </select>`;
  } else if (q.type === "textarea") {
    control = `<textarea name="${name}" id="${idBase}" ${q.required ? "required" : ""}></textarea>`;
  } else if (q.type === "email") {
    control = `<input type="email" name="${name}" id="${idBase}" ${q.required ? "required" : ""} />`;
  } else {
    // default text
    control = `<input type="text" name="${name}" id="${idBase}" ${q.required ? "required" : ""} />`;
  }

  row.innerHTML = `
    <label for="${idBase}">${q.label || name}${q.required ? " *" : ""}</label>
    ${control || `<div class="err">Bu soru için seçenek tanımlı değil.</div>`}
  `;
  formEl.appendChild(row);
});
  });

  // Gönder butonu
  const btn = document.createElement('button');
  btn.type = 'submit';
  btn.textContent = 'Gönder';
  formEl.appendChild(btn);

  // === SUBMIT ===
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    alertEl.style.display = 'none';

    // Cevapları topla (checkbox çoklu değerleri dahil)
    const fd = new FormData(formEl);
    const answers = {};
    fields.forEach((q, idx) => {
      const nm = q.name || `q${idx+1}`;
      const t = (q.type || 'text').toLowerCase();
      if (t === 'checkbox') {
        answers[nm] = fd.getAll(nm);             // çoklu
      } else {
        answers[nm] = fd.get(nm);                // tek
      }
    });

    try {
      const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ answers })
      });
      const jj = await res.json().catch(()=> ({}));
      if (res.ok && jj.ok) {
        alertEl.className = 'ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'err';
        alertEl.textContent = jj?.data?.message || jj?.error || `Hata: ${res.status}`;
        alertEl.style.display = 'block';
      }
    } catch (err) {
      alertEl.className = 'err';
      alertEl.textContent = 'Bağlantı hatası: ' + err.message;
      alertEl.style.display = 'block';
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
