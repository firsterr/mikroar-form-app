<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:860px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    fieldset{border:0;padding:0;margin:0}
    .opts label{display:flex;gap:10px;align-items:center;font-weight:500;margin:6px 0}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin:16px 0}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin:16px 0}
    small.muted{color:#6b7280}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor...</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>
    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");

  // slug: ?slug=... yoksa /slug
  const slug = new URLSearchParams(location.search).get("slug")
            || location.pathname.replace(/^\/+|\/+$/g,"");
  if (!slug) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err"; alertEl.textContent = "URL’de ?slug=... yok."; alertEl.style.display = "block";
    return;
  }

  // Fallback (JS kapalıyken de çalışsın)
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı al
  const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`);
  const j = await r.json().catch(()=>({}));
  if (!r.ok || !j.ok || !j.schema) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err"; alertEl.textContent = j.error || `Hata: ${r.status}`; alertEl.style.display = "block";
    return;
  }

  const schema = j.schema;
  const questions = schema.questions || schema.fields || [];

  // Başlık + açıklama
  $("#title").textContent = schema.title || slug;
  if (schema.description) { $("#desc").textContent = schema.description; $("#desc").style.display = "block"; }

  // Çiz
  formEl.innerHTML = "";
  if (!questions.length) {
    const w = document.createElement('div');
    w.className = 'err'; w.textContent = 'Bu formda soru tanımı bulunamadı.';
    formEl.appendChild(w);
  } else {
    questions.forEach((q, i) => {
      const wrap = document.createElement('div'); wrap.className = 'row';
      const name = q.name || `q_${i+1}`;
      const req  = q.required ? 'required' : '';
      const label = q.label || `Soru ${i+1}`;

      if (q.type === 'textarea') {
        wrap.innerHTML = `<label for="${name}">${label}${q.required?' *':''}</label>
                          <textarea id="${name}" name="${name}" ${req}></textarea>`;
      } else if (q.type === 'text' || q.type === 'email') {
        wrap.innerHTML = `<label for="${name}">${label}${q.required?' *':''}</label>
                          <input id="${name}" type="${q.type}" name="${name}" ${req} />`;
      } else if (q.type === 'select') {
        const opts = Array.isArray(q.options)?q.options:[];
        wrap.innerHTML = `<label for="${name}">${label}${q.required?' *':''}</label>
                          <select id="${name}" name="${name}" ${req}>
                            <option value="" disabled selected>Seçiniz</option>
                            ${opts.map(v=>`<option value="${encodeHTML(v)}">${encodeHTML(v)}</option>`).join('')}
                          </select>
                          ${!opts.length?`<small class="muted">Bu soru için seçenek tanımlı değil.</small>`:''}`;
      } else if (q.type === 'radio' || q.type === 'checkbox') {
        const opts = Array.isArray(q.options)?q.options:[];
        const type = q.type;
        wrap.innerHTML = `<fieldset><legend>${encodeHTML(label)}${q.required?' *':''}</legend>
            <div class="opts">
              ${opts.map((v,idx)=>`
                <label><input type="${type}" name="${name}" value="${encodeHTML(v)}" ${type==='radio' && idx===0 && q.required?'required':''}> ${encodeHTML(v)}</label>`).join('')}
            </div>
          </fieldset>
          ${!opts.length?`<small class="muted">Bu soru için seçenek tanımlı değil.</small>`:''}`;
      } else {
        // bilinmeyen tip → text
        wrap.innerHTML = `<label for="${name}">${label}${q.required?' *':''}</label>
                          <input id="${name}" type="text" name="${name}" ${req} />`;
      }
      formEl.appendChild(wrap);
    });

    const btn = document.createElement('button');
    btn.type = 'submit'; btn.textContent = 'Gönder';
    formEl.appendChild(btn);
  }

  // Gönder
  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = formEl.querySelector('button[type="submit"]'); if (btn) btn.disabled = true;
    alertEl.style.display = 'none';

    // cevapları topla
    const answers = {};
    (schema.questions || schema.fields || []).forEach((q,i)=>{
      const name = q.name || `q_${i+1}`;
      if (q.type === 'checkbox') {
        answers[name] = Array.from(document.querySelectorAll(`[name="${CSS.escape(name)}"]:checked`)).map(el=>el.value);
      } else if (q.type === 'radio') {
        const c = document.querySelector(`[name="${CSS.escape(name)}"]:checked`);
        answers[name] = c ? c.value : '';
      } else {
        const v = new FormData(formEl).get(name);
        answers[name] = v == null ? '' : v;
      }
    });

    try{
      const res = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`, {
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ answers })
      });
      const jr = await res.json().catch(()=>({}));
      if (res.ok && jr.ok) {
        alertEl.className = 'ok'; alertEl.textContent = 'Gönderildi, teşekkürler!'; alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'err'; alertEl.textContent = jr?.error || `Hata: ${res.status}`; alertEl.style.display = 'block';
      }
    }catch(err){
      alertEl.className = 'err'; alertEl.textContent = 'Bağlantı hatası: ' + err.message; alertEl.style.display='block';
    }finally{ if (btn) btn.disabled = false; }
  });

  function encodeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
})();
</script>
</body>
</html>
