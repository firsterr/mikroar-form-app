<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  /* —— Google Forms tadında sade kartlı tema —— */

  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --primary-600:#1d4ed8;
    --danger:#b91c1c;
    --warn:#b45309;
    --shadow: 0 10px 20px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.06);
  }

  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  .wrap{max-width:860px;margin:48px auto;padding:0 20px}

  /* Başlık & açıklama küçük kart görünümü */
  #title, #desc, #alert{display:block}
  #title{
    font-size:34px;margin:0 0 6px;font-weight:800;letter-spacing:-.01em
  }
  #desc{color:var(--muted);margin:0 0 14px}
  .note{margin:14px 0;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;box-shadow:var(--shadow)}
  .note.err{background:#fef2f2;border-color:#fecaca;color:var(--danger)}
  .note.warn{background:#fff7ed;border-color:#fed7aa;color:var(--warn)}
  .note.ok{background:#ecfdf5;border-color:#bbf7d0;color:#047857}

  /* Soru kartları */
  #form{margin-top:18px;display:flex;flex-direction:column;gap:16px}
  .row{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px 18px 16px;
    box-shadow:var(--shadow);
  }
  .row > label{
    display:block;
    font-weight:700;
    margin:0 0 10px;
    letter-spacing:.2px;
  }

  /* Metin / e-posta / select / textarea */
  input[type=text],
  input[type=email],
  select,
  textarea{
    width:100%;
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    font:inherit;
    outline:none;
    transition:border-color .15s, box-shadow .15s;
  }
  textarea{min-height:120px;resize:vertical}
  input[type=text]:focus,
  input[type=email]:focus,
  select:focus,
  textarea:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(37,99,235,.12);
  }
  select:invalid{color:var(--muted)}
  select option[value=""]{color:var(--muted)}

  /* Radio/checkbox satırları */
  .row > div > div{display:flex;align-items:center;gap:10px;margin:8px 0}
  input[type=radio], input[type=checkbox]{width:18px;height:18px}

  /* Gönder butonu */
  button[type=submit]{
    appearance:none;border:0;background:var(--primary);color:#fff;
    font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer;
    margin-top:4px;box-shadow:var(--shadow)
  }
  button[type=submit]:hover{background:var(--primary-600)}
  button[disabled]{opacity:.6;cursor:not-allowed}

  /* Slug seçme ekranı (form.html slug yokken) */
  .selector{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px;
    box-shadow:var(--shadow);
    margin-top:18px;
  }
  .selector h2{margin:0 0 12px}
  .selector .bar{display:flex;gap:10px}
  .selector select{flex:1}

  @media (max-width:640px){
    .wrap{padding:0 14px}
    #title{font-size:28px}
  }
</style>
</head>
<body>
<main class="wrap">
  <h1 id="title" style="display:none"></h1>
  <p id="desc" class="muted" style="display:none"></p>
  <p id="alert" class="note err" style="display:none"></p>

  <!-- SLUG YOKKEN LISTE -->
  <section id="pickWrap" style="display:none">
    <p id="listWarn" class="note warn" style="display:none">Listelenecek form bulunamadı.</p>
    <div class="inline">
      <label for="pickSelect" style="margin:0;min-width:140px">Bir anket seçin</label>
      <select id="pickSelect" class="inline-input">
        <option value="">— Form (slug) seçin —</option>
      </select>
      <button id="pickBtn" type="button" class="primary">Formu Aç</button>
    </div>
  </section>

  <!-- SLUG VARSA FORM -->
  <form id="form" class="gform" method="POST" action="#" style="display:none"></form>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = $('#title');
  const descEl  = $('#desc');
  const alertEl = $('#alert');
  const formEl  = $('#form');

  // Liste elemanları
  const pickWrap = $('#pickWrap');
  const pickSel  = $('#pickSelect');
  const pickBtn  = $('#pickBtn');
  const listWarn = $('#listWarn');

  // SLUG tespiti: path'te .html varsa slug DEĞİLDİR
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g, '');
  const pathSlug = rawPath && !/\.html$/i.test(rawPath) ? rawPath : '';
  const slug     = new URLSearchParams(location.search).get('slug') || pathSlug;
  const API = '/api';

  function showErr(msg){ alertEl.textContent = msg; alertEl.className='note err'; alertEl.style.display='block'; }
  function showWarn(msg){ alertEl.textContent = msg; alertEl.className='note warn'; alertEl.style.display='block'; }
  function showOk(msg){ alertEl.textContent = msg; alertEl.className='note ok'; alertEl.style.display='block'; }
  function hideNote(){ alertEl.style.display='none'; }

  /* ====== ANAHTARLI LİSTE ERİŞİMİ (sadece slug yokken) ====== */
  const LS_KEY = 'ADMIN_TOKEN';
  function getToken(force=false){
    let t = localStorage.getItem(LS_KEY);
    if (!t || force){
      const v = prompt('Yönetici anahtarı (X-Admin-Token):');
      if (v){ localStorage.setItem(LS_KEY, v); t = v; }
    }
    return t;
  }
  function authHeaders(){
    const t = getToken();            // burada prompt açılır
    if (!t) throw new Error('Anahtar gerekli.');
    return { 'Accept':'application/json', 'X-Admin-Token': t };
  }

  // --- SLUG YOKSA LİSTEYİ GETİR ---
  async function loadList(){
    hideNote();
    titleEl.textContent = 'Bir anket seçin';
    titleEl.style.display = 'block';
    descEl.style.display = 'none';
    pickWrap.style.display = 'block';
    pickSel.disabled = true; pickBtn.disabled = true;

    try{
      let r = await fetch(`${API}/forms-list`, { headers: authHeaders() });
      // Anahtar hatalıysa bir kez daha soralım
      if (r.status === 401 || r.status === 403){
        localStorage.removeItem(LS_KEY);
        alert('Anahtar hatalı veya eksik. Lütfen tekrar girin.');
        r = await fetch(`${API}/forms-list`, { headers: authHeaders() });
      }

      const j = await r.json().catch(()=>({}));
      const items = (j && j.ok && (Array.isArray(j.items) || Array.isArray(j.forms)))
        ? (j.items || j.forms)
        : [];

      pickSel.innerHTML = '<option value="">— Form (slug) seçin —</option>';

      if (!items.length){
        listWarn.textContent = 'Listelenecek form bulunamadı.';
        listWarn.style.display = 'block';
      } else {
        listWarn.style.display = 'none';
        items.forEach(it => {
          const o = document.createElement('option');
          o.value = it.slug;
          o.textContent = `${it.title || it.slug} — ${it.slug}`;
          pickSel.appendChild(o);
        });
      }
    } catch(e){
      listWarn.textContent = 'Liste alınamadı: ' + e.message;
      listWarn.style.display = 'block';
    } finally {
      pickSel.disabled = false; pickBtn.disabled = false;
    }
  }

  pickBtn?.addEventListener('click', () => {
    const v = pickSel.value;
    if (!v) { pickSel.focus(); return; }
    location.href = `${location.pathname}?slug=${encodeURIComponent(v)}`;
  });
  pickSel?.addEventListener('change', () => {
    if (pickSel.value) pickBtn.click();
  });

  // SLUG VARSA FORMU YÜKLE; YOKSA LİSTEYİ AÇ
  if (!slug) { loadList(); return; }

  // Fallback action
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Helpers
  function mk(name, attrs={}, html=''){
    const el = document.createElement(name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    if (html) el.innerHTML = html;
    return el;
  }

  function drawQuestion(q, idx){
    const type = (q.type || 'text').toLowerCase();
    const name = q.name || `q${idx+1}`;
    const label = q.label || `Soru ${idx+1}`;
    const opts = Array.isArray(q.options) ? q.options : [];

    const row = mk('div', { class:'row' });
    row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required ? ' *' : '')));

    if (type === 'radio' || type === 'checkbox') {
      if (!opts.length){ row.appendChild(mk('div',{},'<div class="muted">Bu soru için seçenek tanımlı değil.</div>')); return row; }
      const g = mk('div');
      opts.forEach((opt,i) => {
        const id = `f_${name}_${i}`;
        const w = mk('div');
        const input = mk('input', { type, id, name, value:String(opt), ...(q.required && type==='radio' ? {required:''}: {}) });
        if (type === 'checkbox') input.name = name + '[]';
        const lab = mk('label', { for:id }, String(opt));
        w.appendChild(input); w.appendChild(lab);
        g.appendChild(w);
      });
      row.appendChild(g);
      return row;
    }

    if (type === 'select') {
      const select = mk('select', { id:`f_${name}`, name, ...(q.required ? {required:''} : {}) });
      select.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
      if (opts.length) {
        opts.forEach(v => select.appendChild(mk('option',{value:String(v)}, String(v))));
      }
      row.appendChild(select);
      if (!opts.length) row.appendChild(mk('div', { class:'muted' }, 'Bu soru için seçenek tanımlı değil.'));
      return row;
    }

    if (type === 'textarea') {
      row.appendChild(mk('textarea', { id:`f_${name}], name, ...(q.required?{required:''}:{}) }));
      return row;
    }

    const itype = (type === 'email') ? 'email' : 'text';
    row.appendChild(mk('input', { type:itype, id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
    return row;
  }

  // ŞEMA YÜKLE
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || 'Form bulunamadı');
      const s = j.schema;

      titleEl.textContent = s.title || slug;
      titleEl.style.display = 'block';
      if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; }

      const qs = s.questions || s.fields || [];
      formEl.innerHTML = '';
      if (!qs.length){
        showErr('Bu formda soru tanımı bulunamadı.');
      } else {
        hideNote();
        qs.forEach((q,i) => formEl.appendChild(drawQuestion(q,i)));
        const btn = mk('button', { type:'submit', class:'primary' }, 'Gönder');
        formEl.appendChild(btn);
        formEl.style.display = 'block';
      }
    })
    .catch(e => {
      titleEl.textContent = 'Form yüklenemedi';
      showErr(e.message || 'Hata');
    });

  // GÖNDER
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/$begin:math:display$$end:math:display$$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });

      let j = null;
      try { j = await r.json(); } catch(_) {}

      if (r.status === 409) {
        alertEl.className = 'note warn';
        alertEl.textContent =
          (j && (j.data?.message || j.message || j.error)) ||
          'Bu anketi daha önce doldurmuşsunuz.';
        alertEl.style.display = 'block';
        return;
      }

      if (r.ok && (j?.ok ?? true)) {
        alertEl.className = 'note ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        showErr(
          (j && (j.data?.message || j.message || j.error)) ||
          `Hata: ${r.status}`
        );
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
