<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:860px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .note{margin:16px 0;padding:12px;border-radius:8px;border:1px solid #ccd;background:#f7f7f9}
    .err{background:#fee;border:1px solid #f99;color:#900}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064}
    .muted{color:#666;font-size:.95rem}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" class="muted" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const formEl  = $('#form');
  const alertEl = $('#alert');
  const titleEl = $('#title');
  const descEl  = $('#desc');

  // slug
  const slug = new URLSearchParams(location.search).get('slug')
    || location.pathname.replace(/^\/+|\/+$/g,''); // (opsiyonel fallback)
  if (!slug) {
    titleEl.textContent = 'Form yüklenemedi.';
    alertEl.className = 'note err';
    alertEl.textContent = 'URL’de ?slug=… yok.';
    alertEl.style.display = 'block';
    return;
  }

  // Fallback (JS kapalıysa)
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Şemayı çek
  let j;
  try {
    const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`);
    j = await r.json();
    if (!r.ok || !j?.ok || !j?.schema) throw new Error(j?.error || `HTTP ${r.status}`);
  } catch (e) {
    titleEl.textContent = 'Form yüklenemedi.';
    alertEl.className = 'note err';
    alertEl.textContent = e.message || 'Form alınamadı';
    alertEl.style.display = 'block';
    return;
  }

  const schema = j.schema;
  titleEl.textContent = schema.title || slug;
  if (schema.description) { descEl.textContent = schema.description; descEl.style.display = 'block'; }

  // Alanları çiz
  formEl.innerHTML = '';
  const qs = schema.questions || schema.fields || [];

  if (!qs.length) {
    const warn = document.createElement('div');
    warn.className = 'note err';
    warn.textContent = 'Bu formda soru tanımı bulunamadı.';
    formEl.appendChild(warn);
  } else {
    qs.forEach((q, i) => {
      const row = document.createElement('div');
      row.className = 'row';
      const name = q.name || `q_${i}`;
      const labelText = `${q.label || name}${q.required ? ' *' : ''}`;

      const label = document.createElement('label');
      label.htmlFor = `f_${name}`;
      label.textContent = labelText;
      row.appendChild(label);

      // renderer
      const type = (q.type || 'text').toLowerCase();
      const opts = Array.isArray(q.options) ? q.options : [];

      function warnNoOptions() {
        const w = document.createElement('div');
        w.className = 'note err';
        w.textContent = 'Bu soru için seçenek tanımlı değil.';
        row.appendChild(w);
      }

      if (type === 'text' || type === 'email') {
        const inp = document.createElement('input');
        inp.type = type;
        inp.id = `f_${name}`;
        inp.name = name;
        if (q.required) inp.required = true;
        row.appendChild(inp);
      } else if (type === 'textarea') {
        const ta = document.createElement('textarea');
        ta.id = `f_${name}`;
        ta.name = name;
        if (q.required) ta.required = true;
        row.appendChild(ta);
      } else if (type === 'radio') {
        if (!opts.length) warnNoOptions();
        opts.forEach((opt, j) => {
          const id = `f_${name}_${j}`;
          const wrap = document.createElement('label');
          wrap.className = 'opt';
          wrap.innerHTML = `<input type="radio" id="${id}" name="${name}" value="${opt}"> <span>${opt}</span>`;
          row.appendChild(wrap);
        });
        if (q.required) {
          // bir tane required hilesi
          const first = row.querySelector(`input[name="${name}"]`);
          if (first) first.required = true;
        }
      } else if (type === 'checkbox') {
        if (!opts.length) warnNoOptions();
        opts.forEach((opt, j) => {
          const id = `f_${name}_${j}`;
          const wrap = document.createElement('label');
          wrap.className = 'opt';
          wrap.innerHTML = `<input type="checkbox" id="${id}" name="${name}" value="${opt}"> <span>${opt}</span>`;
          row.appendChild(wrap);
        });
      } else if (type === 'select') {
        if (!opts.length) warnNoOptions();
        const sel = document.createElement('select');
        sel.id = `f_${name}`;
        sel.name = name;
        if (q.required) sel.required = true;
        sel.innerHTML = `<option value="">Seçiniz</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join('');
        row.appendChild(sel);
      } else {
        // bilinmeyen -> text
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.id = `f_${name}`;
        inp.name = name;
        if (q.required) inp.required = true;
        row.appendChild(inp);
      }

      formEl.appendChild(row);
    });

    // Gönder düğmesi
    const btn = document.createElement('button');
    btn.type = 'submit';
    btn.textContent = 'Gönder';
    formEl.appendChild(btn);
  }

  // Submit
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    alertEl.style.display = 'none';

    // cevapları topla
    const answers = {};
    qs.forEach((q, i) => {
      const name = q.name || `q_${i}`;
      const type = (q.type || 'text').toLowerCase();
      if (type === 'checkbox') {
        answers[name] = Array.from(document.querySelectorAll(`[name="${name}"]:checked`)).map(el => el.value);
      } else if (type === 'radio') {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        answers[name] = el ? el.value : '';
      } else {
        const el = document.querySelector(`[name="${name}"]`);
        answers[name] = el ? (el.value ?? '').trim() : '';
      }
    });

    try {
      const res = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ answers })
      });
      const jr = await res.json().catch(() => ({}));

      if (res.ok && jr.ok) {
        alertEl.className = 'note ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'note err';
        alertEl.textContent = jr?.data?.message || jr?.error || `Hata: ${res.status}`;
        alertEl.style.display = 'block';
      }
    } catch (err) {
      alertEl.className = 'note err';
      alertEl.textContent = 'Bağlantı hatası: ' + err.message;
      alertEl.style.display = 'block';
    } finally {
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
