<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MikroAR Anket</title>
  <meta name="description" content="Hızlı ve güvenli çevrimiçi anket deneyimi." />
  <link id="canonical" rel="canonical" href="https://form.mikroar.com/form.html" />
  <style>
    :root { --gap: 12px; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 24px; }
    .skel { display: grid; gap: var(--gap); }
    .sk { background: #eee; height: 16px; border-radius: 8px; animation: p 1.2s infinite; }
    .sk.big { height: 44px; }
    @keyframes p { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    .error { background:#fff7f7; border:1px solid #ffd3d3; color:#b00020; padding:12px; border-radius:8px; display:none; }
    .hidden { display:none; }
    .btn { padding:10px 16px; border-radius:8px; border:1px solid #ddd; background:#111; color:#fff; cursor:pointer; }
    .field { margin: 18px 0; }
    .q { padding:12px; border-radius:12px; transition: background 200ms, box-shadow 200ms; }
    .q.focus { background:#f9fafb; box-shadow: inset 0 0 0 2px #e5e7eb; }
    .q.checked { background:#fffef2; box-shadow: inset 0 0 0 2px #fde68a; }
    label { display:block; margin:6px 0; cursor:pointer; }
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Liste modu (parametresiz) -->
    <div id="listMode" class="hidden">
      <h1>Form Seç</h1>
      <div class="field">
        <input id="admintoken" type="password" placeholder="ADMIN_TOKEN" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
      </div>
      <div class="field">
        <select id="slugSelect" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px">
          <option value="">Önce token girip “Listeyi Yükle”ye basın…</option>
        </select>
      </div>
      <button id="loadList" class="btn">Listeyi Yükle</button>
      <button id="openSlug" class="btn" style="margin-left:8px">Aç</button>
      <div id="listErr" class="muted" style="margin-top:8px;display:none"></div>
      <hr style="margin:24px 0">
    </div>

    <!-- Form modu -->
    <div id="skeleton" class="skel">
      <div class="sk big"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>
    <div id="error" class="error"></div>
    <div id="app" class="hidden"></div>
  </div>

  <script src="/app.js" defer></script>
  <script>
    // Canonical'ı parametre varsa güncelle
    (function(){
      const u = new URL(location.href);
      const c = document.getElementById('canonical');
      const slug = u.searchParams.get('slug'), k = u.searchParams.get('k');
      if (slug) c.href = `https://form.mikroar.com/form.html?slug=${encodeURIComponent(slug)}`;
      else if (k) c.href = `https://form.mikroar.com/form.html?k=${encodeURIComponent(k)}`;
    })();

    // Parametresizse liste modunu aç
    (function(){
      const u = new URL(location.href);
      const hasIdent = u.searchParams.get('slug') || u.searchParams.get('k') || /^\/f\//.test(location.pathname);
      if (!hasIdent) {
        document.getElementById("listMode").classList.remove("hidden");
        // Liste işlevleri
        const t = document.getElementById("admintoken");
        const s = document.getElementById("slugSelect");
        const e = document.getElementById("listErr");

        document.getElementById("loadList").addEventListener("click", async () => {
          const token = t.value || "";
          const r = await fetch(`/api/forms-list?token=${encodeURIComponent(token)}`, {
            headers: { "x-admin-token": token }
          });
          if (!r.ok) { e.textContent = "Token doğrulanamadı."; e.style.display = "block"; return; }
          e.style.display = "none";
          const data = await r.json();
          s.innerHTML = "";
          for (const f of (data.items||[])) {
            const opt = document.createElement("option");
            opt.value = f.slug;
            opt.textContent = `${f.slug} — ${(f.title||"")}`;
            s.appendChild(opt);
          }
        });

        document.getElementById("openSlug").addEventListener("click", () => {
          const slug = s.value; if (!slug) return;
          location.href = `/form.html?slug=${encodeURIComponent(slug)}`;
        });
      }
    })();
  </script>
</body>
</html>
