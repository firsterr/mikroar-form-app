<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anket</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:860px;margin:24px auto;padding:0 12px}
    h1{margin:0 0 16px}
    .card{background:#f6f7fb;border:1px solid #e5e7ee;border-radius:10px;padding:14px 16px;margin:10px 0}
    .q{font-weight:600;margin:0 0 8px}
    .opt{display:flex;gap:8px;align-items:center;margin:6px 0}
    input[type="text"],select,textarea{width:100%;padding:10px;border:1px solid #d4d7e3;border-radius:8px}
    textarea{min-height:90px}
    .error{color:#b91c1c;white-space:pre-wrap}
    .muted{color:#667085}
    button{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <h1 id="title">Anket</h1>
  <div id="root" class="card">Yükleniyor…</div>
  <div id="actions" style="margin-top:16px;display:none">
    <button id="send">Gönder</button>
  </div>

<script>
(async () => {
  const $ = s => document.querySelector(s);
  const root = $('#root');
  const btn  = $('#send');
  const actions = $('#actions');
  const slug = new URLSearchParams(location.search).get('slug');

  if(!slug){ root.innerHTML = '<div class="error">Slug yok.</div>'; return; }

  // 1) API'den formu getir
  let res, txt, json;
  try{
    res = await fetch(`/api/forms/${encodeURIComponent(slug)}`, {cache:'no-store'});
    txt = await res.text();
  }catch(e){
    root.innerHTML = '<div class="error">İstek hatası: '+e.message+'</div>';
    return;
  }

  try{ json = JSON.parse(txt); }
  catch{ root.innerHTML = '<div class="error">JSON parse hatası — sunucu cevabı:\n\n'+txt+'</div>'; return; }

  if(!json || json.ok !== true){
    root.innerHTML = '<div class="error">API hata: ' + (json && json.error || 'bilinmeyen') + '</div>';
    return;
  }

  const form = json.form || {};
  $('#title').textContent = form.title || 'Anket';

  // 2) Şema: dizi ise direkt, değilse schema.questions'ı kullan
  let schema = form.schema;
  try{ if(typeof schema === 'string') schema = JSON.parse(schema); }catch(_){}
  const questions = Array.isArray(schema)
      ? schema
      : (schema && Array.isArray(schema.questions) ? schema.questions : []);

  if(!questions.length){
    root.innerHTML = '<div class="muted">Bu ankette henüz soru yok.</div>';
    return;
  }

  // 3) Soruları çiz
  root.innerHTML = '';
  questions.forEach((q, i) => {
    const card = document.createElement('div'); card.className = 'card';
    const title = document.createElement('div'); title.className = 'q';
    const label = q.label || q.text || `Soru ${i+1}`;
    title.textContent = `${i+1}. ${label}` + (q.required ? ' *' : '');
    card.appendChild(title);

    const t = String(q.type || 'radio').toLowerCase();
    const name = `q_${i}`;

    if (t === 'checkbox'){
      (q.options || []).forEach(opt => {
        const row = document.createElement('label'); row.className='opt';
        const inp = document.createElement('input'); inp.type='checkbox'; inp.name=name; inp.value=opt;
        row.appendChild(inp); row.appendChild(document.createTextNode(opt));
        card.appendChild(row);
      });

    } else if (t === 'radio' || t === 'çoktan seçmeli' || t === 'coktan secmeli'){
      (q.options || []).forEach(opt => {
        const row = document.createElement('label'); row.className='opt';
        const inp = document.createElement('input'); inp.type='radio'; inp.name=name; inp.value=opt;
        row.appendChild(inp); row.appendChild(document.createTextNode(opt));
        card.appendChild(row);
      });

    } else if (t === 'dropdown' || t === 'select'){
      const row = document.createElement('div'); row.className='opt';
      const sel = document.createElement('select'); sel.name=name;
      (q.options || []).forEach(opt => { const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o); });
      row.appendChild(sel); card.appendChild(row);

    } else if (t === 'text'){
      const row = document.createElement('div'); row.className='opt';
      const inp = document.createElement('input'); inp.type='text'; inp.name=name;
      row.appendChild(inp); card.appendChild(row);

    } else if (t === 'textarea'){
      const row = document.createElement('div'); row.className='opt';
      const ta = document.createElement('textarea'); ta.name=name;
      row.appendChild(ta); card.appendChild(row);

    } else {
      // bilinmeyen tip -> tek satır metin
      const row = document.createElement('div'); row.className='opt';
      const inp = document.createElement('input'); inp.type='text'; inp.name=name;
      row.appendChild(inp); card.appendChild(row);
    }

    root.appendChild(card);
  });

  // 4) Gönder
  actions.style.display = 'block';
  btn.onclick = async () => {
    const answers = {};
    for (let i=0;i<questions.length;i++){
      const q = questions[i];
      const name = `q_${i}`;
      const t = String(q.type||'radio').toLowerCase();
      let val = null;

      if (t==='checkbox'){
        val = [...root.querySelectorAll(`input[name="${name}"]:checked`)].map(x=>x.value);
      } else if (t==='radio' || t==='çoktan seçmeli' || t==='coktan secmeli'){
        const el = root.querySelector(`input[name="${name}"]:checked`);
        val = el ? el.value : null;
      } else if (t==='dropdown' || t==='select'){
        const el = root.querySelector(`select[name="${name}"]`);
        val = el ? el.value : null;
      } else if (t==='text' || t==='textarea'){
        const el = root.querySelector(`[name="${name}"]`);
        val = el ? el.value : null;
      }

      // Zorunlu kontrol
      if (q.required){
        const empty = (val==null) || (Array.isArray(val)&&val.length===0) || (typeof val==='string' && val.trim()==='');
        if (empty){ alert(`${i+1}. soru zorunlu`); return; }
      }

      // Cevabı label anahtarıyla saklayalım
      const key = q.label || q.text || `Soru ${i+1}`;
      answers[key] = val;
    }

    btn.disabled = true;
    try{
      const r = await fetch(`/api/forms/${encodeURIComponent(slug)}/submit`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({answers})
      });
      const j = await r.json().catch(()=> ({}));
      if(j && j.ok){ location.href='/thanks.html'; }
      else{ alert('Kaydetme hatası: ' + (j.error||'bilinmeyen')); btn.disabled=false; }
    }catch(e){
      alert('İstek hatası: '+e.message); btn.disabled=false;
    }
  };
})();
</script>
</body>
</html>
