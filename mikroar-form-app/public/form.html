<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mikroar Form</title>

  <meta property="og:title" content="Mikroar Anket" />
  <meta property="og:description" content="Ankete katılın." />
  <meta property="og:image" content="https://www.emturkey.com.tr/wp-content/uploads/2022/03/em-nedir-resim.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <meta name="facebook-pixel-id" content="753180591019866" />
  <script>
  (function(){
    const pid = document.querySelector('meta[name="facebook-pixel-id"]')?.content;
    if (pid) {
      !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
        n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
        t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script');
      fbq('init', pid);
      fbq('track', 'PageView');
      window.__fbqReady = true;
    }
  })();
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=753180591019866&ev=PageView&noscript=1" />
  </noscript>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fff }
    .wrap { max-width: 760px; margin: 0 auto; padding: 16px; }
    #skeleton { display:grid; grid-template-columns:1fr; gap:10px; }
    .srow { height:18px; background:#f3f4f6; border-radius:8px; }
    #error { display:none; color:#b00020; background:#fff7f7; border:1px solid #ffd3d3; padding:10px 12px; border-radius:10px; }

    /* liste görünümü */
    #list { list-style:none; padding:0; margin:16px 0; display:flex; flex-wrap:wrap; gap:12px; }
    #list li { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; min-width:280px; display:flex; justify-content:space-between; align-items:center; }
    #list a.btn { background:#111; color:#fff; padding:6px 10px; border-radius:8px; text-decoration:none; font-size:13px; }
    .badge{font-size:11px;padding:2px 6px;border-radius:999px;background:#d1fae5;color:#065f46;margin-top:6px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="error"></div>

    <!-- bu iskelet sadece TEKİL FORM modunda görünecek -->
    <div id="skeleton">
      <div class="srow" style="width:60%"></div>
      <div class="srow" style="width:90%"></div>
      <div class="srow" style="width:75%"></div>
    </div>

    <!-- tekil form buraya render edilecek -->
    <div id="app"></div>

    <!-- liste modu buraya render edilecek -->
    <ul id="list" style="display:none"></ul>
  </div>

  <script>
    // URL’de slug/k/f/... var mı?
    function hasIdent(){
      const u = new URL(location.href);
      if (u.searchParams.get("slug") || u.searchParams.get("k")) return true;
      if (/^\/f\//i.test(location.pathname)) return true;
      return false;
    }

    (async function(){
      if (hasIdent()) {
        // eski davranış: formu getir
        var s = document.createElement('script');
        s.src = '/app.js';
        s.defer = true;
        document.body.appendChild(s);
        return;
      }

      // BURASI YENİ: listeyi göster
      const listEl = document.getElementById('list');
      const err = document.getElementById('error');
      const sk = document.getElementById('skeleton');

      // iskeleti gizle, çünkü liste modundayız
      sk.style.display = 'none';
      listEl.style.display = 'flex';

      try {
        const r = await fetch('https://anket.mikroar.com/forms-list', { headers:{accept:'application/json'} });
        const text = await r.text();
        const data = text ? JSON.parse(text) : [];

        if (!Array.isArray(data) || data.length === 0) {
          listEl.innerHTML = '<li>Henüz form yok veya listeye erişim yok.</li>';
          return;
        }

        listEl.innerHTML = data.map(it => {
          const title = it.title || it.slug || 'Adsız form';
          const slug = it.slug;
          return `<li>
            <div>
              <div>${title}</div>
              <span class="badge">${slug}</span>
            </div>
            <a class="btn" href="/form.html?slug=${encodeURIComponent(slug)}">Aç</a>
          </li>`;
        }).join('');
      } catch(e){
        err.textContent = 'Liste yüklenemedi. (forms-list)';
        err.style.display = 'block';
      }
    })();
  </script>

  <!-- submit / pixel interceptor aynı kalsın -->
  <script>
  (function(){
    function trackLead() {
      try { if (typeof fbq === 'function') fbq('track','Lead',{content_name:'MikroAR Anket',status:'submitted'}); } catch(e){}
    }
    function trackComplete() {
      try {
        if (typeof fbq === 'function') {
          fbq('track','Lead',{value:1});
          fbq('track','CompleteRegistration',{value:1});
        }
      } catch(_e) {}
    }

    document.addEventListener('submit', function(e){
      const form = e.target;
      if (form && form.closest('#app')) {
        setTimeout(trackLead, 100);
      }
    }, true);

    const _fetch = window.fetch;
    window.fetch = async function(){
      const res = await _fetch.apply(this, arguments);
      try {
        const req = arguments[0];
        const url = typeof req === 'string' ? req : req.url;
        const method = (arguments[1]?.method || (typeof req !== 'string' && req.method) || 'GET').toUpperCase();
        if (method === 'POST' && /supabase|responses|insert/i.test(url) && res.ok) {
          trackComplete();
        }
      } catch(_e) {}
      return res;
    };
  })();
  </script>
</body>
</html>
