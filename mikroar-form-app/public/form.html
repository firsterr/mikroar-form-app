<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  .note{display:none;margin:16px 0;padding:12px;border-radius:8px}
  .note.err{display:block;background:#ffe8e8;color:#b00020;border:1px solid #f3c5c5}
  .note.warn{display:block;background:#fff5da;color:#6b5100;border:1px solid #f1e2b3}
  .note.ok{display:block;background:#e7fff1;color:#0a7d3b;border:1px solid #bdf0cf}
  .row{margin:18px 0}
  label{display:block;font-weight:600;margin-bottom:8px}
  .muted{color:#666;font-size:.95rem}
  .hidden{display:none}
  .fade{opacity:0; transition:opacity .18s ease}
  .fade.show{opacity:1}

  /* Slug seçici */
  .picker{display:none;margin:18px 0;padding:16px;border:1px dashed #cfd6dd;border-radius:12px;background:#f8fafc}
  .picker .controls{display:flex;gap:10px;align-items:center}
  .picker select{flex:1;min-width:240px;padding:10px;border:1px solid #ccd;border-radius:10px}
  .picker button{padding:10px 14px;border-radius:10px;border:1px solid #2d6ef7;background:#2d6ef7;color:#fff;cursor:pointer}
</style>
</head>
<body>
<main class="wrap">
  <!-- Başlık sadece veri geldiğinde gösterilecek -->
  <h1 id="title" class="hidden"></h1>
  <p id="desc" class="muted" style="display:none"></p>

  <!-- Not/uyarı bandı -->
  <p id="alert" class="note"></p>

  <!-- Slug seçici (slug param yoksa görünür) -->
  <div id="picker" class="picker">
    <div class="row">
      <strong>Bir anket seçin</strong>
      <p class="muted" style="margin:6px 0 0">Aşağıdan bir form (slug) seçtiğinizde ilgili anket sayfasına yönlendirilirsiniz.</p>
    </div>
    <div class="controls">
      <select id="slugSel" aria-label="Anket seç">
        <option value="" selected disabled>— Form (slug) seçin —</option>
      </select>
      <button id="btnOpen" type="button">Formu Aç</button>
    </div>
  </div>

  <!-- Form gövdesi -->
  <form id="form" method="POST" action="#" class="fade" style="display:none"></form>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = $('#title');
  const descEl  = $('#desc');
  const alertEl = $('#alert');
  const formEl  = $('#form');

  const pickerEl = $('#picker');
  const slugSel  = $('#slugSel');
  const btnOpen  = $('#btnOpen');

  const API = '/api';
  const slug = new URLSearchParams(location.search).get('slug')
            || location.pathname.replace(/^\/+|\/+$/g,'');

  function showErr(msg){ alertEl.textContent = msg; alertEl.className='note err'; alertEl.style.display='block'; }
  function showWarn(msg){ alertEl.textContent = msg; alertEl.className='note warn'; alertEl.style.display='block'; }
  function showOk(msg){ alertEl.textContent = msg; alertEl.className='note ok'; alertEl.style.display='block'; }
  function hideNote(){ alertEl.style.display='none'; alertEl.className='note'; alertEl.textContent=''; }

  // Basit element üretici
  function mk(name, attrs={}, html=''){
    const el = document.createElement(name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    if (html) el.innerHTML = html;
    return el;
  }

  // Soru çizer
  function drawQuestion(q, idx){
    const type = (q.type || 'text').toLowerCase();
    const name = q.name || `q${idx+1}`;
    const label = q.label || `Soru ${idx+1}`;
    const opts = Array.isArray(q.options) ? q.options : [];

    const row = mk('div', { class:'row' });
    row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required ? ' *' : '')));

    if (type === 'radio' || type === 'checkbox') {
      const g = mk('div');
      opts.forEach((opt,i) => {
        const id = `f_${name}_${i}`;
        const w = mk('div');
        const input = mk('input', { type, id, name, value:opt, ...(q.required && type==='radio' ? {required:''}: {}) });
        if (type === 'checkbox') input.name = name + '[]';
        const lab = mk('label', { for:id }, opt);
        w.appendChild(input); w.appendChild(lab);
        g.appendChild(w);
      });
      row.appendChild(g);
      return row;
    }

    if (type === 'select') {
      const select = mk('select', { id:`f_${name}`, name, ...(q.required ? {required:''} : {}) });
      select.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
      opts.forEach(v => select.appendChild(mk('option',{value:v}, v)));
      row.appendChild(select);
      return row;
    }

    if (type === 'textarea') {
      row.appendChild(mk('textarea', { id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
      return row;
    }

    const itype = (type === 'email') ? 'email' : 'text';
    row.appendChild(mk('input', { type:itype, id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
    return row;
  }

  // ----- SLUG YOKSA: liste getir + yönlendirici -----
  if (!slug) {
    // Seçici görünür olsun
    pickerEl.style.display = 'block';

    // Listeyi çek
    fetch(`${API}/forms-list`)
      .then(r => r.json())
      .then(j => {
        if (!j.ok) throw new Error(j.error || `HTTP ${r.status}`);
        const items = (j.forms || []);
        // boşsa bilgi göster
        if (!items.length) {
          showWarn('Listelenecek form bulunamadı.');
          return;
        }
        // seçenekleri doldur
        items.forEach(f => {
          const s = f.slug;
          const t = f.title || (f.schema && f.schema.title) || s;
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = `${t} — ${s}`;
          slugSel.appendChild(opt);
        });
      })
      .catch(e => showErr(e.message || 'Liste alınamadı'));

    // Aç butonu → /form.html?slug=SELECTED
    btnOpen.addEventListener('click', () => {
      const s = slugSel.value;
      if (!s) { showWarn('Lütfen bir form seçin.'); return; }
      location.href = `/form.html?slug=${encodeURIComponent(s)}`;
    });

    // Slug yoksa bu noktada form çizimi yapılmaz; return.
    return;
  }

  // ----- SLUG VARSA: formu yükle -----

  // Fallback (JS kapalıysa bile çalışsın)
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Şemayı yükle
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || 'Form bulunamadı');
      const s = j.schema;

      // Başlık sadece başarıyla doldur
      titleEl.textContent = s.title || slug;
      titleEl.classList.remove('hidden');

      if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; }

      const qs = s.questions || s.fields || [];
      formEl.innerHTML = '';
      if (!qs.length){
        showWarn('Bu formda soru tanımı bulunamadı.');
      } else {
        hideNote();
        qs.forEach((q,i) => formEl.appendChild(drawQuestion(q,i)));
        const btn = mk('button', { type:'submit' }, 'Gönder');
        formEl.appendChild(btn);

        // yumuşak açılış
        formEl.style.display = 'block';
        requestAnimationFrame(() => formEl.classList.add('show'));
      }
    })
    .catch(e => {
      titleEl.textContent = 'Form yüklenemedi';
      titleEl.classList.remove('hidden');
      showErr(e.message || 'Hata');
    });

  // Submit (Madde #2: 409 için IP uyarısı)
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    // answers
    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/\[\]$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });
      const j = await r.json().catch(()=>({}));

      if (r.status === 409 || j.alreadySubmitted) {
        const when = j.at ? ` (${new Date(j.at).toLocaleString()})` : '';
        showWarn('Bu IP ile zaten yanıt gönderilmiş.' + when);
        if (btn) btn.disabled = false;
        return;
      }

      if (r.ok && j.ok){
        showOk('Gönderildi, teşekkürler!');
        formEl.reset();
      }else{
        showErr(j?.data?.message || j?.error || `Hata: ${r.status}`);
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
