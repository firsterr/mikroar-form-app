<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anket</title>
<link rel="stylesheet" href="/form.css">
<style>
  .note{display:none;margin:16px 0;padding:12px;border-radius:8px}
  .note.ok{display:block;background:#eaf7ee;color:#11611f}
  .note.err{display:block;background:#fde8e8;color:#9b1c1c}
  .warn{background:#fff3cd;color:#664d03;padding:10px;border-radius:8px;margin-top:6px}
  .row{margin:14px 0}
  fieldset{border:0;padding:0;margin:0}
  legend{font-weight:600;margin-bottom:8px}
  button{padding:.6rem 1rem;border-radius:10px;border:0;background:#2563eb;color:#fff}
  #loading{font-size:28px;margin:24px 0}
</style>
</head>
<body>
<main class="container" style="max-width:900px;margin:32px auto;padding:0 16px">
  <h1 id="title">Anket</h1>
  <p id="desc" style="display:none"></p>

  <div id="loading">Yükleniyor...</div>
  <div id="alert" class="note"></div>

  <form id="form" method="POST" action="#">
    <!-- JS ile doldurulacak -->
  </form>
</main>

<script>
// ---- Form (final) ----
const API = "/api";
const $ = (s) => document.querySelector(s);
const formEl  = $("#form");
const titleEl = $("#title");
const descEl  = $("#desc");
const alertEl = $("#alert");
const loadingEl = $("#loading");

let SCHEMA = null;

function showNote(msg, type="ok"){
  alertEl.textContent = msg;
  alertEl.className = "note " + type;
  alertEl.style.display = "block";
}
function hideNote(){ alertEl.style.display = "none"; }

function splitOptions(v){
  return String(v || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
}

function getSlug(){
  const u = new URL(location.href);
  const qSlug = u.searchParams.get("slug");
  if (qSlug) return qSlug;
  const path = location.pathname.replace(/^\/+|\/+$/g,"");
  if (path && path !== "form.html") return path;
  return "";
}

function inputRow(html){
  const div = document.createElement("div");
  div.className = "row";
  div.innerHTML = html;
  formEl.appendChild(div);
}

function drawForm(schema){
  formEl.innerHTML = "";

  const questions = schema.questions || schema.fields || [];
  if (!questions.length){
    showNote("Bu formda soru tanımı bulunamadı.", "err");
    return;
  }

  for (const q of questions){
    const reqStar = q.required ? " *" : "";
    const name = q.name;

    if (q.type === "text" || q.type === "email"){
      inputRow(`
        <label><strong>${q.label || name}${reqStar}</strong></label>
        <input type="${q.type}" name="${name}" ${q.required ? "required" : ""} />
      `);
      continue;
    }

    if (q.type === "textarea"){
      inputRow(`
        <label><strong>${q.label || name}${reqStar}</strong></label>
        <textarea name="${name}" ${q.required ? "required" : ""}></textarea>
      `);
      continue;
    }

    if (q.type === "select"){
      const opts = Array.isArray(q.options) ? q.options : splitOptions(q.options);
      if (!opts.length){
        inputRow(`
          <label><strong>${q.label || name}${reqStar}</strong></label>
          <div class="warn">Bu soru için seçenek tanımlı değil.</div>
          <select name="${name}" ${q.required ? "required" : ""}>
            <option value="">Seçiniz</option>
          </select>
        `);
      } else {
        const optionsHtml = opts.map(o => `<option value="${o}">${o}</option>`).join("");
        inputRow(`
          <label><strong>${q.label || name}${reqStar}</strong></label>
          <select name="${name}" ${q.required ? "required" : ""}>
            <option value="">Seçiniz</option>
            ${optionsHtml}
          </select>
        `);
      }
      continue;
    }

    if (q.type === "radio"){
      const opts = Array.isArray(q.options) ? q.options : splitOptions(q.options);
      if (!opts.length){
        inputRow(`
          <fieldset>
            <legend>${q.label || name}${reqStar}</legend>
            <div class="warn">Bu soru için seçenek tanımlı değil.</div>
          </fieldset>
        `);
      } else {
        const radios = opts.map((o,i)=>`
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
            <input type="radio" name="${name}" value="${o}" ${q.required && i===0 ? "required" : ""} />
            <span>${o}</span>
          </label>
        `).join("");
        inputRow(`
          <fieldset>
            <legend>${q.label || name}${reqStar}</legend>
            ${radios}
          </fieldset>
        `);
      }
      continue;
    }

    if (q.type === "checkbox"){
      const opts = Array.isArray(q.options) ? q.options : splitOptions(q.options);
      if (!opts.length){
        inputRow(`
          <fieldset>
            <legend>${q.label || name}${reqStar}</legend>
            <div class="warn">Bu soru için seçenek tanımlı değil.</div>
          </fieldset>
        `);
      } else {
        const checks = opts.map(o=>`
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
            <input type="checkbox" name="${name}" value="${o}" />
            <span>${o}</span>
          </label>
        `).join("");
        inputRow(`
          <fieldset>
            <legend>${q.label || name}${reqStar}</legend>
            ${checks}
          </fieldset>
        `);
      }
      continue;
    }

    // bilinmeyen tip -> metin
    inputRow(`
      <label><strong>${q.label || name}${reqStar}</strong></label>
      <input type="text" name="${name}" ${q.required ? "required" : ""} />
    `);
  }

  // submit butonu
  const btn = document.createElement("button");
  btn.type = "submit";
  btn.textContent = "Gönder";
  formEl.appendChild(btn);
}

function collectAnswers(schema){
  const out = {};
  const questions = schema.questions || schema.fields || [];

  for (const q of questions){
    if (q.type === "checkbox"){
      const els = [...formEl.querySelectorAll(`input[type="checkbox"][name="${q.name}"]`)];
      out[q.name] = els.filter(e => e.checked).map(e => e.value);
    } else if (q.type === "radio"){
      const el = formEl.querySelector(`input[type="radio"][name="${q.name}"]:checked`);
      out[q.name] = el ? el.value : "";
    } else if (q.type === "select"){
      const el = formEl.querySelector(`select[name="${q.name}"]`);
      out[q.name] = el ? el.value : "";
    } else if (q.type === "textarea"){
      const el = formEl.querySelector(`textarea[name="${q.name}"]`);
      out[q.name] = el ? el.value.trim() : "";
    } else {
      const el = formEl.querySelector(`input[name="${q.name}"]`);
      out[q.name] = el ? el.value.trim() : "";
    }
  }
  return out;
}

(async function init(){
  try{
    const slug = getSlug();
    if (!slug){
      showNote("Form yüklenemedi. URL’de ?slug=… yok.", "err");
      loadingEl.style.display = "none";
      return;
    }

    // progressive enhancement / fallback
    formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
    formEl.method = "POST";

    const r = await fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`);
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || !j.ok || !j.schema) throw new Error(j.error || "Şema alınamadı");

    SCHEMA = j.schema;

    titleEl.textContent = SCHEMA.title || "Anket";
    if (SCHEMA.description){
      descEl.textContent = SCHEMA.description;
      descEl.style.display = "block";
    }

    drawForm(SCHEMA);
    hideNote();
  }catch(err){
    showNote(err.message || "Form yüklenemedi.", "err");
  }finally{
    loadingEl.style.display = "none";
  }
})();

// submit
formEl.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!SCHEMA) return;

  const btn = formEl.querySelector('button[type="submit"]');
  btn.disabled = true;
  hideNote();

  try{
    const slug = getSlug();
    const answers = collectAnswers(SCHEMA);

    const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ answers })
    });

    const j = await res.json().catch(()=> ({}));
    if (res.ok && j.ok){
      showNote("Gönderildi, teşekkürler!", "ok");
      formEl.reset();
    }else{
      showNote(j?.data?.message || j?.error || `Hata: ${res.status}`, "err");
    }
  }catch(err){
    showNote("Bağlantı hatası: " + err.message, "err");
  }finally{
    btn.disabled = false;
  }
});
</script>
</body>
</html>
