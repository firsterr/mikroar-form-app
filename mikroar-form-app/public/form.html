<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <!-- Başlık/açıklama başlangıçta gizli -->
    <h1 id="title" style="display:none"></h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <!-- Form DOM’a çizilinceye kadar gizli -->
    <form id="form" novalidate hidden></form>
  </main>

<script>
(() => {
  const API = '/api';
  const $   = (s) => document.querySelector(s);

  const formEl  = $("#form");
  const titleEl = $("#title");
  const descEl  = $("#desc");
  const alertEl = $("#alert");

  // slug: ?slug=… yoksa path ( /formayvalik ) kullan
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    titleEl.textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // JS kapalıyken de çalışsın
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // ---------- ŞEMA NORMALİZASYONU ----------
  function optType(t){
    const x = String(t||'text').toLowerCase();
    return ['text','email','textarea','radio','checkbox'].includes(x) ? x : 'text';
  }
  function mapQ(q, i){
    const type = optType(q.type);
    return {
      name    : q.name || `q_${i}`,
      label   : q.label || `Soru ${i+1}`,
      required: !!q.required,
      type,
      options : (type==='radio' || type==='checkbox') ? (q.options||[]).map(String) : undefined
    };
  }
  function asArray(x){
    // dizi ise direkt
    if (Array.isArray(x)) return x;
    // {q_0:{…}, q_1:{…}} benzeri nesne ise anahtarlarına göre sırala
    if (x && typeof x === 'object') {
      const keys = Object.keys(x).sort((a,b)=> {
        const na = (a.match(/\d+/)||[0])[0]|0;
        const nb = (b.match(/\d+/)||[0])[0]|0;
        return na-nb || a.localeCompare(b);
      });
      return keys.map(k => x[k]);
    }
    return [];
  }
  function normalizeFields(schema) {
    if (!schema) return [];

    // 1) fields
    if (Array.isArray(schema.fields)) {
      return schema.fields.map(mapQ);
    }

    // 2) questions (array veya q_ map)
    if (schema.questions) {
      return asArray(schema.questions).map(mapQ);
    }

    // 3) items dizisi
    if (Array.isArray(schema.items)) {
      return schema.items.map(mapQ);
    }

    // 4) schema doğrudan dizi ise
    if (Array.isArray(schema)) {
      return schema.map(mapQ);
    }

    // 5) root’ta q_… anahtarları varsa
    const qKeys = Object.keys(schema||{}).filter(k => /^q[_-]?\d+/i.test(k));
    if (qKeys.length) {
      const arr = asArray(schema);
      return arr.map(mapQ);
    }

    // 6) fallback: yok
    return [];
  }
  // -----------------------------------------

  // Şemayı getir ve çiz
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || "Şema alınamadı");
      const schema = j.schema;
      const fields = normalizeFields(schema);
      console.debug('Form schema (raw):', schema);
      console.debug('Normalized fields:', fields);

      titleEl.textContent = schema.title || `Form: ${slug}`;
      if (schema.description) {
        descEl.textContent = schema.description;
        descEl.style.display = "block";
      }

      formEl.innerHTML = "";
      let inputCount = 0;

      fields.forEach((f, idx) => {
        const row = document.createElement("div");
        row.className = "row";
        const id  = `fld_${f.name || ('q_'+idx)}`;
        const req = f.required ? "required" : "";

        let control = '';
        if (f.type === 'textarea') {
          control = `<textarea id="${id}" name="${f.name}" ${req}></textarea>`;
          inputCount++;
        } else if (f.type === 'radio' || f.type === 'checkbox') {
          const type = f.type;
          const group = (f.options || []).map((opt, i) => {
            const oid = `${id}_${i}`;
            return `<label style="display:flex;gap:8px;align-items:center;margin:4px 0">
                      <input id="${oid}" type="${type}" name="${f.name}" value="${opt}">
                      <span>${opt}</span>
                    </label>`;
          }).join('');
          control = group || `<em>Seçenek bulunmuyor</em>`;
          if (group) inputCount++;
        } else {
          control = `<input id="${id}" type="${f.type || 'text'}" name="${f.name}" ${req} />`;
          inputCount++;
        }

        row.innerHTML = `<label for="${id}">${f.label || f.name}${f.required ? " *" : ""}</label>${control}`;
        formEl.appendChild(row);
      });

      if (!inputCount) {
        const msg = "Bu formda soru tanımı bulunamadı.";
        alertEl.className = "err";
        alertEl.textContent = msg;
        alertEl.style.display = "block";
        throw new Error(msg);
      }

      const btn = document.createElement("button");
      btn.type = "submit";
      btn.textContent = "Gönder";
      formEl.appendChild(btn);
    })
    .catch(e => {
      if (!titleEl.textContent) titleEl.textContent = "Form yüklenemedi.";
      alertEl.className = "err";
      alertEl.textContent = e.message || "Hata";
      alertEl.style.display = "block";
    });

  // Submit
  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    alertEl.style.display = "none";

    const answers = Object.fromEntries(new FormData(formEl).entries());
    if (!Object.keys(answers).length) {
      alertEl.className = "err";
      alertEl.textContent = "Gönderilecek cevap bulunamadı (soru yok).";
      alertEl.style.display = "block";
      if (btn) btn.disabled = false;
      return;
    }

    try {
      const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method : "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body   : JSON.stringify({ answers })
      });
      const j = await res.json().catch(() => ({}));

      if (res.status === 409 || j.code === '23505' || j.alreadySubmitted) {
        alertEl.className = "err";
        alertEl.textContent = "Bu formu zaten doldurmuş görünüyorsunuz.";
        alertEl.style.display = "block";
      } else if (res.ok && j.ok) {
        alertEl.className = "ok";
        alertEl.textContent = "Gönderildi, teşekkürler!";
        alertEl.style.display = "block";
        formEl.reset();
      } else {
        alertEl.className = "err";
        alertEl.textContent = j?.data?.message || j?.error || `Hata: ${res.status}`;
        alertEl.style.display = "block";
      }
    } catch (err) {
      alertEl.className = "err";
      alertEl.textContent = "Bağlantı hatası: " + err.message;
      alertEl.style.display = "block";
    } finally {
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
