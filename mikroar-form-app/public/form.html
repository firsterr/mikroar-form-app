<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <!-- Başlık/açıklama başlangıçta gizli -->
    <h1 id="title" style="display:none"></h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <!-- Form DOM’a çizilinceye kadar gizli -->
    <form id="form" novalidate hidden></form>
  </main>

<script>
(() => {
  const VERSION = 'FORM LOADER V8';
  console.log(VERSION);

  const API = '/api';
  const $   = (s) => document.querySelector(s);

  const formEl  = $("#form");
  const titleEl = $("#title");
  const descEl  = $("#desc");
  const alertEl = $("#alert");

  // slug: ?slug=… yoksa path ( /formayvalik ) kullan
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    titleEl.textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // JS kapalıyken de POST çalışsın
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // ---------- yardımcılar ----------
  const tryParse = (x) => {
    if (typeof x === 'string') { try { return JSON.parse(x); } catch { return x; } }
    return x;
  };

  const get = (obj, paths) => {
    for (const p of paths) {
      const parts = p.split('.');
      let cur = obj, ok = true;
      for (const k of parts) {
        if (Array.isArray(cur)) cur = cur[0];             // kökte dizi ise ilkini al
        if (cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
        else { ok = false; break; }
      }
      if (ok && cur != null) return cur;
    }
    return undefined;
  };

  const ensureArray = (x) => {
    x = tryParse(x);
    if (Array.isArray(x)) return x;
    if (x && typeof x === 'object') {
      const keys = Object.keys(x).sort((a,b) => {
        const na = (a.match(/\d+/)||[0])[0]|0;
        const nb = (b.match(/\d+/)||[0])[0]|0;
        return na-nb || a.localeCompare(b);
      });
      return keys.map(k => x[k]);
    }
    return [];
  };

  const normType = (t) => {
    const s = String(t || 'text').toLowerCase();
    if (['text','email','textarea','radio','checkbox'].includes(s)) return s;
    if (['select','dropdown','choice'].includes(s)) return 'radio';
    if (['longtext','paragraph'].includes(s)) return 'textarea';
    return 'text';
  };

  const mapField = (q, i) => {
    q = tryParse(q) || {};
    const name =
      q.name || q.key || q.id || `q_${i}`;

    const label =
      q.label || q.title || q.question || q.text || `Soru ${i+1}`;

    const required = !!(q.required || q.required_flag);

    let options = q.options || q.choices || q.items;
    options = Array.isArray(options) ? options.map(String)
             : (options ? ensureArray(options).map(String) : undefined);

    const type = normType(q.type);

    return { name, label, required, type, options };
  };

  function normalize(j) {
    // kökte dizi geldiyse ilk elemanı kök kabul et
    const root = Array.isArray(j) ? j[0] : j;

    // muhtemel schema konumları
    let schema =
      get(root, ['schema', 'form.schema', 'data.schema']) ??
      tryParse(get(root, ['row.schema', 'record.schema']));

    schema = tryParse(schema);

    // meta
    const title =
      get(root, ['title','form.title']) ??
      get(schema || {}, ['title','meta.title']);

    const description =
      get(root, ['description','form.description']) ??
      get(schema || {}, ['description','meta.description']);

    // alan listesi muhtemel yollar
    let fields =
      get(schema || {}, ['fields','questions','items']) ??
      get(root,   ['fields','questions','items']);

    if (!fields && schema) {
      // q_0, q_1 ... biçimi
      const keys = Object.keys(tryParse(schema) || {}).filter(k => /^q[_-]?\d+/i.test(k));
      if (keys.length) fields = keys.sort().map(k => schema[k]);
    }

    if (!fields && root) {
      const keys = Object.keys(root || {}).filter(k => /^q[_-]?\d+/i.test(k));
      if (keys.length) fields = keys.sort().map(k => root[k]);
    }

    fields = ensureArray(fields).map(mapField);

    return { title, description, fields, raw: root, full: j };
  }
  // ---------- /yardımcılar ----------

  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      window.__FORM_DEBUG__ = j;               // teşhis için
      const n = normalize(j);

      titleEl.textContent = n.title || `Form: ${slug}`;
      if (n.description) { descEl.textContent = n.description; descEl.style.display = 'block'; }

      formEl.innerHTML = '';
      let inputCount = 0;

      n.fields.forEach((f, idx) => {
        const id  = `fld_${f.name || ('q_'+idx)}`;
        const req = f.required ? 'required' : '';
        const row = document.createElement('div');
        row.className = 'row';

        let control = '';
        if (f.type === 'textarea') {
          control = `<textarea id="${id}" name="${f.name}" ${req}></textarea>`;
          inputCount++;
        } else if (f.type === 'radio' || f.type === 'checkbox') {
          const opts = (f.options || []).map((opt, i) => {
            const oid = `${id}_${i}`;
            return `<label style="display:flex;gap:8px;align-items:center;margin:4px 0">
                      <input id="${oid}" type="${f.type}" name="${f.name}" value="${opt}">
                      <span>${opt}</span>
                    </label>`;
          }).join('');
          control = opts || `<em>Seçenek yok</em>`;
          if (opts) inputCount++;
        } else {
          control = `<input id="${id}" type="${f.type || 'text'}" name="${f.name}" ${req} />`;
          inputCount++;
        }

        row.innerHTML = `<label for="${id}">${f.label}${f.required ? ' *' : ''}</label>${control}`;
        formEl.appendChild(row);
      });

      if (!inputCount) {
        alertEl.className = 'err';
        alertEl.textContent = 'Bu formda soru tanımı bulunamadı.';
        alertEl.style.display = 'block';
        // gözle teşhis kolay olsun diye ilk 1-2 anahtar adı yaz
        console.warn('FORM DEBUG KEYS:', Object.keys(Array.isArray(j)?j[0]:j));
        return;
      }

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.textContent = 'Gönder';
      formEl.appendChild(btn);
    })
    .catch(e => {
      if (!titleEl.textContent) titleEl.textContent = 'Form yüklenemedi.';
      alertEl.className = 'err';
      alertEl.textContent = e.message || 'Hata';
      alertEl.style.display = 'block';
    });

  // Submit
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    alertEl.style.display = 'none';

    const answers = Object.fromEntries(new FormData(formEl).entries());
    if (!Object.keys(answers).length) {
      alertEl.className = 'err';
      alertEl.textContent = 'Gönderilecek cevap bulunamadı (soru yok).';
      alertEl.style.display = 'block';
      if (btn) btn.disabled = false;
      return;
    }

    try {
      const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method : 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body   : JSON.stringify({ answers })
      });
      const j = await res.json().catch(()=> ({}));

      if (res.status === 409 || j.code === '23505' || j.alreadySubmitted) {
        alertEl.className = 'err';
        alertEl.textContent = 'Bu formu zaten doldurmuş görünüyorsunuz.';
        alertEl.style.display = 'block';
      } else if (res.ok && j.ok) {
        alertEl.className = 'ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'err';
        alertEl.textContent = j?.data?.message || j?.error || `Hata: ${res.status}`;
        alertEl.style.display = 'block';
      }
    } catch (err) {
      alertEl.className = 'err';
      alertEl.textContent = 'Bağlantı hatası: ' + err.message;
      alertEl.style.display = 'block';
    } finally {
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
