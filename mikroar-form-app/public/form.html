<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  .note{display:none;margin:16px 0;padding:12px;border-radius:8px}
  .note.err{display:block;background:#ffe8e8;color:#b00020;border:1px solid #f3c5c5}
  .note.warn{display:block;background:#fff5da;color:#6b5100;border:1px solid #f1e2b3}
  .note.ok{display:block;background:#e7fff1;color:#0a7d3b;border:1px solid #bdf0cf}
  .row{margin:18px 0}
  label{display:block;font-weight:600;margin-bottom:8px}
  .muted{color:#666;font-size:.95rem}
  .inline{display:flex;gap:8px;align-items:center}
  select.inline-input{flex:1;padding:10px;border:1px solid #ccd;border-radius:8px}
  button.primary{padding:10px 14px;border-radius:10px;border:1px solid #2d6ef7;background:#2d6ef7;color:#fff;cursor:pointer}
</style>
</head>
<body>
<main class="wrap">
  <h1 id="title">Yükleniyor…</h1>
  <p id="desc" class="muted" style="display:none"></p>
  <p id="alert" class="note err" style="display:none"></p>

  <!-- SLUG YOKKEN LISTE -->
  <section id="pickWrap" style="display:none">
    <p id="listWarn" class="note warn" style="display:none">Listelenecek form bulunamadı.</p>
    <div class="inline">
      <label for="pickSelect" style="margin:0;min-width:140px">Bir anket seçin</label>
      <select id="pickSelect" class="inline-input">
        <option value="">— Form (slug) seçin —</option>
      </select>
      <button id="pickBtn" type="button" class="primary">Formu Aç</button>
    </div>
  </section>

  <!-- SLUG VARSA FORM -->
  <form id="form" method="POST" action="#" style="display:none"></form>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = $('#title');
  const descEl  = $('#desc');
  const alertEl = $('#alert');
  const formEl  = $('#form');

  // Liste elemanları
  const pickWrap = $('#pickWrap');
  const pickSel  = $('#pickSelect');
  const pickBtn  = $('#pickBtn');
  const listWarn = $('#listWarn');

  const slug = new URLSearchParams(location.search).get('slug') || location.pathname.replace(/^\/+|\/+$/g,'');
  const API = '/api';

  function showErr(msg){ alertEl.textContent = msg; alertEl.className='note err'; alertEl.style.display='block'; }
  function showWarn(msg){ alertEl.textContent = msg; alertEl.className='note warn'; alertEl.style.display='block'; }
  function showOk(msg){ alertEl.textContent = msg; alertEl.className='note ok'; alertEl.style.display='block'; }
  function hideNote(){ alertEl.style.display='none'; }

  // --- SLUG YOKSA LİSTEYİ GETİR ---
  async function loadList(){
    hideNote();
    titleEl.textContent = 'Bir anket seçin';
    descEl.style.display = 'none';
    pickWrap.style.display = 'block';
    pickSel.disabled = true; pickBtn.disabled = true;

    try{
      const r = await fetch(`${API}/forms-list`);
      const j = await r.json().catch(()=>({}));
      const items = (j && j.ok && Array.isArray(j.items)) ? j.items : [];

      pickSel.innerHTML = '<option value="">— Form (slug) seçin —</option>';

      if (items.length === 0){
        listWarn.textContent = 'Listelenecek form bulunamadı.';
        listWarn.style.display = 'block';
      } else {
        listWarn.style.display = 'none';
        items.forEach(it => {
          const o = document.createElement('option');
          o.value = it.slug;
          o.textContent = `${it.title || it.slug} — ${it.slug}`;
          pickSel.appendChild(o);
        });
      }
    } catch(e){
      listWarn.textContent = 'Liste alınamadı: ' + e.message;
      listWarn.style.display = 'block';
    } finally {
      pickSel.disabled = false; pickBtn.disabled = false;
    }
  }

  pickBtn?.addEventListener('click', () => {
    const v = pickSel.value;
    if (!v) { pickSel.focus(); return; }
    location.href = `${location.pathname}?slug=${encodeURIComponent(v)}`;
  });
  pickSel?.addEventListener('change', () => {
    if (pickSel.value) pickBtn.click();
  });

  // SLUG VARSA FORMU YÜKLE; YOKSA LİSTEYİ AÇ
  if (!slug) { loadList(); return; }

  // Fallback action
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Helpers
  function mk(name, attrs={}, html=''){
    const el = document.createElement(name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    if (html) el.innerHTML = html;
    return el;
  }

  function drawQuestion(q, idx){
    const type = (q.type || 'text').toLowerCase();
    const name = q.name || `q${idx+1}`;
    const label = q.label || `Soru ${idx+1}`;
    const opts = Array.isArray(q.options) ? q.options : [];

    const row = mk('div', { class:'row' });
    row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required ? ' *' : '')));

    if (type === 'radio' || type === 'checkbox') {
      if (!opts.length){ row.appendChild(mk('div',{},'<div class="muted">Bu soru için seçenek tanımlı değil.</div>')); return row; }
      const g = mk('div');
      opts.forEach((opt,i) => {
        const id = `f_${name}_${i}`;
        const w = mk('div');
        const input = mk('input', { type, id, name, value:String(opt), ...(q.required && type==='radio' ? {required:''}: {}) });
        if (type === 'checkbox') input.name = name + '[]';
        const lab = mk('label', { for:id }, String(opt));
        w.appendChild(input); w.appendChild(lab);
        g.appendChild(w);
      });
      row.appendChild(g);
      return row;
    }

    if (type === 'select') {
      const select = mk('select', { id:`f_${name}`, name, ...(q.required ? {required:''} : {}) });
      select.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
      if (!opts.length){
        row.appendChild(mk('div', { class:'note warn' }, 'Bu soru için seçenek tanımlı değil.'));
      } else {
        opts.forEach(v => select.appendChild(mk('option',{value:String(v)}, String(v))));
      }
      row.appendChild(select);
      return row;
    }

    if (type === 'textarea') {
      row.appendChild(mk('textarea', { id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
      return row;
    }

    const itype = (type === 'email') ? 'email' : 'text';
    row.appendChild(mk('input', { type:itype, id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
    return row;
  }

  // ŞEMA YÜKLE
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || 'Form bulunamadı');
      const s = j.schema;

      titleEl.textContent = s.title || slug;
      if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; }

      const qs = s.questions || s.fields || [];
      formEl.innerHTML = '';
      if (!qs.length){
        showErr('Bu formda soru tanımı bulunamadı.');
      } else {
        hideNote();
        qs.forEach((q,i) => formEl.appendChild(drawQuestion(q,i)));
        const btn = mk('button', { type:'submit', class:'primary' }, 'Gönder');
        formEl.appendChild(btn);
        formEl.style.display = 'block';
      }
    })
    .catch(e => {
      titleEl.textContent = 'Form yüklenemedi';
      showErr(e.message || 'Hata');
    });

  // GÖNDER
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/\[\]$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });
      const j = await r.json().catch(()=>({}));
      if (r.ok && j.ok){
        showOk('Gönderildi, teşekkürler!');
        formEl.reset();
      }else{
        showErr(j?.data?.message || j?.error || `Hata: ${r.status}`);
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
