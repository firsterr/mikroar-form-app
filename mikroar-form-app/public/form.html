<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <main>
    <h1 id="form-title">Yükleniyor…</h1>
    <p id="form-desc" class="form-desc" style="display:none"></p>

    <div id="alert" style="display:none"></div>

    <form id="dynForm" novalidate></form>
  </main>

<script>
(async () => {
  const h1 = document.querySelector('#form-title');
  const pDesc = document.querySelector('#form-desc');
  const form = document.querySelector('#dynForm');
  const alertBox = document.querySelector('#alert');

  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');

  function showErr(msg) {
    alertBox.className = 'err';
    alertBox.textContent = msg;
    alertBox.style.display = 'block';
  }
  function showOk(msg) {
    alertBox.className = 'ok';
    alertBox.textContent = msg;
    alertBox.style.display = 'block';
  }

  if (!slug) {
    h1.textContent = 'Form bulunamadı (slug yok)';
    showErr('URL’de ?slug=... parametresi gerekli. Örn: form.html?slug=formayvalik');
    return;
  }

  // Şemayı çek
  let schema;
  try {
    // redirect ile forms fonksiyonuna gider
    const res = await fetch(`/api/forms/${encodeURIComponent(slug)}`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Şema alınamadı (${res.status})`);
    const json = await res.json();
    if (!json.ok || !json.schema) throw new Error('Geçersiz şema cevabı');
    schema = json.schema;
  } catch (e) {
    h1.textContent = 'Form yüklenemedi.';
    showErr(e.message);
    return;
  }

  // Başlık / açıklama
  document.title = schema.title || 'Anket';
  h1.textContent = schema.title || slug;
  if (schema.description) {
    pDesc.style.display = 'block';
    pDesc.textContent = schema.description;
  }

  // Alanları çiz
  form.innerHTML = '';
  (schema.fields || []).forEach(f => {
    const wrap = document.createElement('div');
    wrap.className = 'row';

    const label = document.createElement('label');
    label.setAttribute('for', f.name);
    label.textContent = f.label || f.name;

    let el;
    if (f.type === 'textarea') {
      el = document.createElement('textarea');
      el.rows = f.rows || 4;
    } else {
      el = document.createElement('input');
      el.type = f.type || 'text';
    }
    el.id = f.name;
    el.name = f.name;
    if (f.required) el.required = true;
    if (f.placeholder) el.placeholder = f.placeholder;

    wrap.appendChild(label);
    wrap.appendChild(el);
    form.appendChild(wrap);
  });

  // Gönder butonu
  const btnRow = document.createElement('div');
  btnRow.className = 'row';
  const btn = document.createElement('button');
  btn.type = 'submit';
  btn.textContent = 'Gönder';
  btnRow.appendChild(btn);
  form.appendChild(btnRow);

  // Submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertBox.style.display = 'none';

    // Browser yerleşik validasyonu
    if (!form.reportValidity()) return;

    // Cevapları topla
    const fd = new FormData(form);
    const answers = Object.fromEntries(fd.entries());

    btn.disabled = true;
    btn.textContent = 'Gönderiliyor…';

    try {
      const res = await fetch('/api/submit-form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          form_slug: slug,
          answers
          // istersen extra alanlar: ip, slug (kısa link) vs.
        })
      });

      const json = await res.json().catch(() => ({}));
      if (res.ok && json.ok) {
        showOk('Kaydedildi. Teşekkürler!');
        form.reset();
        // window.location.href = '/tesekkurler.html';
      } else {
        const msg = (json && (json.error || json.message)) || `Hata: ${res.status}`;
        showErr(msg);
      }
    } catch (err) {
      showErr('Bağlantı hatası: ' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Gönder';
    }
  });
})();
</script>
</body>
</html>
