<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    .wrap{max-width:920px;margin:40px auto;padding:0 16px}
    h1{font-size:36px;margin:0 0 8px}
    .muted{color:#666}
    .row{margin:22px 0}
    label{display:block;font-weight:600;margin-bottom:8px}
    input[type=text],input[type=email],select,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:10px;font:inherit}
    textarea{min-height:120px}
    button.btn{padding:10px 16px;border-radius:10px;border:1px solid #2d6ef7;background:#2d6ef7;color:#fff;cursor:pointer}
    .note{display:none;margin:16px 0;padding:12px;border-radius:10px;border:1px solid #ccd}
    .note.err{display:block;background:#ffe8e8;color:#b00020;border-color:#f3c5c5}
    .note.warn{display:block;background:#fff5da;color:#6b5100;border-color:#f1e2b3}
    .note.ok{display:block;background:#e7fff1;color:#0a7d3b;border-color:#bdf0cf}
    /* slug seçici kutusu */
    .box{padding:20px;border:1px dashed #d9dee3;border-radius:14px;background:#fafbff}
    .picker{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  </style>
</head>
<body>
  <main class="wrap">
    <h1 id="title">Form</h1>
    <p id="desc" class="muted" style="display:none"></p>
    <p id="alert" class="note"></p>

    <!-- Slug seçici (slug yoksa gösterilecek) -->
    <section id="picker" style="display:none">
      <div id="listWarn" class="note warn" style="display:none">Listelenecek form bulunamadı.</div>
      <div class="box">
        <h2 style="margin:0 0 12px">Bir anket seçin</h2>
        <div class="picker">
          <select id="selSlug">
            <option value="">— Form (slug) seçin —</option>
          </select>
          <button id="btnOpen" class="btn" type="button">Formu Aç</button>
        </div>
      </div>
    </section>

    <!-- Form (slug varsa gösterilecek) -->
    <form id="form" method="POST" action="#" style="display:none"></form>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ---- Helpers
    const $ = (s) => document.querySelector(s);
    const titleEl = $('#title');
    const descEl  = $('#desc');
    const alertEl = $('#alert');
    const formEl  = $('#form');
    const pickerEl = $('#picker');
    const selSlug = $('#selSlug');
    const listWarn = $('#listWarn');

    const API = '/api';
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug') || '';

    function showNote(kind, msg){
      alertEl.className = 'note ' + kind;
      alertEl.textContent = msg;
      alertEl.style.display = 'block';
    }
    const showErr  = (m)=>showNote('err', m);
    const showWarn = (m)=>showNote('warn', m);
    const showOK   = (m)=>showNote('ok', m);
    function hideNote(){ alertEl.style.display = 'none'; }

    function mk(tag, attrs={}, html=''){
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
      if (html) el.innerHTML = html;
      return el;
    }

    function drawQuestion(q, idx){
      const type  = String(q.type||'text').toLowerCase();
      const name  = q.name || `q${idx+1}`;
      const label = q.label || `Soru ${idx+1}`;
      const opts  = Array.isArray(q.options) ? q.options : [];

      const row = mk('div', { class:'row' });
      row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required?' *':'')));

      if (type === 'radio' || type === 'checkbox') {
        if (!opts.length){
          row.appendChild(mk('div', {}, '<div class="muted">Bu soru için seçenek tanımlı değil.</div>'));
          return row;
        }
        const g = mk('div');
        opts.forEach((opt,i)=>{
          const id = `f_${name}_${i}`;
          const wrap = mk('div');
          const input = mk('input', { type, id, name, value:opt });
          if (q.required && type==='radio') input.required = true;
          if (type === 'checkbox') input.name = name + '[]';
          const lab = mk('label', { for:id }, opt);
          wrap.appendChild(input); wrap.appendChild(lab);
          g.appendChild(wrap);
        });
        row.appendChild(g);
        return row;
      }

      if (type === 'select') {
        const sel = mk('select', { id:`f_${name}`, name });
        if (q.required) sel.required = true;
        sel.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
        if (!opts.length){
          row.appendChild(mk('div', { class:'note warn' }, 'Bu soru için seçenek tanımlı değil.'));
        } else {
          opts.forEach(v => sel.appendChild(mk('option', { value:String(v) }, String(v))));
        }
        row.appendChild(sel);
        return row;
      }

      if (type === 'textarea'){
        const ta = mk('textarea', { id:`f_${name}`, name });
        if (q.required) ta.required = true;
        row.appendChild(ta);
        return row;
      }

      const itype = (type==='email')?'email':'text';
      const inp = mk('input', { type:itype, id:`f_${name}`, name });
      if (q.required) inp.required = true;
      row.appendChild(inp);
      return row;
    }

    async function loadPicker(){
      // slug yoksa: listeden seçtir
      pickerEl.style.display = 'block';
      formEl.style.display = 'none';
      titleEl.textContent = 'Form';
      descEl.style.display = 'none';
      hideNote();

      try{
        const r = await fetch(`${API}/forms-list`, { headers:{ 'Accept':'application/json' }});
        if (!r.ok) throw new Error('not found');
        const j = await r.json();
        const items = Array.isArray(j) ? j : (Array.isArray(j?.data)? j.data : []);
        selSlug.innerHTML = '<option value="">— Form (slug) seçin —</option>';
        if (!items.length){ listWarn.style.display = 'block'; return; }
        listWarn.style.display = 'none';
        items.forEach(it=>{
          const v = it.slug || it.slug_text || it.slug_value || it;
          if (v) selSlug.appendChild(mk('option', { value:v }, v));
        });
      }catch(e){
        listWarn.style.display = 'block';
      }
    }

    async function loadForm(slug){
      pickerEl.style.display = 'none';
      formEl.style.display = 'none';
      hideNote();

      // action fallback
      formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
      formEl.method = 'POST';

      try{
        const r = await fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`, { headers:{ 'Accept':'application/json' }});
        const j = await r.json();
        if (!r.ok || !j?.ok || !j?.schema) throw new Error(j?.error || 'Form bulunamadı');

        const s = j.schema;
        titleEl.textContent = s.title || slug;
        if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; } else { descEl.style.display = 'none'; }

        const qs = s.questions || s.fields || [];
        formEl.innerHTML = '';
        if (!qs.length){
          showErr('Bu formda soru tanımı bulunamadı.');
          return;
        }
        qs.forEach((q,i)=> formEl.appendChild(drawQuestion(q,i)));
        formEl.appendChild(mk('button', { type:'submit', class:'btn' }, 'Gönder'));
        formEl.style.display = 'block';
      }catch(err){
        titleEl.textContent = 'Form';
        showErr(err.message || 'Hata');
      }
    }

    // 409/duplicate'i sarı uyarıya çeviren submit
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideNote();
      const btn = formEl.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;

      const answers = {};
      [...formEl.elements].forEach(el=>{
        if (!el.name) return;
        if (el.type === 'radio'){
          if (el.checked) answers[el.name] = el.value;
        } else if (el.type === 'checkbox'){
          const base = el.name.replace(/\[\]$/, '');
          answers[base] = answers[base] || [];
          if (el.checked) answers[base].push(el.value);
        } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
          answers[el.name] = el.value;
        }
      });

      try{
        const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(new URLSearchParams(location.search).get('slug')||'')}`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ answers })
        });

        let j = null;
        try{ j = await r.json(); }catch{}

        const isDuplicate =
          r.status === 409 ||
          j?.code === 'duplicate' ||
          j?.data?.code === 'duplicate' ||
          /duplicate|already|tekrar/i.test(j?.error || '');

        if (isDuplicate){
          showWarn('Bu anketi daha önce göndermişsiniz. Aynı IP/cihaz için tekrar yanıt kabul edilmiyor.');
          return;
        }

        if (r.ok && j?.ok){
          showOK('Gönderildi, teşekkürler!');
          formEl.reset();
        }else{
          showErr(j?.data?.message || j?.error || `Hata: ${r.status}`);
        }
      }catch(err){
        showErr('Bağlantı hatası: ' + err.message);
      }finally{
        if (btn) btn.disabled = false;
      }
    });

    // buton: seçilen sluga git
    $('#btnOpen').addEventListener('click', ()=>{
      const v = selSlug.value.trim();
      if (!v) return;
      location.href = `/form.html?slug=${encodeURIComponent(v)}`;
    });

    // Başlat
    if (!slug){
      // slug yok → liste ekranı
      loadPicker();
    }else{
      // slug var → formu yükle
      loadForm(slug);
    }
  });
  </script>
</body>
</html>
