<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:860px;margin:40px auto;padding:0 16px}
    h1{font-size:40px;margin-bottom:8px}
    .desc{color:#444;margin:6px 0 18px}
    .note{display:none;margin:16px 0;padding:12px;border-radius:8px}
    .note.ok{background:#eefbea;border:1px solid #9f9;color:#064}
    .note.err{background:#fee;border:1px solid #f99;color:#900}
    .row{margin:18px 0}
    label{display:block;font-weight:700;margin-bottom:8px}
    .hint{color:#666;font-size:14px;margin-top:6px}
    input,textarea,select{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    fieldset{border:0;padding:0}
    .opts label{display:flex;gap:10px;align-items:center;font-weight:400;margin:6px 0}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
<main>
  <h1 id="title">Yükleniyor…</h1>
  <p id="desc" class="desc" style="display:none"></p>
  <div id="alert" class="note"></div>

  <form id="form" novalidate></form>
</main>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");
  const titleEl = $("#title");
  const descEl  = $("#desc");

  function show(msg, type='err'){
    alertEl.textContent = msg;
    alertEl.className = 'note ' + type;
    alertEl.style.display = 'block';
  }
  function hideAlert(){ alertEl.style.display='none'; }

  // slug: ?slug=... yoksa path
  const pathSlug = location.pathname.replace(/^\/+|\/+$/g, "");
  const slug = new URLSearchParams(location.search).get("slug") || (pathSlug && pathSlug!=='form.html' ? pathSlug : '');
  if (!slug){
    titleEl.textContent = "Form yüklenemedi.";
    show("URL’de ?slug=... bulunamadı.");
    return;
  }

  // Fallback (JS kapalıysa bile çalışsın)
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı çek
  let schema;
  try{
    const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`, {cache:'no-store'});
    const j = await r.json().catch(()=> ({}));
    if (!r.ok || !j.ok || !j.schema) throw new Error(j.error || `HTTP ${r.status}`);
    schema = j.schema;
  }catch(e){
    titleEl.textContent = "Form yüklenemedi.";
    show(e.message || "Şema alınamadı.");
    return;
  }

  // Başlık/açıklama
  titleEl.textContent = schema.title || ("Form: " + slug);
  if (schema.description){
    descEl.textContent = schema.description;
    descEl.style.display = 'block';
  }else{
    descEl.style.display = 'none';
  }

  // Alanları çiz
  formEl.innerHTML = "";
  const qs = Array.isArray(schema.questions) ? schema.questions : (schema.fields || []);

  if (!qs.length){
    formEl.innerHTML = `<div class="note err" style="display:block">Bu formda soru tanımı bulunamadı.</div>`;
  }else{
    qs.forEach((q, i) => {
      const row = document.createElement('div');
      row.className = 'row';
      const key = q.name || ('q_'+i);
      const req = q.required ? 'required' : '';

      let inner = '';
      if (q.type === 'textarea'){
        inner = `<textarea name="${key}" ${req}></textarea>`;
      } else if (q.type === 'email' || q.type === 'text'){
        inner = `<input type="${q.type}" name="${key}" ${req} />`;
      } else if (q.type === 'radio'){
        const opts = (q.options || []);
        inner = opts.length
          ? `<fieldset class="opts">` +
            opts.map((opt, j) => `
              <label><input type="radio" name="${key}" value="${opt}" ${req}> <span>${opt}</span></label>
            `).join('') + `</fieldset>`
          : `<div class="hint">Bu soru için seçenek tanımlı değil.</div>`;
      } else if (q.type === 'checkbox'){
        const opts = (q.options || []);
        inner = opts.length
          ? `<fieldset class="opts">` +
            opts.map((opt, j) => `
              <label><input type="checkbox" name="${key}" value="${opt}"> <span>${opt}</span></label>
            `).join('') + `</fieldset>`
          : `<div class="hint">Bu soru için seçenek tanımlı değil.</div>`;
      } else if (q.type === 'select'){
        const opts = (q.options || []);
        inner = opts.length
          ? `<select name="${key}" ${req}>
               <option value="" disabled selected>Seçiniz</option>
               ${opts.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
             </select>`
          : `<div class="hint">Bu soru için seçenek tanımlı değil.</div>`;
      } else {
        inner = `<input type="text" name="${key}" ${req} />`;
      }

      row.innerHTML = `
        <label>${(q.label || ('Soru ' + (i+1))) + (q.required ? ' *' : '')}</label>
        ${inner}
      `;
      formEl.appendChild(row);
    });

    // Gönder butonu
    const bar = document.createElement('div');
    bar.className = 'row';
    bar.innerHTML = `<button type="submit" id="btnSend">Gönder</button>`;
    formEl.appendChild(bar);
  }

  // Submit
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlert();
    const btn = $("#btnSend"); if (btn) btn.disabled = true;

    // Cevapları topla
    const answers = {};
    (Array.isArray(schema.questions) ? schema.questions : (schema.fields || [])).forEach((q, i)=>{
      const key = q.name || ('q_'+i);
      if (q.type === 'checkbox'){
        answers[key] = Array.from(document.querySelectorAll(`[name="${key}"]:checked`)).map(el => el.value);
      } else {
        const el = document.querySelector(`[name="${key}"]`);
        answers[key] = el ? el.value : null;
      }
    });

    try{
      const r = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ answers })
      });
      const j = await r.json().catch(()=> ({}));
      if (r.ok && j.ok){
        show('Gönderildi, teşekkürler!', 'ok');
        formEl.reset();
      }else{
        show(j?.error || j?.data?.message || `Hata: ${r.status}`, 'err');
      }
    }catch(err){
      show('Bağlantı hatası: ' + err.message, 'err');
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
