<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>

  <!-- Senin güncel dış stilin -->
  <link rel="preload" href="/form.css" as="style" fetchpriority="high">
  <link rel="stylesheet" href="/form.css?v=6" />

  <!-- Google Forms etkileşimleri (hafif) -->
  <style>
    /* Üst kart */
    .gf-header{
      background: linear-gradient(180deg,#fff,#fafbff);
      border: 1px solid #e6e7ec;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(17,24,39,.06);
      padding: 22px;
      margin: 24px auto 14px;
    }

    /* Seçenek hover/seçili */
    label.opt{
      padding: 10px 12px;
      border-radius: 10px;
      transition: background .15s ease, box-shadow .15s ease;
      cursor: pointer;
    }
    label.opt:hover{
      background: #f4f6ff;
      box-shadow: 0 0 0 3px rgba(26,115,232,.10) inset;
    }
    /* Modern tarayıcılarda seçili vurgusu */
    label.opt:has(input:checked){
      background: #eef3ff;
      box-shadow: 0 0 0 3px rgba(26,115,232,.20) inset;
    }
    label.opt input{ margin: 0 6px 0 2px; }

    /* Skeleton yalnızca CSR fallback'te (gerekirse) */
    .skeleton{ display:none; padding:16px; }
    .skeleton .bar{ height:14px; margin:10px 0; border-radius:6px; background:linear-gradient(90deg,#eee,#f5f5f5,#eee); }

    /* Slug picker (liste + manuel) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal{
      background:#fff; width:min(720px,92vw); max-height:80vh; overflow:auto;
      border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.25); position:relative;
    }
    .modal h2{ margin:0 0 8px; }
    .modal .search{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    .modal .row-flex{ display:flex; gap:10px; margin-top:10px; }
    .modal .row-flex input{ flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    .modal .row-flex button{ padding:10px 14px; border:none; border-radius:10px; background:#1a73e8; color:#fff; font-weight:600; cursor:pointer; }
    .modal .list{ margin-top:12px; display:grid; gap:8px; }
    .modal .item{ display:flex; justify-content:space-between; align-items:center; gap:8px; border:1px solid #eee; border-radius:12px; padding:10px 12px; cursor:pointer; }
    .modal .item:hover{ background:#fafafa; }
    .modal .slug{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; opacity:.8; }
    .modal .close{ position:absolute; top:10px; right:14px; border:none; background:transparent; font-size:20px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Üst kart: Google Forms başlık alanı -->
    <div class="gf-header">
      <h1 id="title"></h1>
      <p id="desc" class="form-desc"></p>
    </div>

    <!-- Form gövdesi -->
    <form id="form" novalidate></form>

    <!-- Gerekirse kısa skeleton -->
    <div id="skeleton" class="skeleton" aria-hidden="true">
      <div class="bar" style="width:50%"></div>
      <div class="bar" style="width:85%"></div>
      <div class="bar" style="width:70%"></div>
      <div class="bar" style="width:40%"></div>
    </div>

    <p id="alertBottom" class="note center" style="display:none"></p>
  </div>

  <script>
    // ===== Yardımcılar
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const show = el => el && (el.style.display = 'block');
    const hide = el => el && (el.style.display = 'none');
    const esc = s => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    // SSR tespiti: SSR üretildiyse hem window.__FORM vardır hem de <form data-ssr="1">
    const SSR_READY = !!(window.__FORM && document.querySelector('#form[data-ssr="1"]'));

    // --- Başlık/Açıklama için akıllı eşleştirici (TR/EN anahtarlar)
    const T_KEYS = ['title','baslik','başlık','form_title','heading','name','label','subject'];
    const D_KEYS = ['description','aciklama','açıklama','desc','summary','about','note','not'];

    function pickKey(obj, keys){
      if (!obj || typeof obj !== 'object') return null;
      const map = Object.create(null);
      for (const k of Object.keys(obj)) map[k.toLowerCase()] = k;
      for (const want of keys){
        const lk = want.toLowerCase();
        if (lk in map) {
          const v = obj[map[lk]];
          if (v !== undefined && v !== null && String(v).trim() !== '') return String(v);
        }
      }
      return null;
    }

    function extractMeta(form){
      const schema = typeof form?.schema === 'string' ? safeJSON(form.schema) : (form?.schema || {});
      const title = pickKey(form, T_KEYS) || pickKey(schema, T_KEYS) || 'Anket'; // <- slug FALAN YOK
      const desc  = pickKey(form, D_KEYS) || pickKey(schema, D_KEYS) || '';
      return { schema, title, desc };
    }

    function safeJSON(s){
      try { return JSON.parse(s || '{}'); } catch { return {}; }
    }

    // --- Tek soruyu HTML'e çevir
    function qHTML(q){
      const type = (q.type||'text').toLowerCase();
      const name = q.name || q.label || 'q';
      const req  = q.required ? ' required' : '';
      const ph   = q.placeholder ? ` placeholder="${esc(q.placeholder)}"` : '';
      const desc = q.description ? `<div class="muted">${esc(q.description)}</div>` : '';
      let inner = '';

      if (type==='radio' || type==='checkbox') {
        const opts = Array.isArray(q.options)? q.options : [];
        inner = `<div class="options">` + opts.map(v=>{
          const val = esc(String(v));
          const id  = `f_${name}_${val.replace(/\W+/g,'_')}`;
          return `<label class="opt" for="${id}">
                    <input type="${type}" id="${id}" name="${esc(name)}" value="${val}">
                    <span>${val}</span>
                  </label>`;
        }).join('') + `</div>`;
      } else if (type==='select') {
        const opts = Array.isArray(q.options)? q.options : [];
        inner = `<div class="options"><div class="opt">
                  <select id="f_${esc(name)}" name="${esc(name)}"${req}>
                    <option value="" disabled selected>Seçiniz</option>
                    ${opts.map(v=>`<option value="${esc(String(v))}">${esc(String(v))}</option>`).join('')}
                  </select>
                 </div></div>`;
      } else if (type==='textarea') {
        inner = `<textarea id="f_${esc(name)}" name="${esc(name)}"${req}${ph}></textarea>`;
      } else {
        const itype = (type==='email' ? 'email' : type==='number' ? 'number' : 'text');
        inner = `<input type="${itype}" id="f_${esc(name)}" name="${esc(name)}"${req}${ph}/>`;
      }

      return `<div class="row">
                <div class="q-title">
                  <label for="f_${esc(name)}">${esc(q.label||'')}</label>
                  ${q.required ? `<span class="req">*</span>` : ``}
                </div>
                ${desc}
                ${inner}
              </div>`;
    }

    // --- Client-side render
    function renderClient(form){
      const { schema, title, desc } = extractMeta(form);

      // Başlık-açıklama: slug YOK, net
      $('#title').textContent = title;
      if (desc.trim()) { $('#desc').textContent = desc; $('#desc').style.display='block'; }
      else { $('#desc').textContent=''; $('#desc').style.display='none'; }

      const qs = Array.isArray(schema.questions) ? schema.questions : [];
      $('#form').innerHTML =
        qs.map(qHTML).join('') +
        `<div class="actions"><button type="submit" id="btnSend">Gönder</button></div>
         <p class="after center">Bu form <strong>mikroar.com</strong> alanında oluşturuldu.</p>
         <p class="brand">mikroAR</p>`;

      // Safari için :has() yedeği – seçili etikete sınıf ekle
      $$('.opt input').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const p = inp.closest('label.opt');
          if (!p) return;
          if (inp.type === 'radio') {
            $$(`input[type="radio"][name="${inp.name}"]`).forEach(r=>{
              const pr = r.closest('label.opt'); if (pr) pr.classList.toggle('is-checked', r.checked);
            });
          } else {
            p.classList.toggle('is-checked', inp.checked);
          }
        });
      });

      show($('#form'));
    }

    // --- Slug picker (liste + manuel giriş)
   function openSlugPicker(){
  const wrap = document.createElement('div');
  wrap.className = 'modal-backdrop';
  wrap.innerHTML = `
    <div class="modal">
      <button class="close" aria-label="Kapat">&times;</button>
      <h2>Bir form seçin</h2>

      <input type="search" class="search" placeholder="Slug veya başlık ara…" />

      <div class="row-flex">
        <input type="text" id="manualSlug" placeholder="Slug'ı elle girin (ör. ASD)">
        <button id="goBtn">Git</button>
      </div>

      <label style="display:block;margin-top:10px;font-size:12px;opacity:.7">Listeden seç (ilk 200 kayıt)</label>
      <select id="slugSelect" size="8" style="width:100%;margin-top:6px"></select>

      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button id="selectGo" style="padding:8px 12px;border:none;border-radius:10px;background:var(--g-primary);color:#fff;font-weight:600;cursor:pointer">Seç ve Git</button>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);

  const close = () => wrap.remove();
  wrap.querySelector('.close').addEventListener('click', close);
  const go = (slug) => { if (slug) location.href = `/form.html?slug=${encodeURIComponent(slug.trim())}`; };

  const listEl = wrap.querySelector('#slugSelect');
  const searchEl = wrap.querySelector('.search');
  const manual = wrap.querySelector('#manualSlug');
  wrap.querySelector('#goBtn').addEventListener('click', () => go(manual.value));
  manual.addEventListener('keydown', e => { if (e.key === 'Enter') go(manual.value); });
  wrap.querySelector('#selectGo').addEventListener('click', () => go(listEl.value));

  const renderOptions = (items) => {
    listEl.innerHTML = items.map(it => `<option value="${esc(it.slug)}">${esc(it.title || it.slug)}  —  ${esc(it.slug)}</option>`).join('');
  };

  fetch('/api/forms-list', { headers:{'accept':'application/json'} })
    .then(r => r.json())
    .then(j => {
      const items = Array.isArray(j?.items) ? j.items.slice(0, 200) : [];
      if (!items.length) {
        listEl.innerHTML = `<option>Kayıt bulunamadı</option>`;
        listEl.disabled = true;
        return;
      }
      let current = items.slice();
      renderOptions(current);

      searchEl.addEventListener('input', () => {
        const q = searchEl.value.trim().toLowerCase();
        current = items.filter(it =>
          (it.slug || '').toLowerCase().includes(q) ||
          (it.title || '').toLowerCase().includes(q)
        );
        renderOptions(current);
      });
    })
    .catch(() => {
      listEl.innerHTML = `<option>Liste alınamadı</option>`;
      listEl.disabled = true;
    });
}

    // --- Başlat
    async function bootstrap(){
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');

      // slug yoksa seçici
      if (!slug) { openSlugPicker(); return; }

      // SSR varsa: fetch yok; başlık/açıklamayı __FORM’dan yaz
      if (SSR_READY) {
        try {
          const f = window.__FORM || {};
          const { title, desc } = extractMeta(f);
          $('#title').textContent = title;
          if (desc.trim()) { $('#desc').textContent = desc; $('#desc').style.display='block'; }
          show($('#form'));
        } catch { show($('#form')); }
        return;
      }

      // CSR fallback: tek fetch
      // NOT: Skeleton'u ancak yanıt 120ms'ten uzun sürerse göster (algılanan hız için)
      let showTimer = setTimeout(()=> show($('#skeleton')), 120);
      try {
        const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`, { headers:{ 'accept':'application/json' } });
        if (!r.ok) throw new Error('Form bulunamadı');
        let j; try { j = await r.json(); } catch { j = null; }
        const form = (j && (j.form || j.data)) ? (j.form || j.data) : j;
        if (!form || typeof form !== 'object') throw new Error('Geçersiz yanıt (form verisi yok).');

        window.__FORM = form; // app.js submit için
        clearTimeout(showTimer); hide($('#skeleton'));
        renderClient(form);
      } catch (e) {
        clearTimeout(showTimer); hide($('#skeleton'));
        $('#app').innerHTML = `<p class="center">Hata: ${esc(e.message || e)}</p>`;
      }
    }

    bootstrap();
  </script>

  <!-- Submit/teşekkür ekranı (güncel app.js ile) -->
  <script src="/app.js" defer></script>
</body>
</html>
