<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:860px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea,select{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    .opt{display:flex;align-items:center;gap:8px;margin:6px 0}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .note{margin:16px 0;padding:12px;border-radius:8px;border:1px solid #ccd;background:#f7f7f9}
    .err{background:#fee;border:1px solid #f99;color:#900}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064}
    .muted{color:#666;font-size:.95rem}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" class="muted" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const formEl  = $("#form");
  const titleEl = $("#title");
  const descEl  = $("#desc");
  const alertEl = $("#alert");
  const loadingEl = $("#loading"); // varsa

  function hideLoading(){ if (loadingEl) loadingEl.style.display = 'none'; }

  function info(msg){
    const div = document.createElement('div');
    div.className = 'warn';
    div.textContent = msg;
    formEl.appendChild(div);
  }

  function makeRow(html){ const d = document.createElement('div'); d.className='row'; d.innerHTML = html; return d; }

  function render(schema){
    formEl.innerHTML = "";
    titleEl.textContent = schema.title || "";
    if (schema.description) { descEl.textContent = schema.description; descEl.style.display = "block"; }

   for (const q of (schema.questions || schema.fields || [])) {
    if (!qs.length){ info("Bu formda soru tanımı bulunamadı."); return; }

    qs.forEach((q, i) => {
      const name = q.name || `q${i+1}`;
      const req  = q.required ? 'required' : '';
      const label = `<label>${(q.label || ("Soru " + (i+1))).toUpperCase()} ${q.required?'<span class="req">*</span>':''}</label>`;

      if (q.type === 'radio') {
        if (!Array.isArray(q.options) || !q.options.length){ formEl.appendChild(makeRow(`${label}<div>Bu soru için seçenek tanımlı değil.</div>`)); return; }
        const body = q.options.map((opt, j) =>
          `<label class="opt"><input type="radio" name="${name}" value="${opt}" ${req}> <span>${opt}</span></label>`
        ).join('');
        formEl.appendChild(makeRow(`${label}<div class="opts">${body}</div>`));

      } else if (q.type === 'checkbox') {
        if (!Array.isArray(q.options) || !q.options.length){ formEl.appendChild(makeRow(`${label}<div>Bu soru için seçenek tanımlı değil.</div>`)); return; }
        const body = q.options.map((opt, j) =>
          `<label class="opt"><input type="checkbox" name="${name}" value="${opt}" ${req}> <span>${opt}</span></label>`
        ).join('');
        formEl.appendChild(makeRow(`${label}<div class="opts">${body}</div>`));

      } else if (q.type === 'select') {
        if (!Array.isArray(q.options) || !q.options.length){ formEl.appendChild(makeRow(`${label}<div>Bu soru için seçenek tanımlı değil.</div>`)); return; }
        const opts = ['<option value="">Seçiniz</option>']
          .concat(q.options.map(o => `<option value="${o}">${o}</option>`))
          .join('');
        formEl.appendChild(makeRow(`${label}<select name="${name}" ${req}>${opts}</select>`));

      } else if (q.type === 'textarea') {
        formEl.appendChild(makeRow(`${label}<textarea name="${name}" ${req}></textarea>`));
      } else if (q.type === 'email') {
        formEl.appendChild(makeRow(`${label}<input type="email" name="${name}" ${req}>`));
      } else {
        formEl.appendChild(makeRow(`${label}<input type="text" name="${name}" ${req}>`));
      }
    });
<!-- ... form.html içindeki script'te, renderForm() içinde -->
if (q.type === "text") {
  body.innerHTML = `<input type="text" name="${name}" placeholder="Yanıtınız">`;
} else if (q.type === "textarea") {
  body.innerHTML = `<textarea name="${name}" placeholder="Yanıtınız"></textarea>`;
} else if (q.type === "select") {
  const opts = (q.options || []);
  if (!opts.length) {
    body.innerHTML = `<div class="noopt">Bu soru için seçenek tanımlı değil.</div>`;
  } else {
    const optionsHtml = opts.map(o => `<option value="${o}">${o}</option>`).join('');
    body.innerHTML = `
      <select name="${name}">
        <option value="" disabled selected>Seçiniz</option>
        ${optionsHtml}
      </select>`;
  }
} else if (q.type === "checkbox") {
  (q.options || []).forEach((opt, j) => {
    const id = `${name}_${j}`;
    body.insertAdjacentHTML(
      "beforeend",
      `<label class="opt"><input id="${id}" type="checkbox" name="${name}" value="${opt}"><span>${opt}</span></label>`
    );
  });
} else {
  // radio (default)
  (q.options || []).forEach((opt, j) => {
    const id = `${name}_${j}`;
    body.insertAdjacentHTML(
      "beforeend",
      `<label class="opt"><input id="${id}" type="radio" name="${name}" value="${opt}"><span>${opt}</span></label>`
    );
  });
}
    function isAnswered(q, idx) {
  const key = "q_" + idx;
  if (q.type === "checkbox") {
    return document.querySelectorAll(`[name="${key}"]:checked`).length > 0;
  }
  if (q.type === "radio") {
    return !!document.querySelector(`[name="${key}"]:checked`);
  }
  if (q.type === "select") {
    const el = document.querySelector(`[name="${key}"]`);
    return !!(el && el.value && el.value.trim().length);
  }
  const el = document.querySelector(`[name="${key}"]`);
  const v = (el && el.value) ? el.value.trim() : "";
  return v.length > 0;
}
    // submit butonu
    const btn = document.createElement('button');
    btn.type = 'submit'; btn.textContent = 'Gönder'; btn.id='btnSend';
    formEl.appendChild(btn);
  }

  async function boot(){
    const slug = new URLSearchParams(location.search).get('slug');
    if (!slug){ titleEl.textContent = "Form yüklenemedi"; alertEl.className='err'; alertEl.textContent='URL’de ?slug=… yok.'; alertEl.style.display='block'; hideLoading(); return; }

    try{
      const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`);
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || !j.ok || !j.schema){ throw new Error(j.error || `HTTP ${r.status}`); }
      render(j.schema);
    } catch(err){
      titleEl.textContent = "Form yüklenemedi";
      alertEl.className='err';
      alertEl.textContent = err.message || 'Hata';
      alertEl.style.display='block';
    } finally {
      hideLoading();
    }

    // submit
    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = $("#btnSend"); btn.disabled = true;

      const answers = {};
      [...formEl.elements].forEach(el => {
        if (!el.name) return;
        if (el.type === 'checkbox'){
          answers[el.name] = answers[el.name] || [];
          if (el.checked) answers[el.name].push(el.value);
        } else if (el.type === 'radio'){
          if (el.checked) answers[el.name] = el.value;
        } else {
          answers[el.name] = el.value;
        }
      });

      try{
        const res = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`,{
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ answers })
        });
        const j = await res.json().catch(()=> ({}));
        if (res.ok && j.ok){
          alertEl.className='ok'; alertEl.textContent='Gönderildi, teşekkürler!'; alertEl.style.display='block';
          formEl.reset();
        } else {
          alertEl.className='err'; alertEl.textContent = j?.data?.message || j?.error || `Hata: ${res.status}`; alertEl.style.display='block';
        }
      } catch(err){
        alertEl.className='err'; alertEl.textContent = 'Bağlantı hatası: ' + err.message; alertEl.style.display='block';
      } finally { btn.disabled = false; }
    });
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body>
</html>
