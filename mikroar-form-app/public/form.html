<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");

  // slug: ?slug=... yoksa path /formayvalik gibi ise path’i kullan
  const pathSlug = location.pathname.replace(/^\/+|\/+$/g, "");
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.style.display = "block";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=... bulunamadı.";
    return;
  }

  // Fallback: JS çalışmasa bile POST olsun
  formEl.action = "/.netlify/functions/submit-form?form_slug=" + encodeURIComponent(slug);
  formEl.method = "POST";

  // Şemayı çek
  const schRes = await fetch("/.netlify/functions/forms?slug=" + encodeURIComponent(slug));
  const schJson = await schRes.json().catch(() => ({}));
  if (!schRes.ok || !schJson?.ok || !schJson?.schema) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.style.display = "block";
    alertEl.className = "err";
    alertEl.textContent = schJson?.error || ("Hata: " + schRes.status);
    return;
  }

  const schema = schJson.schema;
  $("#title").textContent = schema.title || ("Form: " + slug);
  if (schema.description) { $("#desc").textContent = schema.description; $("#desc").style.display = "block"; }

  // Alanları çiz
  formEl.innerHTML = "";
  (schema.fields || []).forEach((f) => {
    const row = document.createElement("div");
    row.className = "row";
    const id = "fld_" + f.name;

    let control = "";
    if (f.type === "textarea") {
      control = `<textarea id="${id}" name="${f.name}" ${f.required ? "required": ""}></textarea>`;
    } else {
      // text, email, vb.
      control = `<input id="${id}" type="${f.type || "text"}" name="${f.name}" ${f.required ? "required": ""} />`;
    }

    row.innerHTML = `<label for="${id}">${f.label || f.name}${f.required ? " *" : ""}</label>${control}`;
    formEl.appendChild(row);
  });

  // Gönder butonu
  const btn = document.createElement("button");
  btn.type = "submit";
  btn.textContent = "Gönder";
  formEl.appendChild(btn);

  // AJAX submit
  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    alertEl.style.display = "none";

    // form’daki alanları topla -> answers
    const answers = Object.fromEntries(new FormData(formEl).entries());
    const payload = { form_slug: slug, answers };

    try {
      const res = await fetch("/.netlify/functions/submit-form", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(() => ({}));

      if (res.ok && j.ok) {
        alertEl.className = "ok";
        alertEl.textContent = "Gönderildi, teşekkürler!";
        alertEl.style.display = "block";
        formEl.reset();
      } else {
        alertEl.className = "err";
        alertEl.textContent = j?.data?.message || j?.error || ("Hata: " + res.status);
        alertEl.style.display = "block";
      }
    } catch (err) {
      alertEl.className = "err";
      alertEl.textContent = "Bağlantı hatası: " + err.message;
      alertEl.style.display = "block";
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
