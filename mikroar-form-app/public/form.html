<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:860px;margin:40px auto;padding:0 16px}
    .row{margin:18px 0}
    label{display:block;font-weight:700;margin-bottom:8px}
    input,textarea,select{width:100%;padding:12px;border:1px solid #ccd;border-radius:10px;font:inherit}
    .note{padding:12px;border-radius:10px;margin:12px 0}
    .err{background:#fee;border:1px solid #f99;color:#900}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064}
    button{padding:12px 18px;border:0;border-radius:12px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");

  // slug: ?slug=... (path fallback'ı istersen: const pathSlug = location.pathname.replace(/^\/+|\/+$/g,"");)
  const slug = new URLSearchParams(location.search).get("slug");

  if (!slug) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.style.display = "block";
    alertEl.className = "note err";
    alertEl.textContent = "URL’de ?slug=… bulunamadı.";
    return;
  }

  // JS kapalı olsa bile çalışsın (progressive enhancement)
  formEl.action = `/api/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı al
  const res = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`);
  const j = await res.json().catch(() => ({}));
  if (!res.ok || !j.ok || !j.schema) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.style.display = "block";
    alertEl.className = "note err";
    alertEl.textContent = j?.error || ("Hata: " + res.status);
    return;
  }

  const schema = j.schema;
  $("#title").textContent = schema.title || slug;
  if (schema.description && String(schema.description).trim()) {
    $("#desc").textContent = schema.description;
    $("#desc").style.display = "block";
  }

  const questions = Array.isArray(schema.questions) ? schema.questions
                   : (Array.isArray(schema.fields) ? schema.fields : []);

  // Alanları çiz
  formEl.innerHTML = "";
  if (!questions.length) {
    const row = document.createElement("div");
    row.className = "note err";
    row.textContent = "Bu formda soru tanımı bulunamadı.";
    formEl.appendChild(row);
  }

  questions.forEach((q, i) => {
    const row = document.createElement("div");
    row.className = "row";
    const name = q.name || ("q" + (i+1));
    const id   = "fld_" + name;
    const req  = q.required ? "required" : "";

    const label = document.createElement("label");
    label.setAttribute("for", id);
    label.innerHTML = (q.label || name) + (q.required ? " *" : "");
    row.appendChild(label);

    const type = (q.type || "text").toLowerCase();
    const opts = Array.isArray(q.options) ? q.options : [];

    if (type === "textarea") {
      row.insertAdjacentHTML("beforeend",
        `<textarea id="${id}" name="${name}" ${req}></textarea>`);
    } else if (type === "email" || type === "text") {
      row.insertAdjacentHTML("beforeend",
        `<input id="${id}" type="${type}" name="${name}" ${req}>`);
    } else if (type === "radio") {
      if (!opts.length) {
        row.insertAdjacentHTML("beforeend",
          `<div class="note err">Bu soru için seçenek tanımlı değil.</div>`);
      } else {
        const wrap = document.createElement("div");
        opts.forEach((opt, jdx) => {
          const oid = `${id}_${jdx}`;
          wrap.insertAdjacentHTML("beforeend",
            `<label style="display:block;font-weight:400;margin:6px 0">
               <input type="radio" id="${oid}" name="${name}" value="${opt}" ${req}>
               ${opt}
             </label>`);
        });
        row.appendChild(wrap);
      }
    } else if (type === "checkbox") {
      if (!opts.length) {
        row.insertAdjacentHTML("beforeend",
          `<div class="note err">Bu soru için seçenek tanımlı değil.</div>`);
      } else {
        const wrap = document.createElement("div");
        opts.forEach((opt, jdx) => {
          const oid = `${id}_${jdx}`;
          wrap.insertAdjacentHTML("beforeend",
            `<label style="display:block;font-weight:400;margin:6px 0">
               <input type="checkbox" id="${oid}" name="${name}" value="${opt}">
               ${opt}
             </label>`);
        });
        // checkbox'ta required: en az bir seçim kontrolünü submit'te yapacağız
        row.appendChild(wrap);
      }
    } else if (type === "select") {
      if (!opts.length) {
        row.insertAdjacentHTML("beforeend",
          `<div class="note err">Bu soru için seçenek tanımlı değil.</div>`);
      } else {
        const sel = document.createElement("select");
        sel.id = id;
        sel.name = name;
        if (q.required) sel.setAttribute("required", "");
        sel.insertAdjacentHTML("beforeend", `<option value="">Seçiniz</option>`);
        opts.forEach((opt) => {
          sel.insertAdjacentHTML("beforeend", `<option value="${opt}">${opt}</option>`);
        });
        row.appendChild(sel);
      }
    } else {
      // bilinmeyen tür -> text
      row.insertAdjacentHTML("beforeend",
        `<input id="${id}" type="text" name="${name}" ${req}>`);
    }

    formEl.appendChild(row);
  });

  // Gönder
  const btn = document.createElement("button");
  btn.type = "submit";
  btn.textContent = "Gönder";
  formEl.appendChild(btn);

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    alertEl.style.display = "none";

    // required checkbox'lar için basit kontrol: en az bir seçim
    let invalid = false;
    questions.forEach((q, i) => {
      if (q.type === "checkbox" && q.required) {
        const name = q.name || ("q" + (i+1));
        const any = formEl.querySelectorAll(`[name="${name}"]:checked`).length > 0;
        if (!any) invalid = true;
      }
    });
    if (invalid) {
      alertEl.className = "note err";
      alertEl.textContent = "Lütfen tüm zorunlu soruları yanıtlayın.";
      alertEl.style.display = "block";
      btn.disabled = false;
      return;
    }

    // cevapları topla
    const answers = {};
    questions.forEach((q, i) => {
      const name = q.name || ("q" + (i+1));
      if (q.type === "checkbox") {
        answers[name] = Array.from(formEl.querySelectorAll(`[name="${name}"]:checked`)).map(el => el.value);
      } else if (q.type === "radio") {
        const sel = formEl.querySelector(`[name="${name}"]:checked`);
        answers[name] = sel ? sel.value : "";
      } else {
        const val = new FormData(formEl).get(name);
        answers[name] = val;
      }
    });

    try {
      const r = await fetch(`/api/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify({ answers })
      });
      const jr = await r.json().catch(() => ({}));
      if (r.ok && jr.ok) {
        alertEl.className = "note ok";
        alertEl.textContent = "Gönderildi, teşekkürler!";
        alertEl.style.display = "block";
        formEl.reset();
      } else {
        alertEl.className = "note err";
        alertEl.textContent = jr?.data?.message || jr?.error || `Hata: ${r.status}`;
        alertEl.style.display = "block";
      }
    } catch (err) {
      alertEl.className = "note err";
      alertEl.textContent = "Bağlantı hatası: " + err.message;
      alertEl.style.display = "block";
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
