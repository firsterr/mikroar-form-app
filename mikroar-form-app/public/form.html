<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="preload" href="/form.css" as="style" fetchpriority="high">
  <link rel="stylesheet" href="/form.css?v=3" />
  <style>
    /* İsteğe bağlı çok hafif skeleton, SSR varsa hiç görünmeyecek */
    .skeleton { display:none; padding:16px; }
    .skeleton .bar { height:14px; margin:10px 0; border-radius:6px; background:linear-gradient(90deg,#eee,#f5f5f5,#eee); }
    .muted { opacity:.8; }
    .center { text-align:center; }
    .actions { margin-top:16px; }
    .row { margin:14px 0; }
    .q-title { font-weight:600; margin-bottom:6px; display:flex; gap:6px; align-items:center; }
    .q-title .req { color:#d00; }
    .options { display:grid; gap:8px; }
    .opt { display:flex; gap:8px; align-items:center; }

    /* ---- slug picker modal ---- */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:9999;
}
.modal{
  background:#fff; width:min(720px,92vw); max-height:80vh; overflow:auto; border-radius:14px; padding:18px 18px 10px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.modal h2{ margin:0 0 8px; }
.modal .search{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
.modal .list{ margin-top:12px; display:grid; gap:8px; }
.modal .item{
  display:flex; justify-content:space-between; align-items:center; gap:8px;
  border:1px solid #eee; border-radius:12px; padding:10px 12px; cursor:pointer;
}
.modal .item:hover{ background:#fafafa; }
.modal .slug{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; opacity:.8; }
.modal .close{
  position:absolute; top:10px; right:14px; border:none; background:transparent; font-size:20px; cursor:pointer;
}
  </style>
</head>
<body>
  <div id="app">
    <!-- SSR akışında aşağıdaki başlık/form zaten sunucudan dolu gelir -->
    <h1 id="title" style="display:none"></h1>
    <p id="desc" class="form-desc" style="display:none"></p>

    <form id="form" novalidate style="display:none"></form>

    <div id="skeleton" class="skeleton" aria-hidden="true">
      <div class="bar" style="width:50%"></div>
      <div class="bar" style="width:85%"></div>
      <div class="bar" style="width:70%"></div>
      <div class="bar" style="width:40%"></div>
    </div>

    <p id="alertBottom" class="note center" style="display:none"></p>
  </div>

  <script>
    // ===== Yardımcılar
    const $ = s => document.querySelector(s);
    const show = el => el && (el.style.display = 'block');
    const hide = el => el && (el.style.display = 'none');

    // SSR tespiti: SSR üretildiyse <form data-ssr="1"> DOM'da olur ve window.__FORM set edilir.
    const SSR_READY = !!(window.__FORM && document.querySelector('#form[data-ssr="1"]'));

    // Basit HTML kaçış
    const esc = s => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    // Tek bir soruyu HTML'e çevir (client-side fallback için)
    function qHTML(q){
      const type = (q.type||'text').toLowerCase();
      const name = q.name || q.label || 'q';
      const req  = q.required ? ' required' : '';
      const ph   = q.placeholder ? ` placeholder="${esc(q.placeholder)}"` : '';
      const desc = q.description ? `<div class="muted">${esc(q.description)}</div>` : '';
      let inner = '';

      if (type==='radio' || type==='checkbox') {
        const opts = Array.isArray(q.options)? q.options : [];
        inner = `<div class="options">` + opts.map(v=>{
          const val = esc(String(v));
          const id  = `f_${name}_${val.replace(/\W+/g,'_')}`;
          return `<label class="opt" for="${id}">
                    <input type="${type}" id="${id}" name="${esc(name)}" value="${val}">
                    <span>${val}</span>
                  </label>`;
        }).join('') + `</div>`;
      } else if (type==='select') {
        const opts = Array.isArray(q.options)? q.options : [];
        inner = `<div class="options"><div class="opt">
                  <select id="f_${esc(name)}" name="${esc(name)}"${req}>
                    <option value="" disabled selected>Seçiniz</option>
                    ${opts.map(v=>`<option value="${esc(String(v))}">${esc(String(v))}</option>`).join('')}
                  </select>
                 </div></div>`;
      } else if (type==='textarea') {
        inner = `<textarea id="f_${esc(name)}" name="${esc(name)}"${req}${ph}></textarea>`;
      } else {
        const itype = (type==='email' ? 'email' : type==='number' ? 'number' : 'text');
        inner = `<input type="${itype}" id="f_${esc(name)}" name="${esc(name)}"${req}${ph}/>`;
      }

      return `<div class="row">
                <div class="q-title">
                  <label for="f_${esc(name)}">${esc(q.label||'')}</label>
                  ${q.required ? `<span class="req">*</span>` : ``}
                </div>
                ${desc}
                ${inner}
              </div>`;
    }

    // Client-side render (SSR yokken)
    function renderClient(form){
      $('#title').textContent = form.title || 'Anket';
      show($('#title'));
      if (form.description) {
        $('#desc').textContent = form.description;
        show($('#desc'));
      }

      const schema = typeof form.schema==='string' ? JSON.parse(form.schema||'{}') : (form.schema||{});
      const qs = Array.isArray(schema.questions) ? schema.questions : [];
      $('#form').innerHTML =
        qs.map(qHTML).join('') +
        `<div class="actions"><button type="submit" id="btnSend">Gönder</button></div>
         <p class="after center">Bu form <strong>mikroar.com</strong> alanında oluşturuldu.</p>
         <p class="brand">mikroAR</p>`;
      show($('#form'));
    }

    async function bootstrap(){
      // SSR varsa: fetch yok, skeleton yok — form zaten DOM’da
      if (SSR_READY) {
        hide($('#skeleton'));
        show($('#form'));
        const d = $('#desc'); if (d && d.textContent.trim()) show(d);
        const t = $('#title'); if (t && t.textContent.trim()) show(t);
        return;
      }

 
    // SSR yoksa: hafif skeleton + tek fetch
show($('#skeleton'));
try {
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');
  if (!slug) throw new Error('slug gerekli');

  const r = await fetch(`/api/forms?slug=${encodeURIComponent(slug)}`, {
    headers: { 'accept': 'application/json' }
  });
  if (!r.ok) throw new Error('Form bulunamadı');

  // --- ESNEK JSON ÇÖZÜMLEME (kritik hotfix) ---
  let j;
  try { j = await r.json(); } catch { j = null; }
  // Olası payload formatları: {form:{...}}  |  {data:{...}}  |  {...}
  const form = (j && (j.form || j.data)) ? (j.form || j.data) : j;

  if (!form || typeof form !== 'object') {
    throw new Error('Geçersiz yanıt (form verisi yok).');
  }

  // Güvenli alanlar (boşluklar)
  form.title = form.title || 'Anket';
  form.description = form.description || '';
  if (typeof form.schema === 'string') {
    try { form.schema = JSON.parse(form.schema); } catch { form.schema = {}; }
  }
  if (!form.schema || typeof form.schema !== 'object') form.schema = {};
  if (!Array.isArray(form.schema.questions)) form.schema.questions = [];

  window.__FORM = form; // ileride de kullanılabilir
  hide($('#skeleton'));
  renderClient(form);
} catch (e) {
  hide($('#skeleton'));
  $('#app').innerHTML = `<p class="center">Hata: ${esc(e.message || e)}</p>`;
}
    }

    // Başlat
    bootstrap();
  </script>

  <!-- Uygulama tarafındaki ortak işlevler (submit vb.) burada olabilir -->
  <script src="/app.js" defer></script>
</body>
</html>
