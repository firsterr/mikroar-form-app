<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
  </style>
</head>
<body>
  <main>
    <!-- Başlık/açıklama başlangıçta gizli -->
    <h1 id="title" style="display:none"></h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <!-- Form DOM’a çizilinceye kadar gizli -->
    <form id="form" novalidate hidden></form>
  </main>

<script>
(() => {
  const VERSION = 'FORM LOADER V9';
  console.log(VERSION);

  const API = '/api';
  const $   = (s) => document.querySelector(s);

  const formEl  = $("#form");
  const titleEl = $("#title");
  const descEl  = $("#desc");
  const alertEl = $("#alert");

  // --- slug tespiti ( ?slug=... yoksa path ) ---
  const rawPath  = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;
  if (!slug) {
    titleEl.textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // JS kapalıyken de POST çalışsın
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // ---------------- yardımcılar ----------------
  const tryParse = (x) => {
    if (typeof x === 'string') { try { return JSON.parse(x); } catch { return x; } }
    return x;
  };
  const get = (obj, path) => path.split('.').reduce((a,k)=> (Array.isArray(a)?a[0]:a)?.[k], obj);
  const normType = (t) => {
    const s = String(t || 'text').toLowerCase();
    if (['text','email','textarea','radio','checkbox'].includes(s)) return s;
    if (['select','dropdown','choice','choices','option','options'].includes(s)) return 'radio';
    if (['longtext','paragraph'].includes(s)) return 'textarea';
    return 'text';
  };

  // Nesne dizisini "alan"lara çevir
  const mapField = (q, i) => {
    q = tryParse(q) || {};
    const name =
      q.name || q.key || q.id || `q_${i}`;
    const label =
      q.label || q.title || q.question || q.text || `Soru ${i+1}`;
    const required = !!(q.required || q.required_flag);

    let options = q.options || q.choices || q.items;
    if (options && !Array.isArray(options)) {
      // {0:"A",1:"B"} gibi ise
      options = Object.keys(options).sort().map(k => String(options[k]));
    }
    if (Array.isArray(options)) options = options.map(String);

    const type = normType(q.type);
    return { name, label, required, type, options };
  };

  // Derin arama: JSON içinde alan dizisi gibi görünen ilk diziyi bul
  function findFieldArray(x, depth=0, seen=new Set()) {
    if (x == null || depth > 6) return null;
    if (seen.has(x)) return null;
    if (typeof x === 'string') x = tryParse(x);

    if (Array.isArray(x)) {
      // {name/label/type} içeren bir dizi mi?
      const score = x.filter(o => o && typeof o === 'object' && (o.name || o.label || o.title || o.question || o.text)).length;
      if (score >= Math.min(1, x.length)) return x;
      for (const v of x) {
        const f = findFieldArray(v, depth+1, seen);
        if (f) return f;
      }
      return null;
    }
    if (typeof x === 'object') {
      seen.add(x);
      for (const k of Object.keys(x)) {
        const f = findFieldArray(x[k], depth+1, seen);
        if (f) return f;
      }
    }
    return null;
  }

  function normalize(j) {
    const root = Array.isArray(j) ? j[0] : j;

    // meta
    const schema = tryParse(root.schema) ?? get(root,'form.schema') ?? get(root,'data.schema');
    const title  = root.title ?? get(root,'form.title') ?? (schema && schema.title);
    const description = root.description ?? get(root,'form.description') ?? (schema && schema.description);

    // 1. öncelik: schema.fields / schema.questions / schema.items
    let fields = (schema && (schema.fields || schema.questions || schema.items));
    // 2. değilse derin arama
    if (!fields) fields = findFieldArray(schema) || findFieldArray(root);

    // Eğer {q_0:{}, q_1:{}} gibi anahtarlar varsa diziye çevir
    if (fields && !Array.isArray(fields) && typeof fields === 'object') {
      const keys = Object.keys(fields).sort((a,b)=>{
        const na=(a.match(/\d+/)||[0])[0]|0, nb=(b.match(/\d+/)||[0])[0]|0;
        return na-nb || a.localeCompare(b);
      });
      fields = keys.map(k => fields[k]);
    }

    const mapped = Array.isArray(fields) ? fields.map(mapField) : [];
    return { title, description, fields: mapped, raw: root };
  }
  // ---------------- /yardımcılar ----------------

  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      window.__FORM_DEBUG__ = j; // teşhis için
      const n = normalize(j);

      titleEl.textContent = n.title || `Form: ${slug}`;
      if (n.description) { descEl.textContent = n.description; descEl.style.display = 'block'; }

      formEl.innerHTML = '';
      let inputs = 0;

      n.fields.forEach((f, idx) => {
        const id  = `fld_${f.name || ('q_'+idx)}`;
        const req = f.required ? 'required' : '';
        const row = document.createElement('div');
        row.className = 'row';

        let control = '';
        if (f.type === 'textarea') {
          control = `<textarea id="${id}" name="${f.name}" ${req}></textarea>`;
          inputs++;
        } else if (f.type === 'radio' || f.type === 'checkbox') {
          const opts = (f.options || []).map((opt, i) => {
            const oid = `${id}_${i}`;
            return `<label style="display:flex;gap:8px;align-items:center;margin:4px 0">
                      <input id="${oid}" type="${f.type}" name="${f.name}" value="${opt}">
                      <span>${opt}</span>
                    </label>`;
          }).join('');
          control = opts || `<em>Seçenek yok</em>`;
          if (opts) inputs++;
        } else {
          control = `<input id="${id}" type="${f.type || 'text'}" name="${f.name}" ${req} />`;
          inputs++;
        }

        row.innerHTML = `<label for="${id}">${f.label}${f.required ? ' *' : ''}</label>${control}`;
        formEl.appendChild(row);
      });

      if (!inputs) {
        alertEl.className = 'err';
        alertEl.textContent = 'Bu formda soru tanımı bulunamadı.';
        alertEl.style.display = 'block';
        console.warn('FORM DEBUG KEYS:', Object.keys(Array.isArray(j)?j[0]:j));
        return;
      }

      const btn = document.createElement('button');
      btn.type = 'submit';
      btn.textContent = 'Gönder';
      formEl.appendChild(btn);
    })
    .catch(e => {
      if (!titleEl.textContent) titleEl.textContent = 'Form yüklenemedi.';
      alertEl.className = 'err';
      alertEl.textContent = e.message || 'Hata';
      alertEl.style.display = 'block';
    });

  // Submit
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    alertEl.style.display = 'none';

    const answers = Object.fromEntries(new FormData(formEl).entries());
    if (!Object.keys(answers).length) {
      alertEl.className = 'err';
      alertEl.textContent = 'Gönderilecek cevap bulunamadı (soru yok).';
      alertEl.style.display = 'block';
      if (btn) btn.disabled = false;
      return;
    }

    try {
      const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method : 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body   : JSON.stringify({ answers })
      });
      const j = await res.json().catch(()=> ({}));

      if (res.status === 409 || j.code === '23505' || j.alreadySubmitted) {
        alertEl.className = 'err';
        alertEl.textContent = 'Bu formu zaten doldurmuş görünüyorsunuz.';
        alertEl.style.display = 'block';
      } else if (res.ok && j.ok) {
        alertEl.className = 'ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'err';
        alertEl.textContent = j?.data?.message || j?.error || `Hata: ${res.status}`;
        alertEl.style.display = 'block';
      }
    } catch (err) {
      alertEl.className = 'err';
      alertEl.textContent = 'Bağlantı hatası: ' + err.message;
      alertEl.style.display = 'block';
    } finally {
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
