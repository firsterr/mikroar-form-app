<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form</title>
<link rel="stylesheet" href="/form.css">
<style>
  .note{display:none;margin:16px 0;padding:12px;border-radius:8px}
  .note.err{display:block;background:#ffe8e8;color:#b00020;border:1px solid #f3c5c5}
  .note.warn{display:block;background:#fff5da;color:#6b5100;border:1px solid #f1e2b3}
  .note.ok{display:block;background:#e7fff1;color:#0a7d3b;border:1px solid #bdf0cf}
  .row{margin:18px 0}
  label{display:block;font-weight:600;margin-bottom:8px}
  .muted{color:#666;font-size:.95rem}
  /* >>> yeni: ilk başlık gizli, form fade-in */
  .hidden{display:none}
  .fade{opacity:0; transition:opacity .18s ease}
  .fade.show{opacity:1}
</style>
</head>
<body>
<main class="wrap">
  <!-- >>> başlık ilk anda gizli -->
  <h1 id="title" class="hidden"></h1>
  <p id="desc" class="muted" style="display:none"></p>
  <!-- uyarı ilk anda görünmesin -->
  <p id="alert" class="note"></p>

  <!-- >>> fade sınıfı eklendi -->
  <form id="form" method="POST" action="#" class="fade" style="display:none"></form>
</main>

<script>
(() => {
  const $ = (s) => document.querySelector(s);
  const titleEl = $('#title');
  const descEl  = $('#desc');
  const alertEl = $('#alert');
  const formEl  = $('#form');

  const slug = new URLSearchParams(location.search).get('slug')
            || location.pathname.replace(/^\/+|\/+$/g,'');
  const API = '/api';

  function showErr(msg){ alertEl.textContent = msg; alertEl.className='note err'; alertEl.style.display='block'; }
  function showWarn(msg){ alertEl.textContent = msg; alertEl.className='note warn'; alertEl.style.display='block'; }
  function showOk(msg){ alertEl.textContent = msg; alertEl.className='note ok'; alertEl.style.display='block'; }
  function hideNote(){ alertEl.style.display='none'; alertEl.className='note'; alertEl.textContent=''; }

  if (!slug) { showErr('URL’de slug yok.'); return; }

  // Fallback: JS kapalıysa bile çalışsın
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = 'POST';

  // Helpers
  function mk(name, attrs={}, html=''){
    const el = document.createElement(name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    if (html) el.innerHTML = html;
    return el;
  }

  function drawQuestion(q, idx){
    const type = (q.type || 'text').toLowerCase();
    const name = q.name || `q${idx+1}`;
    const label = q.label || `Soru ${idx+1}`;
    const opts = Array.isArray(q.options) ? q.options : [];

    const row = mk('div', { class:'row' });
    row.appendChild(mk('label', { for:`f_${name}` }, label + (q.required ? ' *' : '')));

    if (type === 'radio' || type === 'checkbox') {
      const g = mk('div');
      opts.forEach((opt,i) => {
        const id = `f_${name}_${i}`;
        const w = mk('div');
        const input = mk('input', { type, id, name, value:opt, ...(q.required && type==='radio' ? {required:''}: {}) });
        if (type === 'checkbox') input.name = name + '[]';
        const lab = mk('label', { for:id }, opt);
        w.appendChild(input); w.appendChild(lab);
        g.appendChild(w);
      });
      row.appendChild(g);
      return row;
    }

    if (type === 'select') {
      const select = mk('select', { id:`f_${name}`, name, ...(q.required ? {required:''} : {}) });
      // >>> uyarı yok; seçenek yoksa sadece placeholder dursun
      select.appendChild(mk('option', { value:'', disabled:'', selected:'' }, 'Seçiniz'));
      opts.forEach(v => select.appendChild(mk('option',{value:v}, v)));
      row.appendChild(select);
      return row;
    }

    if (type === 'textarea') {
      row.appendChild(mk('textarea', { id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
      return row;
    }

    const itype = (type === 'email') ? 'email' : 'text';
    row.appendChild(mk('input', { type:itype, id:`f_${name}`, name, ...(q.required?{required:''}:{}) }));
    return row;
  }

  // Şemayı yükle
  fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`)
    .then(r => r.json())
    .then(j => {
      if (!j.ok || !j.schema) throw new Error(j.error || 'Form bulunamadı');
      const s = j.schema;

      // >>> başlığı sadece başarıyla doldur
      titleEl.textContent = s.title || slug;
      titleEl.classList.remove('hidden');

      if (s.description){ descEl.textContent = s.description; descEl.style.display = 'block'; }

      const qs = s.questions || s.fields || [];
      formEl.innerHTML = '';
      if (!qs.length){
        showErr('Bu formda soru tanımı bulunamadı.');
      } else {
        hideNote();
        qs.forEach((q,i) => formEl.appendChild(drawQuestion(q,i)));
        const btn = mk('button', { type:'submit' }, 'Gönder');
        formEl.appendChild(btn);

        // >>> yumuşak açılış
        formEl.style.display = 'block';
        requestAnimationFrame(() => formEl.classList.add('show'));
      }
    })
    .catch(e => {
      titleEl.textContent = 'Form yüklenemedi';
      titleEl.classList.remove('hidden');
      showErr(e.message || 'Hata');
    });

  // Submit (Madde #2: 409 için IP uyarısı)
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideNote();
    const btn = formEl.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    // answers
    const answers = {};
    [...formEl.elements].forEach(el => {
      if (!el.name) return;
      if (el.type === 'radio'){
        if (el.checked) answers[el.name] = el.value;
      } else if (el.type === 'checkbox'){
        const base = el.name.replace(/\[\]$/, '');
        answers[base] = answers[base] || [];
        if (el.checked) answers[base].push(el.value);
      } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email'){
        answers[el.name] = el.value;
      }
    });

    try{
      const r = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
        body: JSON.stringify({ answers })
      });
      const j = await r.json().catch(()=>({}));

      if (r.status === 409 || j.alreadySubmitted) {
        const when = j.at ? ` (${new Date(j.at).toLocaleString()})` : '';
        showWarn('Bu IP ile zaten yanıt gönderilmiş.' + when);
        if (btn) btn.disabled = false;
        return;
      }

      if (r.ok && j.ok){
        showOk('Gönderildi, teşekkürler!');
        formEl.reset();
      }else{
        showErr(j?.data?.message || j?.error || `Hata: ${r.status}`);
      }
    }catch(err){
      showErr('Bağlantı hatası: ' + err.message);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
