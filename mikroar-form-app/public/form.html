<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form(lar) â€“ Åžifreli Liste</title>
<link rel="stylesheet" href="/form.css">
<style>
  :root{--b:#ccd;--bg:#f6f7f8;--pri:#2d6ef7}
  body{font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  main{max-width:960px;margin:36px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 14px}
  .bar{display:flex;gap:10px;align-items:center;margin:8px 0 20px}
  .search{flex:1;display:flex;gap:8px}
  .search input{flex:1;padding:10px;border:1px solid var(--b);border-radius:10px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--b);background:var(--bg);cursor:pointer}
  .btn.pri{background:var(--pri);color:#fff;border-color:var(--pri)}
  .list{border:1px solid var(--b);border-radius:12px;overflow:hidden}
  .row{display:grid;grid-template-columns:1.2fr 2fr .9fr .9fr .9fr;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid #e7eaee}
  .row.head{background:#f0f3f8;font-weight:700}
  .row a{color:#0a56c2;text-decoration:none}
  .row:last-child{border-bottom:none}
  .tag{padding:3px 8px;border-radius:999px;border:1px solid #cfe2ff;background:#eef5ff;font-size:12px}
  .muted{color:#666}
  /* kilit overlay */
  #lock{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(246,247,248,.96);z-index:9999}
  #lock .card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:22px 24px;max-width:420px;width:92%;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.08)}
  #lock h3{margin:0 0 8px;font-size:20px}
  #unlockBtn{padding:10px 14px;border-radius:10px;border:1px solid var(--pri);background:var(--pri);color:#fff;cursor:pointer}
  .note{display:none;margin:12px 0;padding:10px;border-radius:10px;border:1px solid #ccd}
  .note.err{display:block;background:#ffe8e8;color:#b00020;border-color:#f3c5c5}
</style>
</head>
<body>
<main>
  <h1>Form(lar) â€“ Liste</h1>
  <div class="bar">
    <div class="search">
      <input id="q" type="text" placeholder="Slug veya baÅŸlÄ±k ile araâ€¦">
      <button id="btnRefresh" class="btn">Yenile</button>
    </div>
    <button id="btnToken" class="btn">ðŸ”‘ Anahtar</button>
  </div>

  <div id="alert" class="note"></div>

  <div class="list" id="list" hidden>
    <div class="row head">
      <div>Slug</div><div>BaÅŸlÄ±k</div><div>Formu AÃ§</div><div>SonuÃ§lar</div><div>PaylaÅŸ</div>
    </div>
    <!-- satÄ±rlar JS ile gelecek -->
  </div>
</main>

<!-- KÄ°LÄ°T OVERLAY -->
<div id="lock" role="dialog" aria-modal="true">
  <div class="card">
    <h3>YÃ¶netici anahtarÄ± gerekli</h3>
    <p>Devam etmek iÃ§in X-Admin-Token anahtarÄ±nÄ± girin.</p>
    <button id="unlockBtn">Anahtar Gir</button>
  </div>
</div>

<script>
(() => {
  const API = '/api';
  const LS_KEY = 'ADMIN_TOKEN';
  const $ = (s)=>document.querySelector(s);

  const lock = $('#lock');
  const alertEl = $('#alert');
  const listEl = $('#list');
  const qEl = $('#q');

  function toastErr(msg){
    alertEl.textContent = msg;
    alertEl.className = 'note err';
    alertEl.style.display = 'block';
  }
  function clearToast(){
    alertEl.style.display='none';
    alertEl.className='note';
    alertEl.textContent='';
  }

  function getToken(){
    let t = localStorage.getItem(LS_KEY);
    if(!t){
      t = prompt('YÃ¶netici anahtarÄ± (X-Admin-Token):');
      if (t) localStorage.setItem(LS_KEY, t);
    }
    return t;
  }
  function ensureAuthOverlay(){
    const has = !!localStorage.getItem(LS_KEY);
    lock.style.display = has ? 'none' : 'flex';
    document.body.style.overflow = has ? '' : 'hidden';
  }

  // Listeyi Ã§iz
  function renderRows(items){
    // baÅŸlÄ±k satÄ±rÄ±ndan sonrasÄ±nÄ± temizle
    [...listEl.querySelectorAll('.row')].slice(1).forEach(n=>n.remove());
    items.forEach(it=>{
      const r = document.createElement('div');
      r.className = 'row';
      const slug = it.slug;
      const title = it.title || slug;
      // linkler
      const hrefForm = `/form.html?slug=${encodeURIComponent(slug)}`;
      const hrefResults = `/results.html?slug=${encodeURIComponent(slug)}`;
      const hrefShare = `/share/${encodeURIComponent(slug)}`;
      r.innerHTML = `
        <div><span class="tag">${slug}</span></div>
        <div>${title}</div>
        <div><a target="_blank" href="${hrefForm}">Form</a></div>
        <div><a target="_blank" href="${hrefResults}">SonuÃ§lar</a></div>
        <div><a target="_blank" href="${hrefShare}">PaylaÅŸ</a></div>
      `;
      listEl.appendChild(r);
    });
  }

  // Veri Ã§ek (forms-list) â€” headerâ€™a token ekliyoruz (backend gerekirse kontrol eder)
  async function fetchList(){
    clearToast();
    try{
      const t = localStorage.getItem(LS_KEY) || '';
      const r = await fetch(`${API}/forms-list`, {
        headers: { 'X-Admin-Token': t }
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);
      const items = (j.forms || []).map(x=>({
        slug: x.slug,
        title: x.title || (x.schema && x.schema.title) || x.slug
      }));
      renderRows(items);
      listEl.hidden = false;
    }catch(e){
      toastErr(e.message || 'Liste alÄ±namadÄ±');
    }
  }

  // Arama (istemci tarafÄ± filtre)
  qEl.addEventListener('input', ()=>{
    const q = qEl.value.toLowerCase().trim();
    const rows = [...listEl.querySelectorAll('.row')].slice(1);
    rows.forEach(r=>{
      const text = r.textContent.toLowerCase();
      r.style.display = text.includes(q) ? '' : 'none';
    });
  });

  // UI butonlarÄ±
  $('#btnRefresh').addEventListener('click', fetchList);
  $('#btnToken').addEventListener('click', ()=>{
    localStorage.removeItem(LS_KEY);
    getToken();
    ensureAuthOverlay();
    fetchList();
  });
  document.getElementById('unlockBtn').addEventListener('click', ()=>{
    localStorage.removeItem(LS_KEY);
    getToken();
    ensureAuthOverlay();
    fetchList();
  });

  // Boot
  if (!localStorage.getItem(LS_KEY)) { try{ getToken(); }catch{} }
  ensureAuthOverlay();
  if (localStorage.getItem(LS_KEY)) fetchList();
})();
</script>
</body>
</html>
