<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket</title>
  <link rel="stylesheet" href="/form.css" />
  <style>
    main{max-width:820px;margin:40px auto;padding:0 16px}
    .row{margin:16px 0}
    .row .opts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="email"],textarea{width:100%;padding:12px;border:1px solid #ccd;border-radius:8px;font:inherit}
    button{padding:12px 18px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .err{background:#fee;border:1px solid #f99;color:#900;padding:12px;border-radius:8px;margin-bottom:16px}
    .ok{background:#eefbea;border:1px solid #9f9;color:#064;padding:12px;border-radius:8px;margin-bottom:16px}
    .muted{color:#666;font-size:.95rem}
  </style>
</head>
<body>
  <main>
    <h1 id="title">Yükleniyor…</h1>
    <p id="desc" style="display:none"></p>
    <div id="alert" style="display:none"></div>

    <form id="form" novalidate></form>
  </main>

<script>
(async () => {
  const API = '/api'; // netlify redirect ile .functions
  const $ = (s) => document.querySelector(s);
  const formEl = $("#form");
  const alertEl = $("#alert");

  // slug: ?slug=... (tercih) – yoksa path (ör: /formayvalik)
  const rawPath = location.pathname.replace(/^\/+|\/+$/g, "");
  const pathSlug = rawPath && rawPath !== "form.html" ? rawPath : "";
  const slug = new URLSearchParams(location.search).get("slug") || pathSlug;

  if (!slug) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = "URL’de ?slug=… yok.";
    alertEl.style.display = "block";
    return;
  }

  // Fallback: JS kapalıysa
  formEl.action = `${API}/submit-form?slug=${encodeURIComponent(slug)}`;
  formEl.method = "POST";

  // Şemayı al
  const r = await fetch(`${API}/forms?slug=${encodeURIComponent(slug)}`);
  const j = await r.json().catch(()=> ({}));
  if (!r.ok || !j.ok || !j.schema) {
    $("#title").textContent = "Form yüklenemedi.";
    alertEl.className = "err";
    alertEl.textContent = j?.error || `Hata: ${r.status}`;
    alertEl.style.display = "block";
    return;
  }

  const s = j.schema;
  $("#title").textContent = s.title || slug;
  if (s.description) {
    $("#desc").textContent = s.description;
    $("#desc").style.display = "block";
  }

  const fields = s.questions || s.fields || [];
  formEl.innerHTML = "";

  if (!fields.length) {
    const warn = document.createElement('div');
    warn.className = 'err';
    warn.textContent = 'Bu formda soru tanımı bulunamadı.';
    formEl.appendChild(warn);
  }

  // === ÇİZ ===
  fields.forEach((q, idx) => {
    const idBase = (q.name || `q${idx+1}`).replace(/[^a-z0-9_]/gi, '_');
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('label');
    label.setAttribute('for', `${idBase}`);
    label.textContent = q.label || (q.name || `Soru ${idx+1}`) + (q.required ? ' *' : '');
    row.appendChild(label);

    const t = (q.type || 'text').toLowerCase();
    const requiredAttr = q.required ? 'required' : '';

    if (t === 'textarea') {
      row.insertAdjacentHTML('beforeend',
        `<textarea id="${idBase}" name="${q.name || idBase}" ${requiredAttr}></textarea>`
      );
    } else if (t === 'radio' || t === 'checkbox') {
      const opts = Array.isArray(q.options) ? q.options : [];
      if (!opts.length) {
        row.insertAdjacentHTML('beforeend',
          `<div class="muted">Bu soru için seçenek tanımlı değil.</div>`
        );
      } else {
        const box = document.createElement('div');
        box.className = 'opts';
        opts.forEach((opt, k) => {
          const optId = `${idBase}_${k}`;
          const input = document.createElement('input');
          input.type = t;
          input.id = optId;
          input.name = q.name || idBase; // checkbox çoklu için name aynı kalır; getAll ile toplayacağız
          input.value = opt;
          if (q.required && t === 'radio' && k === 0) {
            // radio grubunda required'ı bir tanesine vermek yeterli (HTML kuralı)
            input.required = true;
          }
          const lab = document.createElement('label');
          lab.setAttribute('for', optId);
          lab.textContent = opt;
          lab.style.fontWeight = '400';

          const wrap = document.createElement('div');
          wrap.appendChild(input);
          wrap.appendChild(document.createTextNode(' '));
          wrap.appendChild(lab);
          box.appendChild(wrap);
        });
        row.appendChild(box);
      }
    } else {
      // text / email / vs.
      const htmlType = (t === 'email' ? 'email' : 'text');
      row.insertAdjacentHTML('beforeend',
        `<input id="${idBase}" type="${htmlType}" name="${q.name || idBase}" ${requiredAttr} />`
      );
    }

    formEl.appendChild(row);
  });

  // Gönder butonu
  const btn = document.createElement('button');
  btn.type = 'submit';
  btn.textContent = 'Gönder';
  formEl.appendChild(btn);

  // === SUBMIT ===
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    alertEl.style.display = 'none';

    // Cevapları topla (checkbox çoklu değerleri dahil)
    const fd = new FormData(formEl);
    const answers = {};
    fields.forEach((q, idx) => {
      const nm = q.name || `q${idx+1}`;
      const t = (q.type || 'text').toLowerCase();
      if (t === 'checkbox') {
        answers[nm] = fd.getAll(nm);             // çoklu
      } else {
        answers[nm] = fd.get(nm);                // tek
      }
    });

    try {
      const res = await fetch(`${API}/submit-form?slug=${encodeURIComponent(slug)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ answers })
      });
      const jj = await res.json().catch(()=> ({}));
      if (res.ok && jj.ok) {
        alertEl.className = 'ok';
        alertEl.textContent = 'Gönderildi, teşekkürler!';
        alertEl.style.display = 'block';
        formEl.reset();
      } else {
        alertEl.className = 'err';
        alertEl.textContent = jj?.data?.message || jj?.error || `Hata: ${res.status}`;
        alertEl.style.display = 'block';
      }
    } catch (err) {
      alertEl.className = 'err';
      alertEl.textContent = 'Bağlantı hatası: ' + err.message;
      alertEl.style.display = 'block';
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
