<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MikroAR Results</title>
  <style>
    :root{ --bg:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb; }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fafafa; color:var(--fg); }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    h1{ font-size:22px; margin:0 0 16px 0; }
    .card{ background:var(--bg); border:1px solid var(--line); border-radius:12px; padding:16px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input,select,button{ font:inherit; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; }
    input[type=password]{ min-width:260px; }
    input[type=text]{ min-width:260px; }
    button{ background:#111; color:#fff; border-color:#111; cursor:pointer; }
    button.ghost{ background:#fff; color:#111; border-color:var(--line); }
    .muted{ color:var(--muted); font-size:12px; }
    .space{ height:12px; }
    .table-wrap{ overflow:auto; border:1px solid var(--line); border-radius:10px; }
    table{ border-collapse:separate; border-spacing:0; width:100%; min-width:800px; }
    thead th{ position:sticky; top:0; background:#fff; z-index:1; }
    th,td{ border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; vertical-align:top; font-size:14px; }
    tbody tr:nth-child(odd){ background:#fcfcfc; }
    .right{ margin-left:auto; display:flex; gap:8px; }
    .status{ margin-left:6px; font-size:12px; color:var(--muted); }
    .error{ color:#b00020; }
    /* Analiz paneli */
    .viz-summary{
  margin-top:6px;
  font-size:12px;
  color:#4b5563;
}
.viz-summary table{
  margin-top:4px;
  border-collapse:collapse;
  font-size:12px;
}
.viz-summary th,
.viz-summary td{
  padding:2px 6px;
  border:1px solid #e5e7eb;
}
.viz-summary th{
  background:#f3f4f6;
  font-weight:600;
}
.viz-controls-secondary{
  margin-top:4px;
  border-top:1px dashed #e5e7eb;
  padding-top:6px;
  font-size:13px;
}
.viz-controls-secondary label{
  font-weight:400;
}
    .viz-panel{
  margin-top: 16px;
  margin-bottom: 24px;
  padding: 16px 18px;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  background: #fbfbfb;
}
.viz-header{
  display:flex;
  align-items:baseline;
  gap:8px;
  margin-bottom:10px;
}
.viz-header h2{
  margin:0;
  font-size:18px;
}
.viz-subtitle{
  font-size:12px;
  color:#6b7280;
}
.viz-controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px 16px;
  align-items:center;
  margin-bottom:12px;
  font-size:14px;
}
.viz-controls label{
  display:flex;
  align-items:center;
  gap:6px;
}
.viz-controls select{
  padding:4px 8px;
  border-radius:8px;
  border:1px solid #d1d5db;
}
#vizRefreshBtn{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid #111827;
  background:#111827;
  color:#fff;
  font-size:13px;
  cursor:pointer;
}
#vizRefreshBtn:hover{
  background:#000;
}
.viz-chart-wrap{
  background:#fff;
  border-radius:12px;
  padding:10px;
  border:1px solid #e5e7eb;
  min-height:220px;
}

/* Mobil */
@media (max-width:640px){
  .viz-panel{
    padding:12px 12px;
  }
  .viz-controls{
    flex-direction:column;
    align-items:flex-start;
  }
}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Yanıtlar (Results)</h1>
    <div class="card">
      <div class="row">
        <label class="muted">ADMIN_TOKEN</label>
        <input id="token" type="password" placeholder="ADMIN_TOKEN" />
        <button id="loginBtn">Giriş</button>
        <span id="authStat" class="status"></span>
      </div>

      <div class="space"></div>

      <div class="row">
        <select id="slug" disabled style="min-width:320px">
          <option value="">— slug seç —</option>
        </select>
        <input id="slugManual" type="text" placeholder="veya slug yazın…" style="display:none" />
        <button id="loadBtn" disabled>Yükle</button>
        <div class="right">
          <button id="refreshBtn" class="ghost" disabled>Yenile</button>
          <button id="csvBtn" disabled>CSV indir</button>
        </div>
      </div>

      <div class="space"></div>
      <div id="meta" class="muted"></div>

      <div class="space"></div>
      <div class="table-wrap">
       <section id="vizPanel" class="viz-panel">
  <div class="viz-header">
    <h2>Analiz Paneli</h2>
    <span class="viz-subtitle">Tablodan canlı yüzde dağılım grafiği</span>
  </div>

  <!-- Ana analiz edilen soru -->
  <div class="viz-controls">
    <label>
      Analiz edilen soru:
      <select id="vizQuestionSelect"></select>
    </label>

    <label>
      Grafik tipi:
      <select id="vizChartType">
        <option value="bar">Çubuk Grafik</option>
        <option value="pie">Pasta Grafik</option>
      </select>
    </label>

    <button id="vizRefreshBtn" type="button">Güncelle</button>
  </div>

  <!-- Filtreli analiz: örn. "1. soruda Ahmet Akın diyenler" -->
  <div class="viz-controls viz-controls-secondary">
    <label>
      Filtre soru (opsiyonel):
      <select id="vizFilterQuestionSelect"></select>
    </label>

    <label>
      Değer:
      <select id="vizFilterValueSelect">
        <option value="">Tümü</option>
      </select>
    </label>
  </div>

  <div class="viz-chart-wrap">
    <canvas id="vizChart" height="140"></canvas>
  </div>
         <div id="vizSummary" class="viz-summary"></div>
</section>
        <table id="grid">
          <thead><tr id="thead"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const tokenEl=$("#token"), loginBtn=$("#loginBtn"), authStat=$("#authStat");
  const slugSel=$("#slug"), slugManual=$("#slugManual"), loadBtn=$("#loadBtn"), refreshBtn=$("#refreshBtn"), csvBtn=$("#csvBtn");
  const thead=$("#thead"), tbody=$("#tbody"), meta=$("#meta");
  let TOKEN="", CURRENT={ headers:[], items:[], slug:"", title:"" };

  // token hatırla
  try {
    const saved = localStorage.getItem("mikroar_admin_token");
    if (saved) tokenEl.value = saved;
  } catch {}

  loginBtn.addEventListener("click", doLogin);
  loadBtn.addEventListener("click", ()=> {
    const val = (slugSel.value || slugManual.value || "").trim();
    if (val) load(val);
  });
  refreshBtn.addEventListener("click", ()=> CURRENT.slug && load(CURRENT.slug));
  csvBtn.addEventListener("click", downloadCSV);

  async function doLogin(){
    TOKEN=(tokenEl.value||"").trim();
    if(!TOKEN){authStat.textContent="Token gerekli";authStat.classList.add("error");return;}
    authStat.textContent="Doğrulanıyor…"; authStat.classList.remove("error");

    // sakla
    try { localStorage.setItem("mikroar_admin_token", TOKEN); } catch {}

    // forms-list dene (token query + bearer)
    slugSel.innerHTML=`<option value="">— slug seç —</option>`;
    slugSel.disabled=true; loadBtn.disabled=true; refreshBtn.disabled=true; csvBtn.disabled=true;
    slugManual.style.display="none";

    let r;
    try {
      r = await fetch(`/api/forms-list?token=${encodeURIComponent(TOKEN)}`, {
        headers: { "Authorization": `Bearer ${TOKEN}`, "accept":"application/json" },
        cache: "no-store"
      });
    } catch {
      r = null;
    }

    if (!r) {
      authStat.textContent="Ağ hatası";
      authStat.classList.add("error");
      fallbackToManual();
      return;
    }
    if (r.status === 401 || r.status === 403) {
      authStat.textContent="Yetki hatası (401/403) – ADMIN_TOKEN eşleşmiyor";
      authStat.classList.add("error");
      fallbackToManual(); // yine de manuel slug ile sonuç çekebilirsin (token doğruysa /api/results çalışır)
      return;
    }
    if (!r.ok) {
      authStat.textContent=`Listede sorun (${r.status}) – manuel slug’a geçiliyor`;
      authStat.classList.add("error");
      fallbackToManual();
      return;
    }

    const d = await r.json().catch(()=>null);
    if (!d || !Array.isArray(d.items)) {
      authStat.textContent="Liste alınamadı – manuel slug’a geçiliyor";
      authStat.classList.add("error");
      fallbackToManual();
      return;
    }

    d.items.forEach(x=>{
      const o=document.createElement("option");
      o.value=x.slug; o.textContent=`${x.slug} — ${x.title}${x.active?" (aktif)":""}`;
      slugSel.appendChild(o);
    });
    slugSel.disabled=false; loadBtn.disabled=false;
    authStat.textContent="Hazır";
    authStat.classList.remove("error");
  }

  function fallbackToManual(){
    slugSel.disabled=true;
    slugManual.style.display="inline-block";
    loadBtn.disabled=false;
  }

  async function load(slug){
    meta.textContent="Yükleniyor…"; meta.classList.remove("error");
    thead.innerHTML=""; tbody.innerHTML="";
    refreshBtn.disabled=true; csvBtn.disabled=true;

    const url=`/api/results?slug=${encodeURIComponent(slug)}&token=${encodeURIComponent(TOKEN)}&limit=2000`;
    let r;
    try {
      r = await fetch(url, {
        headers: { "Authorization": `Bearer ${TOKEN}`, "accept":"application/json" },
        cache: "no-store"
      });
    } catch {
      meta.textContent="İstek atılamadı (network)";
      meta.classList.add("error");
      return;
    }

    if (!r.ok) {
      const text = await r.text().catch(()=> "");
      meta.textContent = `Hata ${r.status}: ` + (text || "beklenmedik");
      meta.classList.add("error");
      return;
    }

    const d = await r.json().catch(()=>null);
    if (!d || !d.ok) {
      meta.textContent = "Geçersiz yanıt / ok:false";
      meta.classList.add("error");
      return;
    }

    CURRENT = d;

    // başlıklar
    thead.innerHTML = "";
    d.headers.forEach(h=>{
      const th=document.createElement("th"); th.textContent=h; thead.appendChild(th);
    });

    // satırlar
    const frag = document.createDocumentFragment();
    d.items.forEach(row=>{
      const tr=document.createElement("tr");
      d.headers.forEach(h=>{
        const td=document.createElement("td");
        td.textContent = (row[h] ?? "");
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.innerHTML=""; tbody.appendChild(frag);

  meta.textContent = `${d.title || d.slug} • ${d.count*13} satır`;
    meta.classList.remove("error");
    refreshBtn.disabled=false; csvBtn.disabled=(d.count===0);
  }

  function downloadCSV(){
    const { headers, items, title, slug }=CURRENT; if(!headers||!items) return;
    const esc=(v)=>{ const s=(v==null?"":String(v)); const danger=/^[=\-+@]/.test(s); const safe=danger?"'"+s:s;
      return (safe.includes('"')||safe.includes(',')||safe.includes('\n')) ? `"${safe.replace(/"/g,'""')}"` : safe; };
    const rows=[headers.map(esc).join(",")];
    items.forEach(it=> rows.push(headers.map(h=>esc(it[h])).join(",")) );
    const csv="\uFEFF"+rows.join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a"); const dt=new Date().toISOString().replace(/[:T]/g,"-").slice(0,19);
    a.href=URL.createObjectURL(blob); a.download=`${(title||slug||"results")}_${dt}.csv`; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
(function () {
  // Adetleri büyütmek için çarpan
 const SCALE = 13;
  let chartInstance = null;
// Data labels plugin
  if (window.Chart && window.ChartDataLabels) {
    Chart.register(window.ChartDataLabels);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const table     = document.getElementById("grid");
    const headerRow = document.getElementById("thead");
    const tbody     = document.getElementById("tbody");
    if (!table || !headerRow || !tbody) return;

    const questionSelect       = document.getElementById("vizQuestionSelect");
    const chartTypeSelect      = document.getElementById("vizChartType");
    const filterQuestionSelect = document.getElementById("vizFilterQuestionSelect");
    const filterValueSelect    = document.getElementById("vizFilterValueSelect");
    const refreshBtn           = document.getElementById("vizRefreshBtn");

    const observer = new MutationObserver(() => {
      if (tbody.rows.length > 0 && headerRow.cells.length > 0) {
        observer.disconnect();
        initQuestions(headerRow, questionSelect);
        initQuestions(headerRow, filterQuestionSelect, { includeEmptyFirst: true });
        populateFilterValues(tbody, filterQuestionSelect, filterValueSelect);
        renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
      }
    });
    observer.observe(tbody, { childList: true });

    if (tbody.rows.length > 0 && headerRow.cells.length > 0) {
      observer.disconnect();
      initQuestions(headerRow, questionSelect);
      initQuestions(headerRow, filterQuestionSelect, { includeEmptyFirst: true });
      populateFilterValues(tbody, filterQuestionSelect, filterValueSelect);
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    }

    questionSelect?.addEventListener("change", () => {
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    });

    chartTypeSelect?.addEventListener("change", () => {
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    });

    filterQuestionSelect?.addEventListener("change", () => {
      populateFilterValues(tbody, filterQuestionSelect, filterValueSelect);
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    });

    filterValueSelect?.addEventListener("change", () => {
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    });

    refreshBtn?.addEventListener("click", () => {
      populateFilterValues(tbody, filterQuestionSelect, filterValueSelect);
      renderCurrentChart(headerRow, tbody, questionSelect, chartTypeSelect, filterQuestionSelect, filterValueSelect);
    });
  });

  function initQuestions(headerRow, selectEl, opts) {
    if (!headerRow || !selectEl) return;
    const includeEmptyFirst = opts && opts.includeEmptyFirst;

    const options = [];
    // 0: created_at, 1: ip → atla
    for (let col = 2; col < headerRow.cells.length; col++) {
      const label = headerRow.cells[col].innerText.trim();
      if (!label) continue;
      options.push({ index: col, label });
    }

    selectEl.innerHTML = "";
    if (includeEmptyFirst) {
      const emptyOpt = document.createElement("option");
      emptyOpt.value = "";
      emptyOpt.textContent = "— Seçilmedi —";
      selectEl.appendChild(emptyOpt);
    }

    options.forEach((opt, idx) => {
      const o = document.createElement("option");
      o.value = String(opt.index);
      o.textContent = opt.label;
      if (!includeEmptyFirst && idx === 0) o.selected = true;
      selectEl.appendChild(o);
    });

    if (!includeEmptyFirst && options.length && !selectEl.value) {
      selectEl.value = String(options[0].index);
    }
  }

  function populateFilterValues(tbody, filterQuestionSelect, filterValueSelect) {
    if (!filterQuestionSelect || !filterValueSelect) return;

    const val = filterQuestionSelect.value;
    if (!val) {
      filterValueSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "Tümü";
      filterValueSelect.appendChild(allOpt);
      return;
    }

    const colIndex = parseInt(val, 10);
    if (isNaN(colIndex)) return;

    const values = new Set();
    for (const row of Array.from(tbody.rows)) {
      const cell = row.cells[colIndex];
      if (!cell) continue;
      let txt = (cell.innerText || cell.textContent || "").trim();
      if (!txt) txt = "Diğer"; // boşları Diğer yap
      values.add(txt);
    }

    filterValueSelect.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "Tümü";
    filterValueSelect.appendChild(allOpt);

    Array.from(values).sort().forEach((v) => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      filterValueSelect.appendChild(o);
    });
  }

 function renderCurrentChart(
  headerRow,
  tbody,
  questionSelect,
  chartTypeSelect,
  filterQuestionSelect,
  filterValueSelect
) {
  if (!tbody || !questionSelect) return;

  const targetColIndex = parseInt(questionSelect.value, 10);
  if (isNaN(targetColIndex)) return;

  let filterColIndex = null;
  let filterValue = "";
  let filterLabel = "";

  if (filterQuestionSelect && filterQuestionSelect.value) {
    filterColIndex = parseInt(filterQuestionSelect.value, 10);
    if (!isNaN(filterColIndex)) {
      filterValue = filterValueSelect ? filterValueSelect.value : "";
      const hcell = headerRow.cells[filterColIndex];
      filterLabel = hcell ? hcell.innerText.trim() : "";
    }
  }

  // Ham veriyi topla
  let { labels, counts, total } = aggregateColumn(
    tbody,
    targetColIndex,
    filterColIndex,
    filterValue
  );

  // Yüzdeleri hesapla (ham sırada)
  let pctData = counts.map((c) =>
    total > 0 ? Math.round((c * 10000) / total) / 100 : 0
  );

  // === YENİ: en büyükten en küçüğe sırala ===
  const order = counts
    .map((c, idx) => ({ c, idx }))
    .sort((a, b) => b.c - a.c) // büyükten küçüğe
    .map((x) => x.idx);

  labels  = order.map((i) => labels[i]);
  counts  = order.map((i) => counts[i]);
  pctData = order.map((i) => pctData[i]);
  // ==========================================

  const type = (chartTypeSelect && chartTypeSelect.value) || "bar";

  const targetHeaderCell = headerRow.cells[targetColIndex];
  const mainQuestion = targetHeaderCell
    ? targetHeaderCell.innerText.trim()
    : "";

  const scaledTotal = total * SCALE;

  let titleText = mainQuestion || "";
  if (filterColIndex != null && filterValue) {
    titleText += ` — Filtre: ${filterLabel} = ${filterValue} (n=${scaledTotal})`;
  } else if (total) {
    titleText += ` (n=${scaledTotal})`;
  }

  drawChart(labels, pctData, type, {
    titleText,
    counts,
    total,
    scale: SCALE,
  });

  updateSummary(labels, counts, pctData, total, SCALE);
}

  function aggregateColumn(tbody, targetColIndex, filterColIndex, filterValue) {
    const map = new Map();
    let total = 0;
    const useFilter =
      filterColIndex != null &&
      !isNaN(filterColIndex) &&
      filterValue !== undefined &&
      filterValue !== "";

    for (const row of Array.from(tbody.rows)) {
      // Filtre kolonu
      if (useFilter) {
        const fcell = row.cells[filterColIndex];
        if (!fcell) continue;
        let ftxt = (fcell.innerText || fcell.textContent || "").trim();
        if (!ftxt) ftxt = "Diğer";   // filtre tarafında da boş = Diğer
        if (ftxt !== filterValue) continue;
      }

      const cell = row.cells[targetColIndex];
      if (!cell) continue;
      let txt = (cell.innerText || cell.textContent || "").trim();
      if (!txt) txt = "Diğer";       // ana soru tarafında da boş = Diğer

      total++;
      map.set(txt, (map.get(txt) || 0) + 1);
    }

    const labels = Array.from(map.keys());
    const counts = Array.from(map.values());
    return { labels, counts, total };
  }

 function drawChart(labels, pctData, type, meta) {
  const canvas = document.getElementById("vizChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  const titleText = meta && meta.titleText ? meta.titleText : "";
  const counts    = meta && meta.counts ? meta.counts : [];
  const total     = meta && meta.total ? meta.total : 0;
  const scale     = meta && meta.scale ? meta.scale : 1;

  chartInstance = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [
        {
          label: "% Dağılım",
          data: pctData,
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: !!titleText,
          text: titleText,
          font: { size: 13 },
        },
        legend: { display: type === "pie" },
        tooltip: {
          callbacks: {
            // Tooltip: Adet (x10) + %
            label: (ctx) => {
              const idx = ctx.dataIndex;
              const pct = ctx.parsed || 0;
              const cnt = counts[idx] || 0;
              const scaled = cnt * scale;
              return `${ctx.label}: ${scaled} (${pct.toFixed(2)}%)`;
            },
          },
        },
        // === BURASI YENİ: veri etiketleri ===
        datalabels: {
          display: true,
          anchor: type === "bar" ? "end" : "center",
          align:  type === "bar" ? "end" : "center",
          formatter: (v) => `${v.toFixed(2)}%`,
          color: "#111827",
          font: {
            size: 11,
            weight: "600",
          },
          clamp: true,
        },
      },
      scales:
        type === "bar"
          ? {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { callback: (v) => v + "%" },
              },
            }
          : {},
    },
  });
}

  function updateSummary(labels, counts, pctData, total, scale) {
    const el = document.getElementById("vizSummary");
    if (!el) return;

    if (!total || !counts.length) {
      el.innerHTML = "";
      return;
    }

    const scaledTotal = total * scale;
    const rows = [];
    for (let i = 0; i < labels.length; i++) {
      const label = labels[i];
      const cnt   = counts[i] || 0;
      const scaled = cnt * scale;
      const pct   = pctData[i] || 0;
      rows.push({ label, scaled, pct });
    }

    let html = `<div>Toplam: <b>${scaledTotal}</b></div>`;
    html += `<table><thead><tr><th>Değer</th><th>Adet</th><th>%</th></tr></thead><tbody>`;
    rows.forEach((r) => {
      html += `<tr><td>${escapeHtml(r.label)}</td><td>${r.scaled}</td><td>${r.pct.toFixed(2)}%</td></tr>`;
    });
    html += `</tbody></table>`;
    el.innerHTML = html;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) =>
      ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
    );
  }
})();
</script>
</body>
</html>
