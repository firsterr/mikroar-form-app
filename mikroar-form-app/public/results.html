<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sonuçlar</title>
  <link rel="stylesheet" href="/form.css">
  <style>main{max-width:1100px;margin:40px auto;padding:0 16px} table{width:100%;border-collapse:collapse} th,td{padding:8px;border:1px solid #ddd} .bar{display:flex;gap:12px;align-items:center;margin-bottom:12px}</style>
</head>
<body>
  <main>
    <div class="bar">
      <h1 id="t" style="margin-right:auto">Sonuçlar</h1>
      <a id="csv" class="btn" href="#">CSV indir</a>
    </div>
    <div id="wrap">Yükleniyor…</div>
  </main>
<script>
(async () => {
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');
  if (!slug) { document.getElementById('wrap').textContent = 'slug yok'; return; }

  document.getElementById('t').textContent = `Sonuçlar – ${slug}`;
  document.getElementById('csv').href = `/.netlify/functions/responses?slug=${encodeURIComponent(slug)}&format=csv`;

  const r = await fetch(`/.netlify/functions/responses?slug=${encodeURIComponent(slug)}`);
  const j = await r.json();
  if (!j.ok) { document.getElementById('wrap').textContent = j.error || 'Hata'; return; }

  const rows = j.rows;
  // kolonları answers anahtarlarına göre oluştur
  const keys = new Set();
  rows.forEach(x => Object.keys(x.answers||{}).forEach(k => keys.add(k)));
  const cols = ['created_at','ip', ...keys];

  const th = cols.map(c => `<th>${c}</th>`).join('');
  const tr = rows.map(r => {
    const base = [r.created_at, r.ip];
    const ans  = [...keys].map(k => (r.answers||{})[k] ?? '');
    return `<tr>${[...base, ...ans].map(x=>`<td>${(x??'')}</td>`).join('')}</tr>`;
  }).join('');

  document.getElementById('wrap').innerHTML = `<table><thead><tr>${th}</tr></thead><tbody>${tr}</tbody></table>`;
})();
</script>
</body>
</html>
